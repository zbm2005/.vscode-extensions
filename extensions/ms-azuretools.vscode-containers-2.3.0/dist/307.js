"use strict";exports.id=307,exports.ids=[307],exports.modules={87307:(e,t,o)=>{o.d(t,{mz:()=>LroEngine,vu:()=>Poller,Vj:()=>createHttpPoller});const r=(0,o(5136).KV)("core-lro"),s=2e3,n=["succeeded","canceled","failed"];function deserializeState(e){try{return JSON.parse(e).state}catch(t){throw new Error(`Unable to deserialize input state: ${e}`)}}function setStateError(e){const{state:t,stateProxy:o,isOperationError:r}=e;return e=>{throw r(e)&&(o.setError(t,e),o.setFailed(t)),e}}function appendReadableErrorMessage(e,t){let o=e;return"."!==o.slice(-1)&&(o+="."),o+" "+t}function processOperationStatus(e){const{state:t,stateProxy:o,status:s,isDone:n,processResult:a,getError:i,response:c,setErrorAsResult:l}=e;switch(s){case"succeeded":o.setSucceeded(t);break;case"failed":{const e=null==i?void 0:i(c);let s="";if(e){const{code:t,message:o}=function simplifyError(e){let t=e.message,o=e.code,r=e;for(;r.innererror;)r=r.innererror,o=r.code,t=appendReadableErrorMessage(t,r.message);return{code:o,message:t}}(e);s=`. ${t}. ${o}`}const n=`The long-running operation has failed${s}`;o.setError(t,new Error(n)),o.setFailed(t),r.warning(n);break}case"canceled":o.setCanceled(t)}((null==n?void 0:n(c,t))||void 0===n&&["succeeded","canceled"].concat(l?[]:["failed"]).includes(s))&&o.setResult(t,function buildResult(e){const{processResult:t,response:o,state:r}=e;return t?t(o,r):o}({response:c,state:t,processResult:a}))}async function initOperation(e){const{init:t,stateProxy:o,processResult:s,getOperationStatus:n,withOperationLocation:a,setErrorAsResult:i}=e,{operationLocation:c,resourceLocation:l,metadata:u,response:p}=await t();c&&(null==a||a(c,!1));const d={metadata:u,operationLocation:c,resourceLocation:l};r.verbose("LRO: Operation description:",d);const g=o.initState(d);return processOperationStatus({state:g,status:n({response:p,state:g,operationLocation:c}),stateProxy:o,response:p,setErrorAsResult:i,processResult:s}),g}async function pollOperation(e){const{poll:t,state:o,stateProxy:s,options:a,getOperationStatus:i,getResourceLocation:c,getOperationLocation:l,isOperationError:u,withOperationLocation:p,getPollingInterval:d,processResult:g,getError:h,updateState:f,setDelay:R,isDone:O,setErrorAsResult:L}=e,{operationLocation:v}=o.config;if(void 0!==v){const{response:e,status:P}=await async function pollOperationHelper(e){const{poll:t,state:o,stateProxy:s,operationLocation:a,getOperationStatus:i,getResourceLocation:c,isOperationError:l,options:u}=e,p=await t(a,u).catch(setStateError({state:o,stateProxy:s,isOperationError:l})),d=i(p,o);if(r.verbose(`LRO: Status:\n\tPolling from: ${o.config.operationLocation}\n\tOperation status: ${d}\n\tPolling status: ${n.includes(d)?"Stopped":"Running"}`),"succeeded"===d){const e=c(p,o);if(void 0!==e)return{response:await t(e).catch(setStateError({state:o,stateProxy:s,isOperationError:l})),status:d}}return{response:p,status:d}}({poll:t,getOperationStatus:i,state:o,stateProxy:s,operationLocation:v,getResourceLocation:c,isOperationError:u,options:a});if(processOperationStatus({status:P,response:e,state:o,stateProxy:s,isDone:O,processResult:g,getError:h,setErrorAsResult:L}),!n.includes(P)){const t=null==d?void 0:d(e);t&&R(t);const r=null==l?void 0:l(e,o);if(void 0!==r){const e=v!==r;o.config.operationLocation=r,null==p||p(r,e)}else null==p||p(v,!1)}null==f||f(o,e)}}function getOperationLocationPollingUrl(e){const{azureAsyncOperation:t,operationLocation:o}=e;return null!=o?o:t}function getLocationHeader(e){return e.headers.location}function getOperationLocationHeader(e){return e.headers["operation-location"]}function getAzureAsyncOperationHeader(e){return e.headers["azure-asyncoperation"]}function findResourceLocation(e){var t;const{location:o,requestMethod:r,requestPath:s,resourceLocationConfig:n}=e;switch(r){case"PUT":return s;case"DELETE":return;case"PATCH":return null!==(t=getDefault())&&void 0!==t?t:s;default:return getDefault()}function getDefault(){switch(n){case"azure-async-operation":return;case"original-uri":return s;default:return o}}}function inferLroMode(e){const{rawResponse:t,requestMethod:o,requestPath:r,resourceLocationConfig:s}=e,n=getOperationLocationPollingUrl({operationLocation:getOperationLocationHeader(t),azureAsyncOperation:getAzureAsyncOperationHeader(t)}),a=getLocationHeader(t),i=null==o?void 0:o.toLocaleUpperCase();return void 0!==n?{mode:"OperationLocation",operationLocation:n,resourceLocation:findResourceLocation({requestMethod:i,location:a,requestPath:r,resourceLocationConfig:s})}:void 0!==a?{mode:"ResourceLocation",operationLocation:a}:"PUT"===i&&r?{mode:"Body",operationLocation:r}:void 0}function transformStatus(e){const{status:t,statusCode:o}=e;if("string"!=typeof t&&void 0!==t)throw new Error(`Polling was unsuccessful. Expected status to have a string value or no value but it has instead: ${t}. This doesn't necessarily indicate the operation has failed. Check your Azure subscription or resource status for more information.`);switch(null==t?void 0:t.toLocaleLowerCase()){case void 0:return toOperationStatus(o);case"succeeded":return"succeeded";case"failed":return"failed";case"running":case"accepted":case"started":case"canceling":case"cancelling":return"running";case"canceled":case"cancelled":return"canceled";default:return r.verbose(`LRO: unrecognized operation status: ${t}`),t}}function toOperationStatus(e){return 202===e?"running":e<300?"succeeded":"failed"}function parseRetryAfter({rawResponse:e}){const t=e.headers["retry-after"];if(void 0!==t){const e=parseInt(t);return isNaN(e)?function calculatePollingIntervalFromDate(e){const t=Math.floor((new Date).getTime()),o=e.getTime();if(t<o)return o-t;return}(new Date(t)):1e3*e}}function getErrorFromResponse(e){const t=accessBodyProperty(e,"error");if(t){if(t.code&&t.message)return t;r.warning("The long-running operation failed but the error property in the response's body doesn't contain code or message")}else r.warning("The long-running operation failed but there is no error property in the response's body")}function getStatusFromInitialResponse(e){const{response:t,state:o,operationLocation:r}=e;const s=function helper(){var e;switch(null===(e=o.config.metadata)||void 0===e?void 0:e.mode){case void 0:return toOperationStatus(t.rawResponse.statusCode);case"Body":return getOperationStatus(t,o);default:return"running"}}();return"running"===s&&void 0===r?"succeeded":s}function getOperationLocation({rawResponse:e},t){var o;switch(null===(o=t.config.metadata)||void 0===o?void 0:o.mode){case"OperationLocation":return getOperationLocationPollingUrl({operationLocation:getOperationLocationHeader(e),azureAsyncOperation:getAzureAsyncOperationHeader(e)});case"ResourceLocation":return getLocationHeader(e);default:return}}function getOperationStatus({rawResponse:e},t){var o;const r=null===(o=t.config.metadata)||void 0===o?void 0:o.mode;switch(r){case"OperationLocation":return function getStatus(e){var t;const{status:o}=null!==(t=e.body)&&void 0!==t?t:{};return transformStatus({status:o,statusCode:e.statusCode})}(e);case"ResourceLocation":return toOperationStatus(e.statusCode);case"Body":return function getProvisioningState(e){var t,o;const{properties:r,provisioningState:s}=null!==(t=e.body)&&void 0!==t?t:{};return transformStatus({status:null!==(o=null==r?void 0:r.provisioningState)&&void 0!==o?o:s,statusCode:e.statusCode})}(e);default:throw new Error(`Internal error: Unexpected operation mode: ${r}`)}}function accessBodyProperty({flatResponse:e,rawResponse:t},o){var r,s;return null!==(r=null==e?void 0:e[o])&&void 0!==r?r:null===(s=t.body)||void 0===s?void 0:s[o]}function getResourceLocation(e,t){const o=accessBodyProperty(e,"resourceLocation");return o&&"string"==typeof o&&(t.config.resourceLocation=o),t.config.resourceLocation}function isOperationError(e){return"RestError"===e.name}var a=o(10151);const createStateProxy=()=>({initState:e=>({status:"running",config:e}),setCanceled:e=>e.status="canceled",setError:(e,t)=>e.error=t,setResult:(e,t)=>e.result=t,setRunning:e=>e.status="running",setSucceeded:e=>e.status="succeeded",setFailed:e=>e.status="failed",getError:e=>e.error,getResult:e=>e.result,isCanceled:e=>"canceled"===e.status,isFailed:e=>"failed"===e.status,isRunning:e=>"running"===e.status,isSucceeded:e=>"succeeded"===e.status});function buildCreatePoller(e){const{getOperationLocation:t,getStatusFromInitialResponse:o,getStatusFromPollResponse:r,isOperationError:n,getResourceLocation:i,getPollingInterval:c,getError:l,resolveOnUnsuccessful:u}=e;return async({init:e,poll:p},d)=>{const{processResult:g,updateState:h,withOperationLocation:f,intervalInMs:R=s,restoreFrom:O}=d||{},L=createStateProxy(),v=f?(()=>{let e=!1;return(t,o)=>{o?f(t):e||f(t),e=!0}})():void 0,P=O?deserializeState(O):await initOperation({init:e,stateProxy:L,processResult:g,getOperationStatus:o,withOperationLocation:v,setErrorAsResult:!u});let S;const y=new AbortController,w=new Map,E="Operation was canceled";let m=R;const b={getOperationState:()=>P,getResult:()=>P.result,isDone:()=>["succeeded","failed","canceled"].includes(P.status),isStopped:()=>void 0===S,stopPolling:()=>{y.abort()},toString:()=>JSON.stringify({state:P}),onProgress:e=>{const t=Symbol();return w.set(t,e),()=>w.delete(t)},pollUntilDone:e=>null!=S?S:S=(async()=>{const{abortSignal:t}=e||{};function abortListener(){y.abort()}const o=y.signal;(null==t?void 0:t.aborted)?y.abort():o.aborted||null==t||t.addEventListener("abort",abortListener,{once:!0});try{if(!b.isDone())for(await b.poll({abortSignal:o});!b.isDone();)await(0,a.cb)(m,{abortSignal:o}),await b.poll({abortSignal:o})}finally{null==t||t.removeEventListener("abort",abortListener)}if(u)return b.getResult();switch(P.status){case"succeeded":return b.getResult();case"canceled":throw new Error(E);case"failed":throw P.error;case"notStarted":case"running":throw new Error("Polling completed without succeeding or failing")}})().finally((()=>{S=void 0})),async poll(e){if(u){if(b.isDone())return}else switch(P.status){case"succeeded":return;case"canceled":throw new Error(E);case"failed":throw P.error}if(await pollOperation({poll:p,state:P,stateProxy:L,getOperationLocation:t,isOperationError:n,withOperationLocation:v,getPollingInterval:c,getOperationStatus:r,getResourceLocation:i,processResult:g,getError:l,updateState:h,options:e,setDelay:e=>{m=e},setErrorAsResult:!u}),await(async()=>w.forEach((e=>e(P))))(),!u)switch(P.status){case"canceled":throw new Error(E);case"failed":throw P.error}}};return b}}async function createHttpPoller(e,t){const{resourceLocationConfig:o,intervalInMs:r,processResult:s,restoreFrom:n,updateState:a,withOperationLocation:i,resolveOnUnsuccessful:c=!1}=t||{};return buildCreatePoller({getStatusFromInitialResponse,getStatusFromPollResponse:getOperationStatus,isOperationError,getOperationLocation,getResourceLocation,getPollingInterval:parseRetryAfter,getError:getErrorFromResponse,resolveOnUnsuccessful:c})({init:async()=>{const t=await e.sendInitialRequest(),r=inferLroMode({rawResponse:t.rawResponse,requestPath:e.requestPath,requestMethod:e.requestMethod,resourceLocationConfig:o});return Object.assign({response:t,operationLocation:null==r?void 0:r.operationLocation,resourceLocation:null==r?void 0:r.resourceLocation},(null==r?void 0:r.mode)?{metadata:{mode:r.mode}}:{})},poll:e.sendPollRequest},{intervalInMs:r,withOperationLocation:i,restoreFrom:n,updateState:a,processResult:s?({flatResponse:e},t)=>s(e,t):({flatResponse:e})=>e})}class GenericPollOperation{constructor(e,t,o,r,s,n,a){this.state=e,this.lro=t,this.setErrorAsResult=o,this.lroResourceLocationConfig=r,this.processResult=s,this.updateState=n,this.isDone=a}setPollerConfig(e){this.pollerConfig=e}async update(e){var t;const o={initState:e=>({config:e,isStarted:!0}),setCanceled:e=>e.isCancelled=!0,setError:(e,t)=>e.error=t,setResult:(e,t)=>e.result=t,setRunning:e=>e.isStarted=!0,setSucceeded:e=>e.isCompleted=!0,setFailed:()=>{},getError:e=>e.error,getResult:e=>e.result,isCanceled:e=>!!e.isCancelled,isFailed:e=>!!e.error,isRunning:e=>!!e.isStarted,isSucceeded:e=>Boolean(e.isCompleted&&!e.isCancelled&&!e.error)};this.state.isStarted||(this.state=Object.assign(Object.assign({},this.state),await async function initHttpOperation(e){const{stateProxy:t,resourceLocationConfig:o,processResult:r,lro:s,setErrorAsResult:n}=e;return initOperation({init:async()=>{const e=await s.sendInitialRequest(),t=inferLroMode({rawResponse:e.rawResponse,requestPath:s.requestPath,requestMethod:s.requestMethod,resourceLocationConfig:o});return Object.assign({response:e,operationLocation:null==t?void 0:t.operationLocation,resourceLocation:null==t?void 0:t.resourceLocation},(null==t?void 0:t.mode)?{metadata:{mode:t.mode}}:{})},stateProxy:t,processResult:r?({flatResponse:e},t)=>r(e,t):({flatResponse:e})=>e,getOperationStatus:getStatusFromInitialResponse,setErrorAsResult:n})}({lro:this.lro,stateProxy:o,resourceLocationConfig:this.lroResourceLocationConfig,processResult:this.processResult,setErrorAsResult:this.setErrorAsResult})));const r=this.updateState,s=this.isDone;return this.state.isCompleted||void 0!==this.state.error||await async function pollHttpOperation(e){const{lro:t,stateProxy:o,options:r,processResult:s,updateState:n,setDelay:a,state:i,setErrorAsResult:c}=e;return pollOperation({state:i,stateProxy:o,setDelay:a,processResult:s?({flatResponse:e},t)=>s(e,t):({flatResponse:e})=>e,getError:getErrorFromResponse,updateState:n,getPollingInterval:parseRetryAfter,getOperationLocation,getOperationStatus,isOperationError,getResourceLocation,options:r,poll:async(e,o)=>t.sendPollRequest(e,o),setErrorAsResult:c})}({lro:this.lro,state:this.state,stateProxy:o,processResult:this.processResult,updateState:r?(e,{rawResponse:t})=>r(e,t):void 0,isDone:s?({flatResponse:e},t)=>s(e,t):void 0,options:e,setDelay:e=>{this.pollerConfig.intervalInMs=e},setErrorAsResult:this.setErrorAsResult}),null===(t=null==e?void 0:e.fireProgress)||void 0===t||t.call(e,this.state),this}async cancel(){return r.error("`cancelOperation` is deprecated because it wasn't implemented"),this}toString(){return JSON.stringify({state:this.state})}}class PollerStoppedError extends Error{constructor(e){super(e),this.name="PollerStoppedError",Object.setPrototypeOf(this,PollerStoppedError.prototype)}}class PollerCancelledError extends Error{constructor(e){super(e),this.name="PollerCancelledError",Object.setPrototypeOf(this,PollerCancelledError.prototype)}}class Poller{constructor(e){this.resolveOnUnsuccessful=!1,this.stopped=!0,this.pollProgressCallbacks=[],this.operation=e,this.promise=new Promise(((e,t)=>{this.resolve=e,this.reject=t})),this.promise.catch((()=>{}))}async startPolling(e={}){for(this.stopped&&(this.stopped=!1);!this.isStopped()&&!this.isDone();)await this.poll(e),await this.delay()}async pollOnce(e={}){this.isDone()||(this.operation=await this.operation.update({abortSignal:e.abortSignal,fireProgress:this.fireProgress.bind(this)})),this.processUpdatedState()}fireProgress(e){for(const t of this.pollProgressCallbacks)t(e)}async cancelOnce(e={}){this.operation=await this.operation.cancel(e)}poll(e={}){if(!this.pollOncePromise){this.pollOncePromise=this.pollOnce(e);const clearPollOncePromise=()=>{this.pollOncePromise=void 0};this.pollOncePromise.then(clearPollOncePromise,clearPollOncePromise).catch(this.reject)}return this.pollOncePromise}processUpdatedState(){if(this.operation.state.error&&(this.stopped=!0,!this.resolveOnUnsuccessful))throw this.reject(this.operation.state.error),this.operation.state.error;if(this.operation.state.isCancelled&&(this.stopped=!0,!this.resolveOnUnsuccessful)){const e=new PollerCancelledError("Operation was canceled");throw this.reject(e),e}this.isDone()&&this.resolve&&this.resolve(this.getResult())}async pollUntilDone(e={}){return this.stopped&&this.startPolling(e).catch(this.reject),this.processUpdatedState(),this.promise}onProgress(e){return this.pollProgressCallbacks.push(e),()=>{this.pollProgressCallbacks=this.pollProgressCallbacks.filter((t=>t!==e))}}isDone(){const e=this.operation.state;return Boolean(e.isCompleted||e.isCancelled||e.error)}stopPolling(){this.stopped||(this.stopped=!0,this.reject&&this.reject(new PollerStoppedError("This poller is already stopped")))}isStopped(){return this.stopped}cancelOperation(e={}){if(this.cancelPromise){if(e.abortSignal)throw new Error("A cancel request is currently pending")}else this.cancelPromise=this.cancelOnce(e);return this.cancelPromise}getOperationState(){return this.operation.state}getResult(){return this.operation.state.result}toString(){return this.operation.toString()}}class LroEngine extends Poller{constructor(e,t){const{intervalInMs:o=s,resumeFrom:r,resolveOnUnsuccessful:n=!1,isDone:a,lroResourceLocationConfig:i,processResult:c,updateState:l}=t||{},u=r?deserializeState(r):{},p=new GenericPollOperation(u,e,!n,i,c,l,a);super(p),this.resolveOnUnsuccessful=n,this.config={intervalInMs:o},p.setPollerConfig(this.config)}delay(){return new Promise((e=>setTimeout((()=>e()),this.config.intervalInMs)))}}}};