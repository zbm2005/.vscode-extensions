"use strict";exports.id=348,exports.ids=[348],exports.modules={99348:(e,t,r)=>{r.r(t),r.d(t,{AzureAccountTreeItemBase:()=>AzureAccountTreeItemBase,CommonRoleDefinitions:()=>h,CorrelationIdPolicy:()=>CorrelationIdPolicy,IdentityProvider:()=>m,LocationListStep:()=>LocationListStep,ResourceGroupCreateStep:()=>ResourceGroupCreateStep,ResourceGroupListStep:()=>ResourceGroupListStep,ResourceGroupNameStep:()=>ResourceGroupNameStep,ResourceGroupVerifyStep:()=>ResourceGroupVerifyStep,RoleAssignmentExecuteStep:()=>RoleAssignmentExecuteStep,RoleDefinitionsItem:()=>RoleDefinitionsItem,RoleDefinitionsTreeItem:()=>RoleDefinitionsTreeItem,StorageAccountCreateStep:()=>StorageAccountCreateStep,StorageAccountKind:()=>k,StorageAccountListStep:()=>StorageAccountListStep,StorageAccountNameStep:()=>StorageAccountNameStep,StorageAccountPerformance:()=>E,StorageAccountReplication:()=>_,SubscriptionTreeItemBase:()=>SubscriptionTreeItemBase,UserAssignedIdentityCreateStep:()=>UserAssignedIdentityCreateStep,UserAssignedIdentityListStep:()=>UserAssignedIdentityListStep,UserAssignedIdentityResourceType:()=>g,VerifyProvidersStep:()=>VerifyProvidersStep,addBasicAuthenticationCredentialsToClient:()=>addBasicAuthenticationCredentialsToClient,createAuthorizationManagementClient:()=>createAuthorizationManagementClient,createAzureClient:()=>createAzureClient,createAzureSubscriptionClient:()=>createAzureSubscriptionClient,createGenericClient:()=>createGenericClient,createManagedServiceIdentityClient:()=>createManagedServiceIdentityClient,createPortalUri:()=>createPortalUri,createResourcesClient:()=>createResourcesClient,createRoleDefinitionsItems:()=>createRoleDefinitionsItems,createRoleId:()=>createRoleId,createStorageClient:()=>createStorageClient,createSubscriptionsClient:()=>createSubscriptionsClient,getResourceGroupFromId:()=>getResourceGroupFromId,openInPortal:()=>openInPortal,parseAzureResourceGroupId:()=>parseAzureResourceGroupId,parseAzureResourceId:()=>parseAzureResourceId,parseClientContext:()=>parseClientContext,registerAzureUtilsExtensionVariables:()=>registerAzureUtilsExtensionVariables,resourceGroupNamingRules:()=>G,sendRequestWithTimeout:()=>sendRequestWithTimeout,setupAzureLogger:()=>setupAzureLogger,storageAccountNamingRules:()=>D,uiUtils:()=>R});var n=r(99834),o=r(1965),i=r(30546),a=r(76982),s=r(65692),c=r(91398);function removeBom(e){return 65279===e.charCodeAt(0)?e.slice(1):e}function parseClientContext(e){if(Array.isArray(e)){const t=e[1]instanceof i.AzExtTreeItem?e[1].subscription:e[1];return Object.assign(e[0],{credentials:t.credentials,createCredentialsForScopes:t.createCredentialsForScopes,subscriptionDisplayName:t.subscriptionDisplayName,subscriptionId:t.subscriptionId,subscriptionPath:t.subscriptionPath,tenantId:t.tenantId,userId:t.userId,environment:t.environment,isCustomCloud:t.isCustomCloud})}return e}function getChallengeHandlerFromCredential(e){return async t=>{const r=await e(t);return(await r.getToken(t)).token}}function createAzureClient(e,t){const r=parseClientContext(e),n=new t(r.credentials,r.subscriptionId,{endpoint:r.environment.resourceManagerEndpointUrl});return r.telemetry.properties.subscriptionId=r.subscriptionId,addAzExtPipeline(r,n.pipeline,r.environment.resourceManagerEndpointUrl,void 0,void 0,new AzExtBearerChallengePolicy(r,getChallengeHandlerFromCredential(r.createCredentialsForScopes),r.environment.resourceManagerEndpointUrl)),n}function createAzureSubscriptionClient(e,t){const r=parseClientContext(e),n=new t(r.credentials,{endpoint:r.environment.resourceManagerEndpointUrl});return r.telemetry.properties.subscriptionId=r.subscriptionId,addAzExtPipeline(r,n.pipeline,r.environment.resourceManagerEndpointUrl,void 0,void 0,new AzExtBearerChallengePolicy(r,getChallengeHandlerFromCredential(r.createCredentialsForScopes),r.environment.resourceManagerEndpointUrl)),n}async function sendRequestWithTimeout(e,t,r,n){const i=(0,o.createPipelineRequest)({...t,timeout:r});t.rejectUnauthorized&&(i.agent=new s.Agent({rejectUnauthorized:t.rejectUnauthorized}));const a=await createGenericClient(e,n,{noRetryPolicy:!0,addStatusCodePolicy:!0});return await a.sendRequest(i)}async function createGenericClient(e,t,r){let o,i;t&&"credentials"in t?(o=t.credentials,i=t.environment.resourceManagerEndpointUrl):o=t,"subscriptionId"in e&&(e.telemetry.properties.subscriptionId=e.subscriptionId);const a=r?.noRetryPolicy?{maxRetries:0}:void 0;i=r?.endpoint??i;const s=new n.ServiceClient({credential:o,endpoint:i});return addAzExtPipeline(e,s.pipeline,i,{retryOptions:a},r?.addStatusCodePolicy),s}function addAzExtPipeline(e,t,r,n,a,s){return n?.retryOptions&&(t.removePolicy((0,o.ur)()),t.addPolicy((0,o.ur)(n?.retryOptions))),t.removePolicy((0,o.z7)()),t.addPolicy((0,o.z7)({userAgentPrefix:(0,i.appendExtensionUserAgent)()})),t.addPolicy(new AcceptLanguagePolicy,{phase:"Serialize"}),c.env.isTelemetryEnabled&&t.addPolicy(new CorrelationIdPolicy(e),{phase:"Serialize"}),r&&t.addPolicy(new AddEndpointPolicy(r),{phase:"Serialize"}),t.addPolicy(new MissingContentTypePolicy,{phase:"Deserialize"}),t.addPolicy(new RemoveBOMPolicy,{phase:"Deserialize",beforePolicies:[MissingContentTypePolicy.Name]}),a&&t.addPolicy(new StatusCodePolicy),t.addPolicy(new AllowInsecureConnectionPolicy),s&&t.addPolicy(s,{phase:"Sign"}),t}function addBasicAuthenticationCredentialsToClient(e,t,r){e.pipeline.addPolicy(new BasicAuthenticationCredentialsPolicy(t,r),{phase:"Serialize"})}class CorrelationIdPolicy{context;name="CorrelationIdPolicy";constructor(e){this.context=e}async sendRequest(e,t){const r="x-ms-correlation-request-id",n=this.context.telemetry.properties[r]||=(0,a.randomUUID)();return e.headers.set(r,n),await t(e)}}class RemoveBOMPolicy{name="RemoveBOMPolicy";async sendRequest(e,t){const r=await t(e),n=r.headers.get(u);return n&&/json/i.test(n)&&r.bodyAsText&&(r.bodyAsText=removeBom(r.bodyAsText)),r}}const u="Content-Type";class MissingContentTypePolicy{static Name="MissingContentTypePolicy";name=MissingContentTypePolicy.Name;async sendRequest(e,t){const r=await t(e);if(!r.headers.get(u)&&r.bodyAsText)try{!function parseJson(e){return JSON.parse(removeBom(e))}(r.bodyAsText),r.headers.set(u,"application/json")}catch{r.headers.set(u,"application/octet-stream")}return r}}class AcceptLanguagePolicy{name="AcceptLanguagePolicy";async sendRequest(e,t){return e.headers.set("Accept-Language",c.env.language),await t(e)}}class AddEndpointPolicy{endpoint;name="AddEndpointPolicy";constructor(e){this.endpoint=e}async sendRequest(e,t){return this.endpoint&&e.url&&!e.url.startsWith("http")&&(e.url.startsWith("/")||(e.url=`/${e.url}`),e.url=this.endpoint+e.url),await t(e)}}class StatusCodePolicy{name="StatusCodePolicy";async sendRequest(e,t){const r=await t(e);if(r.status<200||r.status>=300){const t=r.bodyAsText?(0,i.parseError)(r.parsedBody||r.bodyAsText).message:c.l10n.t("Unexpected status code: {0}",r.status);throw new o.pj(t,{code:String(r.status)||r.bodyAsText||"",statusCode:r.status,request:e,response:r})}return r}}class BasicAuthenticationCredentialsPolicy{userName;password;static Name="BasicAuthenticationCredentialsPolicy";name=BasicAuthenticationCredentialsPolicy.Name;constructor(e,t){this.userName=e,this.password=t}async sendRequest(e,t){const r=`${this.userName}:${this.password}`,n=`Basic ${Buffer.from(r).toString("base64")}`;return e.headers||(e.headers=(0,o.createHttpHeaders)()),e.headers.set("authorization",n),await t(e)}}class AllowInsecureConnectionPolicy{static Name="AllowInsecureConnectionPolicy";name=AllowInsecureConnectionPolicy.Name;async sendRequest(e,t){return e.url.startsWith("http://")&&(e.allowInsecureConnection=!0),await t(e)}}function getDefaultScopeFromEndpoint(e){let t=e??"https://management.azure.com/";return t=t.replace(/\/+$/,""),`${t}/.default`}class AzExtBearerChallengePolicy{context;getTokenForChallenge;endpoint;name="AzExtBearerChallengePolicy";challengeRetryHeader="x-azext-challenge-retry";constructor(e,t,r){this.context=e,this.getTokenForChallenge=t,this.endpoint=r}async sendRequest(e,t){const r=await t(e);if(401===r.status&&!e.headers.get(this.challengeRetryHeader)){const n=r.headers.get("WWW-Authenticate")||r.headers.get("www-authenticate");if(n){this.context.telemetry.properties.challenge="true";const r=[getDefaultScopeFromEndpoint(this.endpoint)];e.headers.set(this.challengeRetryHeader,"1");const o=await this.getTokenForChallenge({wwwAuthenticate:n,fallbackScopes:r});if(o)return this.context.telemetry.properties.challengeSuccess="true",e.headers.set("Authorization",`Bearer ${o}`),await t(e);this.context.telemetry.properties.challengeSuccess="false"}}return r}}async function createStorageClient(e){return parseClientContext(e).isCustomCloud?createAzureClient(e,(await Promise.all([r.e(307),r.e(664)]).then(r.bind(r,82664))).StorageManagementClient):createAzureClient(e,(await Promise.all([r.e(307),r.e(756)]).then(r.bind(r,63756))).StorageManagementClient)}async function createResourcesClient(e){return parseClientContext(e).isCustomCloud?createAzureClient(e,(await Promise.all([r.e(307),r.e(933)]).then(r.bind(r,93933))).ResourceManagementClient):createAzureClient(e,(await Promise.all([r.e(307),r.e(365)]).then(r.bind(r,26365))).ResourceManagementClient)}async function createManagedServiceIdentityClient(e){return createAzureClient(e,(await r.e(333).then(r.bind(r,73333))).ManagedServiceIdentityClient)}async function createAuthorizationManagementClient(e){return parseClientContext(e).isCustomCloud?createAzureClient(e,(await r.e(219).then(r.bind(r,67219))).AuthorizationManagementClient):createAzureClient(e,(await r.e(269).then(r.bind(r,45269))).AuthorizationManagementClient)}async function createSubscriptionsClient(e){return createAzureSubscriptionClient(e,(await r.e(37).then(r.bind(r,33037))).SubscriptionClient)}const l="Microsoft.Resources",p="Microsoft.Storage",d="Microsoft.Storage/storageAccounts",m="Microsoft.ManagedIdentity",g="userAssignedIdentities",h={storageBlobDataContributor:{name:"ba92f5b4-2d11-453d-a403-e96b0029c9fe",type:"Microsoft.Authorization/roleDefinitions",roleName:"Storage Blob Data Contributor",description:"Allows for read, write and delete access to Azure Storage blob containers and data",roleType:"BuiltInRole"},storageBlobDataOwner:{name:"b7e6dc6d-f1e8-4753-8033-0f276bb0955b",type:"Microsoft.Authorization/roleDefinitions",roleName:"Storage Blob Data Owner",description:"Allows for full access to Azure Storage blob containers and data, including assigning POSIX access control.",roleType:"BuiltInRole"},storageQueueDataContributor:{name:"974c5e8b-45b9-4653-ba55-5f855dd0fb88",type:"Microsoft.Authorization/roleDefinitions",roleName:"Storage Queue Data Contributor",description:"Read, write, and delete Azure Storage queues and queue messages.",roleType:"BuiltInRole"},azureServiceBusDataReceiver:{name:"4f6d3b9b-027b-4f4c-9142-0e5a2a2247e0",type:"Microsoft.Authorization/roleDefinitions",roleName:"Azure Service Bus Data Receiver",description:"Allows for receive access to Azure Service Bus resources.",roleType:"BuiltInRole"},azureServiceBusDataOwner:{name:"090c5cfd-751d-490a-894a-3ce6f1109419",type:"Microsoft.Authorization/roleDefinitions",roleName:"Azure Service Bus Data Owner",description:"Allows for full access to Azure Service Bus resources.",roleType:"BuiltInRole"},azureEventHubsDataReceiver:{name:"a638d3c7-ab3a-418d-83e6-5f17a39d4fde",type:"Microsoft.Authorization/roleDefinitions",roleName:"Azure Event Hubs Data Receiver",description:"Allows receive access to Azure Event Hubs resources.",roleType:"BuiltInRole"},azureEventHubsDataOwner:{name:"f526a384-b230-433a-b45c-95f59c4a2dec",type:"Microsoft.Authorization/roleDefinitions",roleName:"Azure Event Hubs Data Owner",description:"Allows for full access to Azure Event Hubs resources.",roleType:"BuiltInRole"},cosmosDBAccountReader:{name:"fbdf93bf-df7d-467e-a4d2-9458aa1360c8",type:"Microsoft.Authorization/roleDefinitions",roleName:"Cosmos DB Account Reader",description:"Can read Azure Cosmos DB account data.",roleType:"BuiltInRole"},documentDBAccountContributor:{name:"5bd9cd88-fe45-4216-938b-f97437e15450",type:"Microsoft.Authorization/roleDefinitions",roleName:"DocumentDB Account Contributor",description:"Can manage Azure Cosmos DB accounts.",roleType:"BuiltInRole"},durableTaskDataContributor:{name:"0ad04412-c4d5-4796-b79c-f76d14c8d402",type:"Microsoft.Authorization/roleDefinitions",roleName:"Durable Task Data Contributor",description:"Durable Task role for all data access operations.",roleType:"BuiltInRole"}};function createRoleId(e,t){return`/subscriptions/${e}/providers/Microsoft.Authorization/roleDefinitions/${t.name}`}let y=new class UninitializedExtensionVariables{_error=new Error(c.l10n.t('"registerAzureUtilsExtensionVariables" must be called before using the vscode-azext-azureutils package.'));get context(){throw this._error}get outputChannel(){throw this._error}get ui(){throw this._error}get prefix(){throw this._error}};function registerAzureUtilsExtensionVariables(e){y!==e&&(y=e,(0,i.registerUIExtensionVariables)(e))}async function openInPortal(e,t,r){e=(0,i.isAzExtTreeItem)(e)?e.subscription:e;const n=r&&r.queryPrefix?`?${r.queryPrefix}`:"",o=`${e.environment.portalUrl}/${n}#@${e.tenantId}/resource${t}`;await(0,i.openUrl)(o)}var w=r(99589),f=r(16928);function getIconPath(e){return c.Uri.file(f.join(getResourcesPath(),`${e}.svg`))}function getAzureIconPath(e){return c.Uri.file(f.join(getResourcesPath(),"azureIcons",`${e}.svg`))}function getResourcesPath(){return y.ignoreBundle?f.join(__dirname,"..","..","..","resources"):f.join(__dirname,"node_modules","@microsoft","vscode-azext-azureutils","resources")}class SubscriptionTreeItemBase extends i.AzExtParentTreeItem{static contextValue="azureextensionui.azureSubscription";contextValue=SubscriptionTreeItemBase.contextValue;label;constructor(e,t){super(e),this._subscription=t,this.label=t.subscriptionDisplayName,this.id=t.subscriptionPath,this.iconPath=getIconPath("azureSubscription")}}const A=c.l10n.t("Sign in to Azure..."),S=c.l10n.t("Create an Azure Account..."),I=c.l10n.t("Create an Azure for Students Account..."),b=c.l10n.t("Select Subscriptions..."),C="azure-account.login",L="azure-account.createAccount",N="azure-account.selectSubscriptions",P="ms-vscode.azure-account",v="extension.open",x="0.9.0";class AzureAccountTreeItemBase extends i.AzExtParentTreeItem{static contextValue="azureextensionui.azureAccount";contextValue=AzureAccountTreeItemBase.contextValue;label="Azure";childTypeLabel=c.l10n.t("subscription");autoSelectInTreeItemPicker=!0;disposables=[];suppressMaskLabel=!0;_azureAccountTask;_subscriptionTreeItems;_testAccount;constructor(e,t){super(e),this._testAccount=t,this._azureAccountTask=this.loadAzureAccount(t)}get iconPath(){return getIconPath("azure")}dispose(){c.Disposable.from(...this.disposables).dispose()}hasMoreChildrenImpl(){return!1}async loadMoreChildrenImpl(e,t){let r=await this._azureAccountTask;if("string"==typeof r&&(this._azureAccountTask=this.loadAzureAccount(this._testAccount),r=await this._azureAccountTask),"string"==typeof r){t.telemetry.properties.accountStatus=r;const e="notInstalled"===r?c.l10n.t("Install Azure Account Extension..."):c.l10n.t('Update Azure Account Extension to at least version "{0}"...',x),n=new c.ThemeIcon("warning"),o=new i.GenericTreeItem(this,{label:e,commandId:v,contextValue:"azureAccount"+r,includeInTreeItemPicker:!0,iconPath:n});return o.commandArgs=[P],[o]}t.telemetry.properties.accountStatus=r.status;const n=this._subscriptionTreeItems?this._subscriptionTreeItems:[];this._subscriptionTreeItems=[];const o="azureCommand";if("Initializing"===r.status||"LoggingIn"===r.status)return[new i.GenericTreeItem(this,{label:"Initializing"===r.status?c.l10n.t("Loading..."):c.l10n.t("Waiting for Azure sign-in..."),commandId:C,contextValue:o,id:C,iconPath:new c.ThemeIcon("loading~spin")})];if("LoggedOut"===r.status){const e=new i.GenericTreeItem(this,{label:I,commandId:"azureResourceGroups.openUrl",contextValue:o,id:"azure-account.createStudentAccount",iconPath:new c.ThemeIcon("mortar-board"),includeInTreeItemPicker:!0});return e.commandArgs=["https://aka.ms/student-account"],[new i.GenericTreeItem(this,{label:A,commandId:C,contextValue:o,id:C,iconPath:new c.ThemeIcon("sign-in"),includeInTreeItemPicker:!0}),new i.GenericTreeItem(this,{label:S,commandId:L,contextValue:o,id:L,iconPath:new c.ThemeIcon("add"),includeInTreeItemPicker:!0}),e]}return await r.waitForFilters(),0===r.filters.length?[new i.GenericTreeItem(this,{label:b,commandId:N,contextValue:o,id:N,includeInTreeItemPicker:!0})]:(this._subscriptionTreeItems=await Promise.all(r.filters.map((async e=>{const t=n.find((t=>t.id===e.subscription.id));if(t)return t;{(0,i.addExtensionValueToMask)(e.subscription.id,e.subscription.subscriptionId,e.subscription.displayName,e.session.userId,e.session.tenantId),(0,i.addExtensionValueToMask)(e.session.credentials2.clientId,e.session.credentials2.domain);const t=(0,i.nonNullProp)(e.subscription,"subscriptionId");return await this.createSubscriptionTreeItem({credentials:e.session.credentials2,createCredentialsForScopes:()=>Promise.resolve(e.session.credentials2),subscriptionDisplayName:(0,i.nonNullProp)(e.subscription,"displayName"),subscriptionId:t,subscriptionPath:(0,i.nonNullProp)(e.subscription,"id"),tenantId:e.session.tenantId,userId:e.session.userId,environment:e.session.environment,isCustomCloud:"AzureCustomCloud"===e.session.environment.name})}}))),this._subscriptionTreeItems)}async getIsLoggedIn(){const e=await this._azureAccountTask;return"string"!=typeof e&&"LoggedIn"===e.status}async getSubscriptionPromptStep(e){const t=await this.ensureSubscriptionTreeItems(e);if(1!==t.length){const t=this;class SubscriptionPromptStep extends i.AzureWizardPromptStep{async prompt(){const r=await t.treeDataProvider.showTreeItemPicker(SubscriptionTreeItemBase.contextValue,e,t);Object.assign(e,r.subscription)}shouldPrompt(){return!e.subscriptionId}}return new SubscriptionPromptStep}Object.assign(e,t[0].subscription)}async pickTreeItemImpl(e){const t=await this._azureAccountTask;if("string"!=typeof t&&("LoggingIn"===t.status||"Initializing"===t.status)){const e=c.l10n.t("Waiting for Azure sign-in...");await c.window.withProgress({location:c.ProgressLocation.Notification,title:e},(async()=>await t.waitForSubscriptions()))}}compareChildrenImpl(e,t){return e instanceof i.GenericTreeItem&&t instanceof i.GenericTreeItem?0:super.compareChildrenImpl(e,t)}async loadAzureAccount(e){if(!e){const t=c.extensions.getExtension(P);if(t){try{if(w.lt(t.packageJSON.version,x))return"needsUpdate"}catch{}t.isActive||await t.activate(),e=t.exports}}return e?((0,i.registerEvent)("azureAccount.onFiltersChanged",e.onFiltersChanged,(async e=>{e.errorHandling.suppressDisplay=!0,e.telemetry.suppressIfSuccessful=!0,await this.refresh(e)})),(0,i.registerEvent)("azureAccount.onStatusChanged",e.onStatusChanged,(async(e,t)=>{e.errorHandling.suppressDisplay=!0,e.telemetry.suppressIfSuccessful=!0,"LoggedIn"!==t&&await this.refresh(e)})),await c.commands.executeCommand("setContext","isAzureAccountInstalled",!0),e):"notInstalled"}async ensureSubscriptionTreeItems(e){const t=await this._azureAccountTask;if("string"==typeof t){let r,n;"notInstalled"===t?(n="requiresAzureAccount",r=c.l10n.t("This functionality requires installing the Azure Account extension.")):(n="requiresUpdateToAzureAccount",r=c.l10n.t('This functionality requires updating the Azure Account extension to at least version "{0}".',x));const o={title:c.l10n.t("View in Marketplace")};throw await e.ui.showWarningMessage(r,{stepName:n},o)===o&&await c.commands.executeCommand(v,P),new i.UserCancelledError(`${n}|viewInMarketplace`)}return this._subscriptionTreeItems||await this.getCachedChildren(e),(0,i.nonNullValue)(this._subscriptionTreeItems,"subscriptionTreeItems")}}var R,z=r(9885);function createPortalUri(e,t,r){const n=r&&r.queryPrefix?`?${r.queryPrefix}`:"",o=`${e.environment.portalUrl}/${n}#@${e.tenantId}/resource${t}`;return c.Uri.parse(o)}function parseAzureResourceId(e){const t=e.match(/\/subscriptions\/(.*)\/resourceGroups\/(.*)\/providers\/(.*)\/(.*)/i);if(null===t||t.length<3)throw new Error(c.l10n.t("Invalid Azure Resource Id"));return{rawId:e,subscriptionId:t[1],resourceGroup:t[2],provider:t[3],resourceName:t[4]}}function parseAzureResourceGroupId(e){const t=e.match(/\/subscriptions\/(.*)\/resourceGroups\/([^\/]*)/i);if(null===t||t.length<3)throw new Error(c.l10n.t("Invalid Azure Resource Group Id."));return{rawId:e,subscriptionId:t[1],resourceGroup:t[2]}}function getResourceGroupFromId(e){return parseAzureResourceId(e).resourceGroup}async function createRoleDefinitionsItems(e,t,r,n){const o=function isAzureSubscription(e){return"authentication"in e}(t)?(0,i.createSubscriptionContext)(t):t,a=await createAuthorizationManagementClient([e,o]),s=(await R.listAllIterator(a.roleAssignments.listForSubscription())).filter((e=>e.principalId===r.principalId)),c=[];return await Promise.all(s.map((async t=>{if(!t.scope||!t.roleDefinitionId)return;const i=await a.roleDefinitions.getById(t.roleDefinitionId),s=c.find((e=>e.id===RoleDefinitionsItem.getId(n,r.id,t.scope)));if(s)s.addRoleDefinition(i);else{const a=await RoleDefinitionsItem.createRoleDefinitionsItem({context:e,subContext:o,roleDefinition:i,parentResourceId:n,scope:t.scope,msiId:r.id,withDescription:!r.id?.includes(o.subscriptionId)});c.push(a)}}))),c}!function(e){e.listAll=async function listAll(e,t){const r=[];let n=await t;for(r.push(...n);n.nextLink;)n=await e.listNext(n.nextLink),r.push(...n);return r},e.listAllIterator=async function listAllIterator(e){const t=[];for await(const r of e)t.push(r);return t}}(R||(R={}));class RoleDefinitionsItem{id;label;iconPath;description;roleDefintions=[];portalUrl;constructor(e){this.label=e.label,this.id=e.id,this.iconPath=e.iconPath,this.roleDefintions.push(e.roleDefinition),this.description=e.description,this.portalUrl=createPortalUri(e.subscription,e.scope)}static getId(e="",t="",r=""){return`${e}/identities/${t.split("/").at(-1)??"{msiId}"}/scopes/${r}`}static async createRoleDefinitionsItem(e){let t,r,n,o,i;const a=e.withDescription?e.subContext.subscriptionDisplayName:void 0;try{t=parseAzureResourceId(e.scope),i=t.subscriptionId,n=this.getRoleDefinitionsResourceLabel(t);const r=(0,z.xj)({type:t.provider});o=r?getAzureIconPath(r):new c.ThemeIcon("symbol-field")}catch(t){try{r=parseAzureResourceGroupId(e.scope),i=r.subscriptionId,n=r.resourceGroup,o=getAzureIconPath(z.bB.ResourceGroup)}catch(t){i=e.scope.split("/").pop();const r=await createSubscriptionsClient([e.context,e.subContext]);try{n=(await r.subscriptions.get(i)).displayName}catch(e){n=i}o=getAzureIconPath("Subscription")}}return new RoleDefinitionsItem({id:RoleDefinitionsItem.getId(e.parentResourceId,e.msiId,e.scope),label:n,iconPath:o,description:a,roleDefinition:e.roleDefinition,subscription:e.subContext,scope:e.scope})}static getRoleDefinitionsResourceLabel(e){const t=e.rawId;if(e.provider.startsWith("Microsoft.DurableTask")){const e=t.match(/Microsoft\.DurableTask\/schedulers\/([^/]+)\/taskhubs\/([^/]+)$/i);if(e)return`${e[1]}/${e[2]}`}return e.resourceName}getTreeItem(){return{label:this.label,id:this.id,iconPath:this.iconPath,description:this.description,collapsibleState:c.TreeItemCollapsibleState.Collapsed}}getChildren(){return this.roleDefintions.map((e=>(0,i.createGenericElement)({label:"",id:`${this.id}/${e.id}`,description:e.roleName,contextValue:"roleDefinition"})))}addRoleDefinition(e){this.roleDefintions.some((t=>t.roleName===e.roleName))||this.roleDefintions.push(e)}}class RoleDefinitionsTreeItem extends i.AzExtParentTreeItem{roleDefinitionsItem;label;static contextValue="azureRoleDefinitions";contextValue=RoleDefinitionsTreeItem.contextValue;constructor(e,t){super(e),this.roleDefinitionsItem=t,this.id=t.id,this.label=t.label,this.iconPath=t.iconPath,this.description=t.description}async loadMoreChildrenImpl(e,t){return this.roleDefinitionsItem.roleDefintions.map((e=>{const t=e.id?.split("/").at(-1)??"{roleAssignment}";return new i.GenericTreeItem(this,{label:"",id:`${this.id}/roleAssignments/${t}`,description:e.roleName,tooltip:e.description,contextValue:"roleDefinition"})}))}hasMoreChildrenImpl(){return!1}}var T=r(5136);function setupAzureLogger(e){const t={[c.LogLevel.Off]:void 0,[c.LogLevel.Error]:"error",[c.LogLevel.Warning]:"warning",[c.LogLevel.Info]:"info",[c.LogLevel.Debug]:"verbose",[c.LogLevel.Trace]:"verbose"};T.i2.log=(...t)=>{e.debug(t.join(" "))};const r=e.onDidChangeLogLevel((e=>{(0,T.He)(t[e])}));return new c.Disposable((()=>{T.i2.destroy(),r.dispose()}))}class LocationListStep extends i.AzureWizardPromptStep{options;constructor(e){super(),this.options=e}static addStep(e,t,r){e._alreadyHasLocationStep||(t.push(new this(r)),e._alreadyHasLocationStep=!0)}static getInternalVariables(e){return e._allLocationsTask||(e._allLocationsTask=async function getAllLocations(e){const t=await createSubscriptionsClient(e),r=await R.listAllIterator(t.subscriptions.listLocations(e.subscriptionId,{includeExtendedLocations:e.includeExtendedLocations}));return r.filter((e=>!!(e.id&&e.name&&e.displayName)))}(e)),e._providerLocationsMap||(e._providerLocationsMap=new Map,this.addProviderForFiltering(e,l,"resourceGroups")),[e._allLocationsTask,e._providerLocationsMap]}static async setLocation(e,t){const[r]=this.getInternalVariables(e);e._location=(await r).find((e=>LocationListStep.locationMatchesName(e,t))),e.telemetry.properties.locationType=e._location?.type}static setLocationSubset(e,t,r){const[,n]=this.getInternalVariables(e);n.set(r.toLowerCase(),t)}static async setAutoSelectLocation(e,t){const[r]=this.getInternalVariables(e);e._autoSelectLocation=(await r).find((e=>LocationListStep.locationMatchesName(e,t))),e.telemetry.properties.autoSelectLocationType=e._autoSelectLocation?.type}static resetLocation(e){e._location=void 0,e._allLocationsTask=void 0,e._providerLocationsMap=void 0,e._alreadyHasLocationStep=void 0,e._autoSelectLocation=void 0}static addProviderForFiltering(e,t,r){this.setLocationSubset(e,async function getProviderLocations(e,t,r){const n=await createResourcesClient(e),o=await n.providers.get(t),a=o.resourceTypes?.find((e=>e.resourceType?.toLowerCase()===r.toLowerCase()));if(!a)throw new ProviderResourceTypeNotFoundError(o,r);return(0,i.nonNullProp)(a,"locations")}(e,t,r),t)}static hasLocation(e){return!!e._location}static getExtendedLocation(e){let t,r=e.name;return"EdgeZone"===e.type&&(r=e.metadata.homeLocation,t=e),{location:r,extendedLocation:t}}static getAutoSelectLocation(e){return e._autoSelectLocation}static async getLocation(e,t,r){let n=(0,i.nonNullProp)(e,"_location");function warnAboutRelatedLocation(e){y.outputChannel.appendLog(c.l10n.t('WARNING: Provider "{0}" does not support location "{1}". Using "{2}" instead.',t,n.displayName,e.displayName))}if("EdgeZone"===n.type){if(r)return n;{const o=(0,i.nonNullProp)((0,i.nonNullProp)(n,"metadata"),"homeLocation"),[a]=this.getInternalVariables(e),s=await a,u=(0,i.nonNullValue)(s.find((e=>LocationListStep.locationMatchesName(e,o))),"homeLocation");e.telemetry.properties.relatedLocationSource="home",y.outputChannel.appendLog(c.l10n.t('WARNING: Resource does not support extended location "{0}". Using "{1}" instead.',n.displayName,u.displayName)),n=u}}if(t){const[l,p]=this.getInternalVariables(e),d=await p.get(t.toLowerCase());if(d){function isSupportedByProvider(e){return!!d?.find((t=>LocationListStep.locationMatchesName(e,t)))}function useProviderName(e){return{...e,name:(0,i.nonNullValue)(d?.find((t=>LocationListStep.locationMatchesName(e,t)),"providerName"))}}if(isSupportedByProvider(n))return useProviderName(n);const m=await l;if(n.metadata?.pairedRegion){const g=n.metadata?.pairedRegion.map((e=>m.find((t=>e.name&&LocationListStep.locationMatchesName(t,e.name))))).find((e=>e&&isSupportedByProvider(e)));if(g)return e.telemetry.properties.relatedLocationSource="paired",warnAboutRelatedLocation(g),useProviderName(g)}if(n.name.toLowerCase().endsWith("stage")){const h=n.name.replace(/stage/i,""),w=m.find((e=>LocationListStep.locationMatchesName(e,h)));if(w&&isSupportedByProvider(w))return e.telemetry.properties.relatedLocationSource="nonStage",warnAboutRelatedLocation(w),useProviderName(w)}e.telemetry.properties.locationProviderNotFound=t}}return n}static async getLocations(e){const[t,r]=this.getInternalVariables(e),n=await Promise.all(r.values());return(await t).filter((t=>"EdgeZone"===t.type&&e.includeExtendedLocations||n.every((e=>e.find((e=>LocationListStep.generalizeLocationName(t.name)===LocationListStep.generalizeLocationName(e)))))))}static locationMatchesName(e,t){return(t=LocationListStep.generalizeLocationName(t))===LocationListStep.generalizeLocationName(e.name)||t===LocationListStep.generalizeLocationName(e.displayName)}async prompt(e){const t={placeHolder:c.l10n.t("Select a location for new resources."),enableGrouping:!0,agentMetadata:{parameterDisplayTitle:c.l10n.t("Location"),parameterDisplayDescription:c.l10n.t("The location where resources will be deployed.")},...this.options},r=await this.getQuickPicks(e);let n;e._autoSelectLocation&&(n=r.find((t=>t.data.id===e._autoSelectLocation?.id))),n??=await e.ui.showQuickPick(r,t),e._location=n.data,e.telemetry.properties.locationType=e._location.type}shouldPrompt(e){return!e._location}async getQuickPicks(e){let t=await LocationListStep.getLocations(e);return t=t.sort(compareLocation),t.map((e=>({label:(0,i.nonNullProp)(e,"displayName"),group:e.metadata?.regionCategory,data:e,description:LocationListStep.getQuickPickDescription?.(e),agentMetadata:{}})))}static generalizeLocationName(e){return(e||"").toLowerCase().replace(/[^a-z0-9]/gi,"")}static getQuickPickDescription}function compareLocation(e,t){return!isRecommended(e)&&isRecommended(t)?1:isRecommended(e)&&!isRecommended(t)?-1:0}function isRecommended(e){return"recommended"===e.metadata?.regionCategory?.toLowerCase()}class ProviderResourceTypeNotFoundError extends Error{constructor(e,t){super(c.l10n.t('Provider "{0}" does not have resource type "{1}".',e.id||"undefined",t))}}class ResourceGroupNameStep extends i.AzureWizardPromptStep{async prompt(e){const t=e.relatedNameTask?await e.relatedNameTask:void 0;e.newResourceGroupName=(await e.ui.showInputBox({value:t,prompt:"Enter the name of the new resource group.",validateInput:this.validateResourceGroupName,asyncValidationTask:t=>this.asyncValidateResourceGroupAvailable(e,t)})).trim(),e.valuesToMask.push(e.newResourceGroupName)}shouldPrompt(e){return!e.newResourceGroupName}validateResourceGroupName(e){return(e=e.trim()).length<G.minLength||e.length>G.maxLength?c.l10n.t("The name must be between {0} and {1} characters.",G.minLength,G.maxLength):null!==e.match(G.invalidCharsRegExp)?c.l10n.t("The name can only contain alphanumeric characters or the symbols ._-()"):e.endsWith(".")?c.l10n.t("The name cannot end in a period."):void 0}async asyncValidateResourceGroupAvailable(e,t){return t=t.trim(),await ResourceGroupListStep.isNameAvailable(e,t)?void 0:c.l10n.t('Resource group "{0}" already exists in subscription "{1}".',t,e.subscriptionDisplayName)}}class ResourceGroupVerifyStep extends i.AzureWizardExecuteStepWithActivityOutput{priority=95;stepName="resourceGroupVerifyStep";getOutputLogFail=e=>c.l10n.t('Failed to verify whether resource group with name "{0}" already exists.',e.newResourceGroupName??"");getOutputLogSuccess(e){return e.resourceGroup?.name?c.l10n.t('Verified resource group with name "{0}" already exists.  Using existing resource group.',e.resourceGroup.name):c.l10n.t('Verified resource group with name "{0}" is available for creation.',e.newResourceGroupName??"")}getTreeItemLabel(e){return e.resourceGroup?.name?c.l10n.t('Verify resource group "{0}" exists',e.resourceGroup.name):c.l10n.t('Verify resource group "{0}" is available',e.newResourceGroupName??"")}async execute(e,t){t.report({message:c.l10n.t("Checking resource group availability...")});const r=(0,i.nonNullProp)(e,"newResourceGroupName"),n=await createResourcesClient(e);try{(await n.resourceGroups.checkExistence(r)).body&&(e.resourceGroup=await n.resourceGroups.get(r),y.outputChannel.appendLog(c.l10n.t('Found an existing resource group with name "{0}".',r)),y.outputChannel.appendLog(c.l10n.t('Using resource group "{0}".',r)))}catch(t){throw e.suppress403Handling||"403"!==(0,i.parseError)(t).errorType||(this.options.continueOnFail=!0),t}finally{e._lastResourceGroupNameVerified=e.newResourceGroupName}}shouldExecute(e){return!e.resourceGroup&&e._lastResourceGroupNameVerified!==e.newResourceGroupName}_errorItemId=(0,a.randomUUID)();createFailOutput(e){const t=new i.ActivityChildItem({label:this.getTreeItemLabel(e),activityType:i.ActivityChildType.Fail,contextValue:(0,i.createContextValue)([`${this.stepName}Item`,i.activityFailContext]),iconPath:i.activityFailIcon,isParent:!0,initialCollapsibleState:c.TreeItemCollapsibleState.Expanded});return this.options.continueOnFail&&(t.getChildren=()=>[new i.ActivityChildItem({id:this._errorItemId,activityType:i.ActivityChildType.Error,contextValue:(0,i.createContextValue)([`${this.stepName}Item`,i.activityErrorContext]),label:c.l10n.t('Unable to verify resource group "{0}" in subscription "{1}" due to a lack of permissions.',(0,i.nonNullProp)(e,"newResourceGroupName"),e.subscriptionDisplayName)})]),{item:t,message:this.getOutputLogFail(e)}}}const G={minLength:1,maxLength:90,invalidCharsRegExp:/[^a-zA-Z0-9\.\_\-\(\)]/};class ResourceGroupListStep extends i.AzureWizardPromptStep{_suppressCreate;constructor(e){super(),this._suppressCreate=e}static async getResourceGroups(e){if(void 0===e.resourceGroupsTask){const t=await createResourcesClient(e);e.resourceGroupsTask=R.listAllIterator(t.resourceGroups.list())}return await e.resourceGroupsTask}static async isNameAvailable(e,t){const r=ResourceGroupListStep.getResourceGroups(e);return!(await r).some((e=>void 0!==e.name&&e.name.toLowerCase()===t.toLowerCase()))}async prompt(e){const t={placeHolder:"Select a resource group for new resources.",id:`ResourceGroupListStep/${e.subscriptionId}`};e.resourceGroup=(await e.ui.showQuickPick(this.getQuickPicks(e),t)).data,!e.resourceGroup||LocationListStep.hasLocation(e)||LocationListStep.getAutoSelectLocation(e)||await LocationListStep.setAutoSelectLocation(e,(0,i.nonNullProp)(e.resourceGroup,"location"))}async getSubWizard(e){if(!e.resourceGroup){const t=[new ResourceGroupNameStep];return LocationListStep.addStep(e,t),{promptSteps:t,executeSteps:[new ResourceGroupVerifyStep,new ResourceGroupCreateStep]}}e.valuesToMask.push((0,i.nonNullProp)(e.resourceGroup,"name"))}shouldPrompt(e){return!e.resourceGroup&&!e.newResourceGroupName}async getQuickPicks(e){const t=[];this._suppressCreate||t.push({label:c.l10n.t("$(plus) Create new resource group"),description:"",data:void 0});const r=(await ResourceGroupListStep.getResourceGroups(e)).sort(((e,t)=>{const r=(0,i.nonNullProp)(e,"name"),n=(0,i.nonNullProp)(t,"name");return r>n?1:r<n?-1:0}));return t.concat(r.map((e=>({id:e.id,label:e.name,description:e.location,data:e}))))}}class ResourceGroupCreateStep extends i.AzureWizardExecuteStepWithActivityOutput{priority=100;stepName="resourceGroupCreateStep";getOutputLogSuccess=e=>c.l10n.t('Successfully created resource group "{0}".',(0,i.nonNullValueAndProp)(e.resourceGroup,"name"));getOutputLogFail=e=>c.l10n.t('Failed to create resource group "{0}".',e.newResourceGroupName??"");getTreeItemLabel=e=>c.l10n.t('Create resource group "{0}"',e.newResourceGroupName??"");isMissingCreatePermissions=!1;async configureBeforeExecute(e){if(e.resourceGroup||e._lastResourceGroupNameVerified===e.newResourceGroupName)return;const t=(0,i.nonNullProp)(e,"newResourceGroupName"),r=await createResourcesClient(e);try{(await r.resourceGroups.checkExistence(t)).body&&(e.resourceGroup=await r.resourceGroups.get(t),y.outputChannel.appendLog(c.l10n.t('Found an existing resource group with name "{0}".',t)),y.outputChannel.appendLog(c.l10n.t('Using resource group "{0}".',t)))}catch(t){if(e.suppress403Handling||"403"!==(0,i.parseError)(t).errorType)throw y.outputChannel.appendLog(c.l10n.t("Error occurred while trying to verify whether the given resource group already exists: ")),y.outputChannel.appendLog((0,i.parseError)(t).message),t}}async execute(e,t){t.report({message:c.l10n.t("Creating resource group...")});const r=(0,i.nonNullProp)(e,"newResourceGroupName"),n=(await LocationListStep.getLocation(e,l,!1)).name,o=await createResourcesClient(e);try{e.resourceGroup=await o.resourceGroups.createOrUpdate(r,{location:n})}catch(t){const n=(0,i.parseError)(t);if(!e.suppress403Handling&&"403"===n.errorType){this.options.continueOnFail=!0,this.isMissingCreatePermissions=!0,this.addExecuteSteps=()=>[new ResourceGroupNoCreatePermissionsSelectStep],this.options.suppressActivityOutput=i.ActivityOutputType.Message;const t=c.l10n.t('Unable to create resource group "{0}" in subscription "{1}" due to a lack of permissions.',r,e.subscriptionDisplayName);y.outputChannel.appendLog(t),y.outputChannel.appendLog(n.message)}throw t}}shouldExecute(e){return!e.resourceGroup}_errorItemId=(0,a.randomUUID)();createFailOutput(e){const t=new i.ActivityChildItem({label:this.getTreeItemLabel(e),activityType:i.ActivityChildType.Fail,contextValue:(0,i.createContextValue)([`${this.stepName}Item`,i.activityFailContext]),iconPath:i.activityFailIcon,isParent:!0,initialCollapsibleState:c.TreeItemCollapsibleState.Expanded});return this.isMissingCreatePermissions&&(t.getChildren=()=>[new i.ActivityChildItem({id:this._errorItemId,activityType:i.ActivityChildType.Error,contextValue:(0,i.createContextValue)([`${this.stepName}Item`,i.activityErrorContext]),label:c.l10n.t('Unable to create resource group "{0}" in subscription "{1}" due to a lack of permissions.',(0,i.nonNullProp)(e,"newResourceGroupName"),e.subscriptionDisplayName)})]),{item:t,message:this.getOutputLogFail(e)}}}class ResourceGroupNoCreatePermissionsSelectStep extends i.AzureWizardExecuteStepWithActivityOutput{priority=101;stepName="resourceGroupNoCreatePermissionsSelectStep";getOutputLogSuccess=e=>c.l10n.t('Successfully selected existing resource group "{0}".',(0,i.nonNullValueAndProp)(e.resourceGroup,"name"));getOutputLogFail=()=>c.l10n.t("Failed to select an existing resource group.");getTreeItemLabel=e=>e.resourceGroup?.name?c.l10n.t('Select resource group "{0}"',e.resourceGroup.name):c.l10n.t("Select resource group");async execute(e,t){t.report({message:c.l10n.t("Selecting resource group...")});const r=(0,i.nonNullProp)(e,"newResourceGroupName"),n=await createResourcesClient(e);if(/concierge/i.test(e.subscriptionDisplayName)){const t=await R.listAllIterator(n.resourceGroups.list());if(1===t.length&&t[0].name&&/^learn/i.test(t[0].name))return e.resourceGroup=t[0],e.telemetry.properties.forbiddenResponse="SelectLearnRg",void y.outputChannel.appendLog(c.l10n.t('WARNING: Cannot create resource group "{0}" because the selected subscription is a concierge subscription. Using resource group "{1}" instead.',r,(0,i.nonNullValueAndProp)(e.resourceGroup,"name")))}const o=c.l10n.t('You do not have permission to create a resource group in subscription "{0}".',e.subscriptionDisplayName),a={title:c.l10n.t("Select Existing")};await e.ui.showWarningMessage(o,{modal:!0,stepName:"RgNoPermissions"},a),e.telemetry.properties.forbiddenResponse="SelectExistingRg";const s=new ResourceGroupListStep(!0);await s.prompt(e)}shouldExecute(e){return!e.resourceGroup}}class RoleAssignmentExecuteStep extends i.AzureWizardExecuteStep{priority;async execute(e,t){}shouldExecute(e){return!0}roles;constructor(e,t){super(),this.roles=e,this.priority=t?.priority??900}async addExecuteSteps(e){const t=await this.roles(),r=[];for(const e of t??[])r.push(new SingleRoleAssignmentExecuteStep(e,{priority:this.priority+1}));return r}}class SingleRoleAssignmentExecuteStep extends i.AzureWizardExecuteStepWithActivityOutput{role;priority;stepName="RoleAssignmentExecuteStep";getTreeItemLabel(e){const{resourceName:t,resourceType:r}=this.resourceNameAndType;return c.l10n.t('Create role assignment "{0}" for the {1} resource "{2}"',this.role.roleDefinitionName,r,t)}getOutputLogSuccess(e){const{resourceName:t,resourceType:r}=this.resourceNameAndType;return c.l10n.t('Successfully created role assignment "{0}" for the {1} resource "{2}".',this.role.roleDefinitionName,r,t)}getOutputLogFail(e){const{resourceName:t,resourceType:r}=this.resourceNameAndType;return c.l10n.t('Failed to create role assignment "{0}" for the {1} resource "{2}".',this.role.roleDefinitionName,r,t)}getOutputLogProgress(e){const{resourceName:t,resourceType:r}=this.resourceNameAndType;return c.l10n.t('Creating role assignment "{0}" for the {1} resource "{2}"...',this.role.roleDefinitionName,r,t)}_retries=0;constructor(e,t){super(),this.role=e,this.priority=t?.priority??901}async executeCore(e,t){const r=await createAuthorizationManagementClient(e),n=this.role.scopeId;if(!n)throw new Error(c.l10n.t("No scope was provided for the role assignment."));try{const t=(0,a.randomUUID)(),o=this.role.roleDefinitionId,s=(0,i.nonNullValueAndProp)(e.managedIdentity,"principalId");await r.roleAssignments.create(n,t,{roleDefinitionId:o,principalId:s})}catch(r){const n=(0,i.parseError)(r),o=5;if(n.message.includes("If you are creating this principal and then immediately assigning a role, this error might be related to a replication delay.")&&this._retries<o)return this._retries++,e.telemetry.properties.roleAssignmentCreateRetryCount=this._retries.toString(),await this.executeCore(e,t);throw n}}async execute(e,t){return await this.executeCore(e,t)}shouldExecute(e){return!!e.managedIdentity}get resourceNameAndType(){const e=this.role.scopeId;if(!e)throw new Error(c.l10n.t("No scope was provided for the role assignment."));const t=e.split("/");return{resourceName:t[t.length-1]??"",resourceType:t[t.length-2]??""}}}class StorageAccountCreateStep extends i.AzureWizardExecuteStepWithActivityOutput{stepName="StorageAccountCreateStep";priority=130;_defaults;constructor(e){super(),this._defaults=e}async execute(e,t){t.report({message:c.l10n.t("Creating storage account...")});const r=(await LocationListStep.getLocation(e,p)).name,n=e.newStorageAccountName,o=`${this._defaults.performance}_${this._defaults.replication}`,i=await createStorageClient(e);e.storageAccount=await i.storageAccounts.beginCreateAndWait(e.resourceGroup.name,n,{sku:{name:o},kind:this._defaults.kind,location:r,enableHttpsTrafficOnly:!0,allowBlobPublicAccess:!1,defaultToOAuthAuthentication:!0,allowSharedKeyAccess:!e.disableSharedKeyAccess})}getTreeItemLabel(e){const t=(0,i.nonNullProp)(e,"newStorageAccountName"),r=`${this._defaults.performance}_${this._defaults.replication}`;return c.l10n.t('Create storage account "{0}" with sku "{1}"',t,r)}getOutputLogSuccess(e){const t=(0,i.nonNullProp)(e,"newStorageAccountName"),r=`${this._defaults.performance}_${this._defaults.replication}`;return c.l10n.t('Successfully created storage account "{0}" with sku "{1}".',t,r)}getOutputLogFail(e){const t=(0,i.nonNullProp)(e,"newStorageAccountName"),r=`${this._defaults.performance}_${this._defaults.replication}`;return c.l10n.t('Failed to create storage account "{0}" with sku "{1}".',t,r)}getOutputLogProgress(e){const t=(0,i.nonNullProp)(e,"newStorageAccountName"),r=`${this._defaults.performance}_${this._defaults.replication}`;return c.l10n.t('Creating storage account "{0}" with sku "{1}"...',t,r)}shouldExecute(e){return!e.storageAccount}}class StorageAccountNameStep extends i.AzureNameStep{async prompt(e){const t=await createStorageClient(e),r=e.relatedNameTask?await e.relatedNameTask:void 0;e.newStorageAccountName=(await e.ui.showInputBox({value:r,prompt:"Enter the name of the new storage account.",validateInput:async e=>await this.validateStorageAccountName(t,e)})).trim(),e.relatedNameTask||(e.relatedNameTask=this.generateRelatedName(e,e.newStorageAccountName,G)),e.valuesToMask.push(e.newStorageAccountName)}shouldPrompt(e){return!e.newStorageAccountName}async isRelatedNameAvailable(e,t){return await ResourceGroupListStep.isNameAvailable(e,t)}async validateStorageAccountName(e,t){if(!(t=t.trim())||t.length<D.minLength||t.length>D.maxLength)return c.l10n.t("The name must be between {0} and {1} characters.",D.minLength,D.maxLength);if(null!==t.match(D.invalidCharsRegExp))return c.l10n.t("The name can only contain lowercase letters and numbers.");{const r=await e.storageAccounts.checkNameAvailability({name:t,type:d});return r.nameAvailable?void 0:r.message}}}const D={minLength:3,maxLength:24,invalidCharsRegExp:/[^a-z0-9]/,lowercaseOnly:!0};var k,E,_;!function(e){e.Storage="Storage",e.StorageV2="StorageV2",e.BlobStorage="BlobStorage",e.BlockBlobStorage="BlockBlobStorage"}(k||(k={})),function(e){e.Standard="Standard",e.Premium="Premium"}(E||(E={})),function(e){e.LRS="LRS",e.ZRS="ZRS",e.GRS="GRS",e.RAGRS="RAGRS"}(_||(_={}));class StorageAccountListStep extends i.AzureWizardPromptStep{_newAccountDefaults;_filters;constructor(e,t){super(),this._newAccountDefaults=e,this._filters=t||{}}static async isNameAvailable(e,t){const r=await createStorageClient(e);return!!(await r.storageAccounts.checkNameAvailability({name:t,type:d})).nameAvailable}async prompt(e){const t=await createStorageClient(e),r={placeHolder:"Select a storage account.",id:`StorageAccountListStep/${e.subscriptionId}`},n=this.getQuickPicks(e,R.listAllIterator(t.storageAccounts.list())),o=(await e.ui.showQuickPick(n,r)).data;e.storageAccount=o,e.storageAccount&&await LocationListStep.setLocation(e,e.storageAccount.location)}async getSubWizard(e){if(!e.storageAccount){const t=[new StorageAccountNameStep,new ResourceGroupListStep];return LocationListStep.addStep(e,t),{promptSteps:t,executeSteps:[new StorageAccountCreateStep(this._newAccountDefaults)]}}e.valuesToMask.push((0,i.nonNullProp)(e.storageAccount,"name"))}shouldPrompt(e){return!e.storageAccount&&!e.newStorageAccountName}async getQuickPicks(e,t){const r=[{label:c.l10n.t("$(plus) Create new storage account"),description:"",data:void 0}],n=new RegExp(`^${convertFilterToPattern(this._filters.kind)}$`,"i"),o=new RegExp(`^${convertFilterToPattern(this._filters.performance)}_.*$`,"i"),a=new RegExp(`^.*_${convertFilterToPattern(this._filters.replication)}$`,"i");let s;LocationListStep.hasLocation(e)&&(s=await LocationListStep.getLocation(e,p));let u=!1,l=!1,d=!1;const m=(await t).sort(((e,t)=>(0,i.nonNullProp)(e,"name").localeCompare((0,i.nonNullProp)(t,"name"))));for(const e of m){if(!e.kind||e.kind.match(n)||!e.sku||e.sku.name.match(o)||e.sku.name.match(a)){u=!0;continue}if(s&&!LocationListStep.locationMatchesName(s,e.location)){l=!0;continue}const t=e.networkRuleSet?.defaultAction??e.networkAcls?.defaultAction;"disabled"===e.publicNetworkAccess?.toLocaleLowerCase()||"enabled"===e.publicNetworkAccess?.toLocaleLowerCase()&&"Deny"===t?d=!0:r.push({id:e.id,label:e.name,description:"",data:e})}return u&&this._filters.learnMoreLink&&r.push({label:c.l10n.t("$(info) Some storage accounts were filtered because of their sku. Learn more..."),onPicked:async()=>{await(0,i.openUrl)(this._filters.learnMoreLink)},data:void 0}),l&&s&&r.push({label:c.l10n.t('$(warning) Only storage accounts in the region "{0}" are shown.',s.displayName),onPicked:()=>{},data:void 0}),d&&r.push({label:c.l10n.t("$(warning) Some storage accounts were filtered because of their network configurations."),onPicked:()=>{},data:void 0}),r}}function convertFilterToPattern(e){return e||=[],`(${e.join("|")})`}class UserAssignedIdentityNameStep extends i.AzureWizardPromptStep{async prompt(e){let t;const r=e.resourceGroup?.name??e.newResourceGroupName;if(r)for(;!t;)t=await UserAssignedIdentityNameStep.tryGenerateRelatedName(e,r);e.newManagedIdentityName=(await e.ui.showInputBox({value:t,prompt:c.l10n.t("Enter a name for the new user-assigned identity."),validateInput:this.validateInput,asyncValidationTask:t=>this.asyncValidateUserAssignedIdentityAvailable(e,t)})).trim(),e.valuesToMask.push(e.newManagedIdentityName)}shouldPrompt(e){return!e.newManagedIdentityName}validateInput(e=""){e=e.trim();const t={lowerLimitIncl:3,upperLimitIncl:128};return i.validationUtils.hasValidCharLength(e,t)?/^[a-zA-Z0-9][a-zA-Z0-9-_]*$/.test(e)?void 0:c.l10n.t("The resource name must start with a letter or number, and can only contain a combination of alphanumeric characters, hyphens, and underscores."):i.validationUtils.getInvalidCharLengthMessage(t)}async asyncValidateUserAssignedIdentityAvailable(e,t,r=""){if(r=r.trim(),!t)return;return await UserAssignedIdentityNameStep.isNameAvailable(e,t,r)?void 0:c.l10n.t('User-assigned identity with name "{0}" already exists in resource group "{1}".',r,t)}static async isNameAvailable(e,t,r){try{const n=await createManagedServiceIdentityClient(e);return!await n.userAssignedIdentities.get(t,r)}catch{return!0}}static async tryGenerateRelatedName(e,t){const r=`${t}-identities-${i.randomUtils.getRandomHexString(6)}`;return await UserAssignedIdentityNameStep.isNameAvailable(e,t,r)?r:void 0}}class UserAssignedIdentityCreateStep extends i.AzureWizardExecuteStepWithActivityOutput{priority=101;stepName="UserAssignedIdentityCreateStep";async execute(e,t){const r=(await LocationListStep.getLocation(e,p)).name,n=e.newResourceGroupName??(0,i.nonNullValueAndProp)(e.resourceGroup,"name"),o=(0,i.nonNullProp)(e,"newManagedIdentityName"),a=await createManagedServiceIdentityClient(e);e.managedIdentity=await a.userAssignedIdentities.createOrUpdate(n,o,{location:r})}shouldExecute(e){return!e.managedIdentity}async configureBeforeExecute(e){const t=e.newResourceGroupName??(0,i.nonNullValueAndProp)(e.resourceGroup,"name");for(;!e.newManagedIdentityName;)e.newManagedIdentityName=await UserAssignedIdentityNameStep.tryGenerateRelatedName(e,t)}getTreeItemLabel(e){const t=(0,i.nonNullProp)(e,"newManagedIdentityName");return c.l10n.t('Create user-assigned identity "{0}"',t)}getOutputLogSuccess(e){const t=(0,i.nonNullProp)(e,"newManagedIdentityName");return c.l10n.t('Successfully created user-assigned identity "{0}".',t)}getOutputLogFail(e){const t=(0,i.nonNullProp)(e,"newManagedIdentityName");return c.l10n.t('Failed to create user-assigned identity "{0}".',t)}getOutputLogProgress(e){const t=(0,i.nonNullProp)(e,"newManagedIdentityName");return c.l10n.t('Creating user-assigned identity "{0}"...',t)}}class UserAssignedIdentityListStep extends i.AzureWizardPromptStep{_suppressCreate;constructor(e){super(),this._suppressCreate=e}async prompt(e){const t={placeHolder:c.l10n.t("Select a user-assigned identity."),id:"UserAssignedIdentityListStep"};e.managedIdentity=(await e.ui.showQuickPick(this.getQuickPicks(e),t)).data}shouldPrompt(e){return!e.managedIdentity}async getSubWizard(e){if(!e.managedIdentity){const t=[new UserAssignedIdentityNameStep,new ResourceGroupListStep];return LocationListStep.addProviderForFiltering(e,m,g),LocationListStep.addStep(e,t),{promptSteps:t,executeSteps:[new UserAssignedIdentityCreateStep]}}}async getQuickPicks(e){const t=[],r=await createManagedServiceIdentityClient(e),n=await R.listAllIterator(r.userAssignedIdentities.listBySubscription());return this._suppressCreate||t.push({label:c.l10n.t("$(plus) Create new user-assigned identity"),description:"",data:void 0}),t.concat(n.map((e=>({id:e.id,label:e.name,description:e.location,data:e}))))}}async function delay(e){await new Promise((t=>setTimeout(t,e)))}class VerifyProvidersStep extends i.AzureWizardExecuteStep{priority=90;_providers;constructor(e){super(),this._providers=e}async execute(e,t){t.report({message:c.l10n.t("Registering Providers...")});const r=await createResourcesClient(e);await Promise.all(this._providers.map((async t=>{try{let e=await r.providers.get(t);if("registered"!==e.registrationState?.toLowerCase()){await r.providers.register(t);const n=Date.now()+3e4;do{await delay(2e3),e=await r.providers.get(t)}while("registering"===e.registrationState?.toLowerCase()&&Date.now()<n)}}catch(t){const r=(0,i.parseError)(t),n=(0,i.maskUserInfo)(r.message,[]);e.telemetry.properties.providerError=n,e.telemetry.properties.providerErrorV2=n}})))}shouldExecute(e){return!0}}}};