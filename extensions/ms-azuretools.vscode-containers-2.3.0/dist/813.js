/*! For license information please see 813.js.LICENSE.txt */
exports.id=813,exports.ids=[813],exports.modules={1977:(e,t,r)=>{const n=r(99589);e.exports=n.satisfies(process.version,">=15.7.0")},3527:e=>{"use strict";function getParamSize(e){return(e/8|0)+(e%8==0?0:1)}var t={ES256:getParamSize(256),ES384:getParamSize(384),ES512:getParamSize(521)};e.exports=function getParamBytesForAlg(e){var r=t[e];if(r)return r;throw new Error('Unknown algorithm "'+e+'"')}},13726:(e,t,r)=>{var n=r(81741),NotBeforeError=function(e,t){n.call(this,e),this.name="NotBeforeError",this.date=t};(NotBeforeError.prototype=Object.create(n.prototype)).constructor=NotBeforeError,e.exports=NotBeforeError},15242:(e,t,r)=>{var n=r(20181),i=n.Buffer;function copyProps(e,t){for(var r in e)t[r]=e[r]}function SafeBuffer(e,t,r){return i(e,t,r)}i.from&&i.alloc&&i.allocUnsafe&&i.allocUnsafeSlow?e.exports=n:(copyProps(n,t),t.Buffer=SafeBuffer),SafeBuffer.prototype=Object.create(i.prototype),copyProps(i,SafeBuffer),SafeBuffer.from=function(e,t,r){if("number"==typeof e)throw new TypeError("Argument must not be a number");return i(e,t,r)},SafeBuffer.alloc=function(e,t,r){if("number"!=typeof e)throw new TypeError("Argument must be a number");var n=i(e);return void 0!==t?"string"==typeof r?n.fill(t,r):n.fill(t):n.fill(0),n},SafeBuffer.allocUnsafe=function(e){if("number"!=typeof e)throw new TypeError("Argument must be a number");return i(e)},SafeBuffer.allocUnsafeSlow=function(e){if("number"!=typeof e)throw new TypeError("Argument must be a number");return n.SlowBuffer(e)}},17894:(e,t,r)=>{var n=r(20181).Buffer;e.exports=function toString(e){return"string"==typeof e?e:"number"==typeof e||n.isBuffer(e)?e.toString():JSON.stringify(e)}},18980:(e,t,r)=>{var n=r(81741),TokenExpiredError=function(e,t){n.call(this,e),this.name="TokenExpiredError",this.expiredAt=t};(TokenExpiredError.prototype=Object.create(n.prototype)).constructor=TokenExpiredError,e.exports=TokenExpiredError},22010:(e,t,r)=>{"use strict";var n=r(15242).Buffer,i=r(3527),o=128;function signatureAsBuffer(e){if(n.isBuffer(e))return e;if("string"==typeof e)return n.from(e,"base64");throw new TypeError("ECDSA signature must be a Base64 string or a Buffer")}function countPadding(e,t,r){for(var n=0;t+n<r&&0===e[t+n];)++n;return e[t+n]>=o&&--n,n}e.exports={derToJose:function derToJose(e,t){e=signatureAsBuffer(e);var r=i(t),o=r+1,a=e.length,s=0;if(48!==e[s++])throw new Error('Could not find expected "seq"');var c=e[s++];if(129===c&&(c=e[s++]),a-s<c)throw new Error('"seq" specified length of "'+c+'", only "'+(a-s)+'" remaining');if(2!==e[s++])throw new Error('Could not find expected "int" for "r"');var l=e[s++];if(a-s-2<l)throw new Error('"r" specified length of "'+l+'", only "'+(a-s-2)+'" available');if(o<l)throw new Error('"r" specified length of "'+l+'", max of "'+o+'" is acceptable');var u=s;if(s+=l,2!==e[s++])throw new Error('Could not find expected "int" for "s"');var d=e[s++];if(a-s!==d)throw new Error('"s" specified length of "'+d+'", expected "'+(a-s)+'"');if(o<d)throw new Error('"s" specified length of "'+d+'", max of "'+o+'" is acceptable');var h=s;if((s+=d)!==a)throw new Error('Expected to consume entire buffer, but "'+(a-s)+'" bytes remain');var g=r-l,p=r-d,f=n.allocUnsafe(g+l+p+d);for(s=0;s<g;++s)f[s]=0;e.copy(f,s,u+Math.max(-g,0),u+l);for(var m=s=r;s<m+p;++s)f[s]=0;return e.copy(f,s,h+Math.max(-p,0),h+d),f=function base64Url(e){return e.replace(/=/g,"").replace(/\+/g,"-").replace(/\//g,"_")}(f=f.toString("base64"))},joseToDer:function joseToDer(e,t){e=signatureAsBuffer(e);var r=i(t),a=e.length;if(a!==2*r)throw new TypeError('"'+t+'" signatures must be "'+2*r+'" bytes, saw "'+a+'"');var s=countPadding(e,0,r),c=countPadding(e,r,e.length),l=r-s,u=r-c,d=2+l+1+1+u,h=d<o,g=n.allocUnsafe((h?2:3)+d),p=0;return g[p++]=48,h?g[p++]=d:(g[p++]=129,g[p++]=255&d),g[p++]=2,g[p++]=l,s<0?(g[p++]=0,p+=e.copy(g,p,0,r)):p+=e.copy(g,p,s,r),g[p++]=2,g[p++]=u,c<0?(g[p++]=0,e.copy(g,p,r)):e.copy(g,p,r+c),g}}},22103:(e,t,r)=>{var n=r(15242).Buffer,i=r(2203);function DataStream(e){if(this.buffer=null,this.writable=!0,this.readable=!0,!e)return this.buffer=n.alloc(0),this;if("function"==typeof e.pipe)return this.buffer=n.alloc(0),e.pipe(this),this;if(e.length||"object"==typeof e)return this.buffer=e,this.writable=!1,process.nextTick(function(){this.emit("end",e),this.readable=!1,this.emit("close")}.bind(this)),this;throw new TypeError("Unexpected data type ("+typeof e+")")}r(39023).inherits(DataStream,i),DataStream.prototype.write=function write(e){this.buffer=n.concat([this.buffer,n.from(e)]),this.emit("data",e)},DataStream.prototype.end=function end(e){e&&this.write(e),this.emit("end",e),this.emit("close"),this.writable=!1,this.readable=!1},e.exports=DataStream},26456:(e,t,r)=>{var n=r(15242).Buffer,i=r(22103),o=r(36942),a=r(2203),s=r(17894),c=r(39023);function base64url(e,t){return n.from(e,t).toString("base64").replace(/=/g,"").replace(/\+/g,"-").replace(/\//g,"_")}function jwsSign(e){var t=e.header,r=e.payload,n=e.secret||e.privateKey,i=e.encoding,a=o(t.alg),l=function jwsSecuredInput(e,t,r){r=r||"utf8";var n=base64url(s(e),"binary"),i=base64url(s(t),r);return c.format("%s.%s",n,i)}(t,r,i),u=a.sign(l,n);return c.format("%s.%s",l,u)}function SignStream(e){var t=e.secret||e.privateKey||e.key,r=new i(t);this.readable=!0,this.header=e.header,this.encoding=e.encoding,this.secret=this.privateKey=this.key=r,this.payload=new i(e.payload),this.secret.once("close",function(){!this.payload.writable&&this.readable&&this.sign()}.bind(this)),this.payload.once("close",function(){!this.secret.writable&&this.readable&&this.sign()}.bind(this))}c.inherits(SignStream,a),SignStream.prototype.sign=function sign(){try{var e=jwsSign({header:this.header,payload:this.payload.buffer,secret:this.secret.buffer,encoding:this.encoding});return this.emit("done",e),this.emit("data",e),this.emit("end"),this.readable=!1,e}catch(e){this.readable=!1,this.emit("error",e),this.emit("close")}},SignStream.sign=jwsSign,e.exports=SignStream},34623:(e,t,r)=>{const n=r(99589);e.exports=n.satisfies(process.version,">=16.9.0")},36942:(e,t,r)=>{var n=r(41045),i=r(15242).Buffer,o=r(76982),a=r(22010),s=r(39023),c="secret must be a string or buffer",l="key must be a string or a buffer",u="function"==typeof o.createPublicKey;function checkIsPublicKey(e){if(!i.isBuffer(e)&&"string"!=typeof e){if(!u)throw typeError(l);if("object"!=typeof e)throw typeError(l);if("string"!=typeof e.type)throw typeError(l);if("string"!=typeof e.asymmetricKeyType)throw typeError(l);if("function"!=typeof e.export)throw typeError(l)}}function checkIsPrivateKey(e){if(!i.isBuffer(e)&&"string"!=typeof e&&"object"!=typeof e)throw typeError("key must be a string, a buffer or an object")}function fromBase64(e){return e.replace(/=/g,"").replace(/\+/g,"-").replace(/\//g,"_")}function toBase64(e){var t=4-(e=e.toString()).length%4;if(4!==t)for(var r=0;r<t;++r)e+="=";return e.replace(/\-/g,"+").replace(/_/g,"/")}function typeError(e){var t=[].slice.call(arguments,1),r=s.format.bind(s,e).apply(null,t);return new TypeError(r)}function normalizeInput(e){return function bufferOrString(e){return i.isBuffer(e)||"string"==typeof e}(e)||(e=JSON.stringify(e)),e}function createHmacSigner(e){return function sign(t,r){!function checkIsSecretKey(e){if(!i.isBuffer(e)){if("string"==typeof e)return e;if(!u)throw typeError(c);if("object"!=typeof e)throw typeError(c);if("secret"!==e.type)throw typeError(c);if("function"!=typeof e.export)throw typeError(c)}}(r),t=normalizeInput(t);var n=o.createHmac("sha"+e,r);return fromBase64((n.update(t),n.digest("base64")))}}function createHmacVerifier(e){return function verify(t,r,o){var a=createHmacSigner(e)(t,o);return n(i.from(r),i.from(a))}}function createKeySigner(e){return function sign(t,r){checkIsPrivateKey(r),t=normalizeInput(t);var n=o.createSign("RSA-SHA"+e);return fromBase64((n.update(t),n.sign(r,"base64")))}}function createKeyVerifier(e){return function verify(t,r,n){checkIsPublicKey(n),t=normalizeInput(t),r=toBase64(r);var i=o.createVerify("RSA-SHA"+e);return i.update(t),i.verify(n,r,"base64")}}function createPSSKeySigner(e){return function sign(t,r){checkIsPrivateKey(r),t=normalizeInput(t);var n=o.createSign("RSA-SHA"+e);return fromBase64((n.update(t),n.sign({key:r,padding:o.constants.RSA_PKCS1_PSS_PADDING,saltLength:o.constants.RSA_PSS_SALTLEN_DIGEST},"base64")))}}function createPSSKeyVerifier(e){return function verify(t,r,n){checkIsPublicKey(n),t=normalizeInput(t),r=toBase64(r);var i=o.createVerify("RSA-SHA"+e);return i.update(t),i.verify({key:n,padding:o.constants.RSA_PKCS1_PSS_PADDING,saltLength:o.constants.RSA_PSS_SALTLEN_DIGEST},r,"base64")}}function createECDSASigner(e){var t=createKeySigner(e);return function sign(){var r=t.apply(null,arguments);return r=a.derToJose(r,"ES"+e)}}function createECDSAVerifer(e){var t=createKeyVerifier(e);return function verify(r,n,i){return n=a.joseToDer(n,"ES"+e).toString("base64"),t(r,n,i)}}function createNoneSigner(){return function sign(){return""}}function createNoneVerifier(){return function verify(e,t){return""===t}}u&&(l+=" or a KeyObject",c+="or a KeyObject"),e.exports=function jwa(e){var t={hs:createHmacSigner,rs:createKeySigner,ps:createPSSKeySigner,es:createECDSASigner,none:createNoneSigner},r={hs:createHmacVerifier,rs:createKeyVerifier,ps:createPSSKeyVerifier,es:createECDSAVerifer,none:createNoneVerifier},n=e.match(/^(RS|PS|ES|HS)(256|384|512)$|^(none)$/i);if(!n)throw typeError('"%s" is not a valid algorithm.\n  Supported algorithms are:\n  "HS256", "HS384", "HS512", "RS256", "RS384", "RS512", "PS256", "PS384", "PS512", "ES256", "ES384", "ES512" and "none".',e);var i=(n[1]||n[3]).toLowerCase(),o=n[2];return{sign:t[i](o),verify:r[i](o)}}},37260:(e,t,r)=>{var n=r(50652);e.exports=function(e,t){t=t||{};var r=n.decode(e,t);if(!r)return null;var i=r.payload;if("string"==typeof i)try{var o=JSON.parse(i);null!==o&&"object"==typeof o&&(i=o)}catch(e){}return!0===t.complete?{header:r.header,payload:i,signature:r.signature}:i}},37651:(e,t,r)=>{const n=r(40855),i=r(74977),o=r(47019),a=r(50652),s=r(68492),c=r(87914),l=r(58928),u=r(73639),d=r(79001),h=r(45931),g=r(67083),{KeyObject:p,createSecretKey:f,createPrivateKey:m}=r(76982),y=["RS256","RS384","RS512","ES256","ES384","ES512","HS256","HS384","HS512","none"];i&&y.splice(3,0,"PS256","PS384","PS512");const C={expiresIn:{isValid:function(e){return l(e)||h(e)&&e},message:'"expiresIn" should be a number of seconds or string representing a timespan'},notBefore:{isValid:function(e){return l(e)||h(e)&&e},message:'"notBefore" should be a number of seconds or string representing a timespan'},audience:{isValid:function(e){return h(e)||Array.isArray(e)},message:'"audience" must be a string or array'},algorithm:{isValid:s.bind(null,y),message:'"algorithm" must be a valid string enum value'},header:{isValid:d,message:'"header" must be an object'},encoding:{isValid:h,message:'"encoding" must be a string'},issuer:{isValid:h,message:'"issuer" must be a string'},subject:{isValid:h,message:'"subject" must be a string'},jwtid:{isValid:h,message:'"jwtid" must be a string'},noTimestamp:{isValid:c,message:'"noTimestamp" must be a boolean'},keyid:{isValid:h,message:'"keyid" must be a string'},mutatePayload:{isValid:c,message:'"mutatePayload" must be a boolean'},allowInsecureKeySizes:{isValid:c,message:'"allowInsecureKeySizes" must be a boolean'},allowInvalidAsymmetricKeyTypes:{isValid:c,message:'"allowInvalidAsymmetricKeyTypes" must be a boolean'}},A={iat:{isValid:u,message:'"iat" should be a number of seconds'},exp:{isValid:u,message:'"exp" should be a number of seconds'},nbf:{isValid:u,message:'"nbf" should be a number of seconds'}};function validate(e,t,r,n){if(!d(r))throw new Error('Expected "'+n+'" to be a plain object.');Object.keys(r).forEach((function(i){const o=e[i];if(o){if(!o.isValid(r[i]))throw new Error(o.message)}else if(!t)throw new Error('"'+i+'" is not allowed in "'+n+'"')}))}const T={audience:"aud",issuer:"iss",subject:"sub",jwtid:"jti"},I=["expiresIn","notBefore","noTimestamp","audience","issuer","subject","jwtid"];e.exports=function(e,t,r,i){"function"==typeof r?(i=r,r={}):r=r||{};const s="object"==typeof e&&!Buffer.isBuffer(e),c=Object.assign({alg:r.algorithm||"HS256",typ:s?"JWT":void 0,kid:r.keyid},r.header);function failure(e){if(i)return i(e);throw e}if(!t&&"none"!==r.algorithm)return failure(new Error("secretOrPrivateKey must have a value"));if(null!=t&&!(t instanceof p))try{t=m(t)}catch(e){try{t=f("string"==typeof t?Buffer.from(t):t)}catch(e){return failure(new Error("secretOrPrivateKey is not valid key material"))}}if(c.alg.startsWith("HS")&&"secret"!==t.type)return failure(new Error(`secretOrPrivateKey must be a symmetric key when using ${c.alg}`));if(/^(?:RS|PS|ES)/.test(c.alg)){if("private"!==t.type)return failure(new Error(`secretOrPrivateKey must be an asymmetric key when using ${c.alg}`));if(!r.allowInsecureKeySizes&&!c.alg.startsWith("ES")&&void 0!==t.asymmetricKeyDetails&&t.asymmetricKeyDetails.modulusLength<2048)return failure(new Error(`secretOrPrivateKey has a minimum key size of 2048 bits for ${c.alg}`))}if(void 0===e)return failure(new Error("payload is required"));if(s){try{!function validatePayload(e){return validate(A,!0,e,"payload")}(e)}catch(e){return failure(e)}r.mutatePayload||(e=Object.assign({},e))}else{const t=I.filter((function(e){return void 0!==r[e]}));if(t.length>0)return failure(new Error("invalid "+t.join(",")+" option for "+typeof e+" payload"))}if(void 0!==e.exp&&void 0!==r.expiresIn)return failure(new Error('Bad "options.expiresIn" option the payload already has an "exp" property.'));if(void 0!==e.nbf&&void 0!==r.notBefore)return failure(new Error('Bad "options.notBefore" option the payload already has an "nbf" property.'));try{!function validateOptions(e){return validate(C,!1,e,"options")}(r)}catch(e){return failure(e)}if(!r.allowInvalidAsymmetricKeyTypes)try{o(c.alg,t)}catch(e){return failure(e)}const l=e.iat||Math.floor(Date.now()/1e3);if(r.noTimestamp?delete e.iat:s&&(e.iat=l),void 0!==r.notBefore){try{e.nbf=n(r.notBefore,l)}catch(e){return failure(e)}if(void 0===e.nbf)return failure(new Error('"notBefore" should be a number of seconds or string representing a timespan eg: "1d", "20h", 60'))}if(void 0!==r.expiresIn&&"object"==typeof e){try{e.exp=n(r.expiresIn,l)}catch(e){return failure(e)}if(void 0===e.exp)return failure(new Error('"expiresIn" should be a number of seconds or string representing a timespan eg: "1d", "20h", 60'))}Object.keys(T).forEach((function(t){const n=T[t];if(void 0!==r[t]){if(void 0!==e[n])return failure(new Error('Bad "options.'+t+'" option. The payload already has an "'+n+'" property.'));e[n]=r[t]}}));const u=r.encoding||"utf8";if("function"!=typeof i){let n=a.sign({header:c,payload:e,secret:t,encoding:u});if(!r.allowInsecureKeySizes&&/^(?:RS|PS)/.test(c.alg)&&n.length<256)throw new Error(`secretOrPrivateKey has a minimum key size of 2048 bits for ${c.alg}`);return n}i=i&&g(i),a.createSign({header:c,privateKey:t,payload:e,encoding:u}).once("error",i).once("done",(function(e){if(!r.allowInsecureKeySizes&&/^(?:RS|PS)/.test(c.alg)&&e.length<256)return i(new Error(`secretOrPrivateKey has a minimum key size of 2048 bits for ${c.alg}`));i(null,e)}))}},40855:(e,t,r)=>{var n=r(6585);e.exports=function(e,t){var r=t||Math.floor(Date.now()/1e3);if("string"==typeof e){var i=n(e);if(void 0===i)return;return Math.floor(r+i/1e3)}return"number"==typeof e?r+e:void 0}},41045:(e,t,r)=>{"use strict";var n=r(20181).Buffer,i=r(20181).SlowBuffer;function bufferEq(e,t){if(!n.isBuffer(e)||!n.isBuffer(t))return!1;if(e.length!==t.length)return!1;for(var r=0,i=0;i<e.length;i++)r|=e[i]^t[i];return 0===r}e.exports=bufferEq,bufferEq.install=function(){n.prototype.equal=i.prototype.equal=function equal(e){return bufferEq(this,e)}};var o=n.prototype.equal,a=i.prototype.equal;bufferEq.restore=function(){n.prototype.equal=o,i.prototype.equal=a}},44040:(e,t,r)=>{e.exports={decode:r(37260),verify:r(91691),sign:r(37651),JsonWebTokenError:r(81741),NotBeforeError:r(13726),TokenExpiredError:r(18980)}},45931:e=>{var t=Object.prototype.toString,r=Array.isArray;e.exports=function isString(e){return"string"==typeof e||!r(e)&&function isObjectLike(e){return!!e&&"object"==typeof e}(e)&&"[object String]"==t.call(e)}},47019:(e,t,r)=>{const n=r(1977),i=r(34623),o={ec:["ES256","ES384","ES512"],rsa:["RS256","PS256","RS384","PS384","RS512","PS512"],"rsa-pss":["PS256","PS384","PS512"]},a={ES256:"prime256v1",ES384:"secp384r1",ES512:"secp521r1"};e.exports=function(e,t){if(!e||!t)return;const r=t.asymmetricKeyType;if(!r)return;const s=o[r];if(!s)throw new Error(`Unknown key type "${r}".`);if(!s.includes(e))throw new Error(`"alg" parameter for "${r}" key type must be one of: ${s.join(", ")}.`);if(n)switch(r){case"ec":const r=t.asymmetricKeyDetails.namedCurve,n=a[e];if(r!==n)throw new Error(`"alg" parameter "${e}" requires curve "${n}".`);break;case"rsa-pss":if(i){const r=parseInt(e.slice(-3),10),{hashAlgorithm:n,mgf1HashAlgorithm:i,saltLength:o}=t.asymmetricKeyDetails;if(n!==`sha${r}`||i!==n)throw new Error(`Invalid key for this operation, its RSA-PSS parameters do not meet the requirements of "alg" ${e}.`);if(void 0!==o&&o>r>>3)throw new Error(`Invalid key for this operation, its RSA-PSS parameter saltLength does not meet the requirements of "alg" ${e}.`)}}}},50652:(e,t,r)=>{var n=r(26456),i=r(53440);t.ALGORITHMS=["HS256","HS384","HS512","RS256","RS384","RS512","PS256","PS384","PS512","ES256","ES384","ES512"],t.sign=n.sign,t.verify=i.verify,t.decode=i.decode,t.isValid=i.isValid,t.createSign=function createSign(e){return new n(e)},t.createVerify=function createVerify(e){return new i(e)}},53440:(e,t,r)=>{var n=r(15242).Buffer,i=r(22103),o=r(36942),a=r(2203),s=r(17894),c=r(39023),l=/^[a-zA-Z0-9\-_]+?\.[a-zA-Z0-9\-_]+?\.([a-zA-Z0-9\-_]+)?$/;function safeJsonParse(e){if(function isObject(e){return"[object Object]"===Object.prototype.toString.call(e)}(e))return e;try{return JSON.parse(e)}catch(e){return}}function headerFromJWS(e){var t=e.split(".",1)[0];return safeJsonParse(n.from(t,"base64").toString("binary"))}function signatureFromJWS(e){return e.split(".")[2]}function isValidJws(e){return l.test(e)&&!!headerFromJWS(e)}function jwsVerify(e,t,r){if(!t){var n=new Error("Missing algorithm parameter for jws.verify");throw n.code="MISSING_ALGORITHM",n}var i=signatureFromJWS(e=s(e)),a=function securedInputFromJWS(e){return e.split(".",2).join(".")}(e);return o(t).verify(a,i,r)}function jwsDecode(e,t){if(t=t||{},!isValidJws(e=s(e)))return null;var r=headerFromJWS(e);if(!r)return null;var i=function payloadFromJWS(e,t){t=t||"utf8";var r=e.split(".")[1];return n.from(r,"base64").toString(t)}(e);return("JWT"===r.typ||t.json)&&(i=JSON.parse(i,t.encoding)),{header:r,payload:i,signature:signatureFromJWS(e)}}function VerifyStream(e){var t=(e=e||{}).secret||e.publicKey||e.key,r=new i(t);this.readable=!0,this.algorithm=e.algorithm,this.encoding=e.encoding,this.secret=this.publicKey=this.key=r,this.signature=new i(e.signature),this.secret.once("close",function(){!this.signature.writable&&this.readable&&this.verify()}.bind(this)),this.signature.once("close",function(){!this.secret.writable&&this.readable&&this.verify()}.bind(this))}c.inherits(VerifyStream,a),VerifyStream.prototype.verify=function verify(){try{var e=jwsVerify(this.signature.buffer,this.algorithm,this.key.buffer),t=jwsDecode(this.signature.buffer,this.encoding);return this.emit("done",e,t),this.emit("data",e),this.emit("end"),this.readable=!1,e}catch(e){this.readable=!1,this.emit("error",e),this.emit("close")}},VerifyStream.decode=jwsDecode,VerifyStream.isValid=isValidJws,VerifyStream.verify=jwsVerify,e.exports=VerifyStream},58928:e=>{var t=1/0,r=17976931348623157e292,n=NaN,i="[object Symbol]",o=/^\s+|\s+$/g,a=/^[-+]0x[0-9a-f]+$/i,s=/^0b[01]+$/i,c=/^0o[0-7]+$/i,l=parseInt,u=Object.prototype.toString;function isObject(e){var t=typeof e;return!!e&&("object"==t||"function"==t)}e.exports=function isInteger(e){return"number"==typeof e&&e==function toInteger(e){var d=function toFinite(e){if(!e)return 0===e?e:0;if(e=function toNumber(e){if("number"==typeof e)return e;if(function isSymbol(e){return"symbol"==typeof e||function isObjectLike(e){return!!e&&"object"==typeof e}(e)&&u.call(e)==i}(e))return n;if(isObject(e)){var t="function"==typeof e.valueOf?e.valueOf():e;e=isObject(t)?t+"":t}if("string"!=typeof e)return 0===e?e:+e;e=e.replace(o,"");var r=s.test(e);return r||c.test(e)?l(e.slice(2),r?2:8):a.test(e)?n:+e}(e),e===t||e===-1/0){return(e<0?-1:1)*r}return e==e?e:0}(e),h=d%1;return d==d?h?d-h:d:0}(e)}},67083:e=>{var t=1/0,r=17976931348623157e292,n=NaN,i="[object Symbol]",o=/^\s+|\s+$/g,a=/^[-+]0x[0-9a-f]+$/i,s=/^0b[01]+$/i,c=/^0o[0-7]+$/i,l=parseInt,u=Object.prototype.toString;function before(e,d){var h;if("function"!=typeof d)throw new TypeError("Expected a function");return e=function toInteger(e){var d=function toFinite(e){if(!e)return 0===e?e:0;if(e=function toNumber(e){if("number"==typeof e)return e;if(function isSymbol(e){return"symbol"==typeof e||function isObjectLike(e){return!!e&&"object"==typeof e}(e)&&u.call(e)==i}(e))return n;if(isObject(e)){var t="function"==typeof e.valueOf?e.valueOf():e;e=isObject(t)?t+"":t}if("string"!=typeof e)return 0===e?e:+e;e=e.replace(o,"");var r=s.test(e);return r||c.test(e)?l(e.slice(2),r?2:8):a.test(e)?n:+e}(e),e===t||e===-1/0){return(e<0?-1:1)*r}return e==e?e:0}(e),h=d%1;return d==d?h?d-h:d:0}(e),function(){return--e>0&&(h=d.apply(this,arguments)),e<=1&&(d=void 0),h}}function isObject(e){var t=typeof e;return!!e&&("object"==t||"function"==t)}e.exports=function once(e){return before(2,e)}},68492:e=>{var t=1/0,r=9007199254740991,n=17976931348623157e292,i=NaN,o="[object Arguments]",a="[object Function]",s="[object GeneratorFunction]",c="[object String]",l="[object Symbol]",u=/^\s+|\s+$/g,d=/^[-+]0x[0-9a-f]+$/i,h=/^0b[01]+$/i,g=/^0o[0-7]+$/i,p=/^(?:0|[1-9]\d*)$/,f=parseInt;function baseIsNaN(e){return e!=e}function baseValues(e,t){return function arrayMap(e,t){for(var r=-1,n=e?e.length:0,i=Array(n);++r<n;)i[r]=t(e[r],r,e);return i}(t,(function(t){return e[t]}))}var m=Object.prototype,y=m.hasOwnProperty,C=m.toString,A=m.propertyIsEnumerable,T=function overArg(e,t){return function(r){return e(t(r))}}(Object.keys,Object),I=Math.max;function arrayLikeKeys(e,t){var r=S(e)||function isArguments(e){return function isArrayLikeObject(e){return isObjectLike(e)&&isArrayLike(e)}(e)&&y.call(e,"callee")&&(!A.call(e,"callee")||C.call(e)==o)}(e)?function baseTimes(e,t){for(var r=-1,n=Array(e);++r<e;)n[r]=t(r);return n}(e.length,String):[],n=r.length,i=!!n;for(var a in e)!t&&!y.call(e,a)||i&&("length"==a||isIndex(a,n))||r.push(a);return r}function baseKeys(e){if(!function isPrototype(e){var t=e&&e.constructor,r="function"==typeof t&&t.prototype||m;return e===r}(e))return T(e);var t=[];for(var r in Object(e))y.call(e,r)&&"constructor"!=r&&t.push(r);return t}function isIndex(e,t){return!!(t=null==t?r:t)&&("number"==typeof e||p.test(e))&&e>-1&&e%1==0&&e<t}var S=Array.isArray;function isArrayLike(e){return null!=e&&function isLength(e){return"number"==typeof e&&e>-1&&e%1==0&&e<=r}(e.length)&&!function isFunction(e){var t=isObject(e)?C.call(e):"";return t==a||t==s}(e)}function isObject(e){var t=typeof e;return!!e&&("object"==t||"function"==t)}function isObjectLike(e){return!!e&&"object"==typeof e}e.exports=function includes(e,r,o,a){e=isArrayLike(e)?e:function values(e){return e?baseValues(e,function keys(e){return isArrayLike(e)?arrayLikeKeys(e):baseKeys(e)}(e)):[]}(e),o=o&&!a?function toInteger(e){var r=function toFinite(e){if(!e)return 0===e?e:0;if(e=function toNumber(e){if("number"==typeof e)return e;if(function isSymbol(e){return"symbol"==typeof e||isObjectLike(e)&&C.call(e)==l}(e))return i;if(isObject(e)){var t="function"==typeof e.valueOf?e.valueOf():e;e=isObject(t)?t+"":t}if("string"!=typeof e)return 0===e?e:+e;e=e.replace(u,"");var r=h.test(e);return r||g.test(e)?f(e.slice(2),r?2:8):d.test(e)?i:+e}(e),e===t||e===-1/0){return(e<0?-1:1)*n}return e==e?e:0}(e),o=r%1;return r==r?o?r-o:r:0}(o):0;var s=e.length;return o<0&&(o=I(s+o,0)),function isString(e){return"string"==typeof e||!S(e)&&isObjectLike(e)&&C.call(e)==c}(e)?o<=s&&e.indexOf(r,o)>-1:!!s&&function baseIndexOf(e,t,r){if(t!=t)return function baseFindIndex(e,t,r,n){for(var i=e.length,o=r+(n?1:-1);n?o--:++o<i;)if(t(e[o],o,e))return o;return-1}(e,baseIsNaN,r);for(var n=r-1,i=e.length;++n<i;)if(e[n]===t)return n;return-1}(e,r,o)>-1}},73639:e=>{var t=Object.prototype.toString;e.exports=function isNumber(e){return"number"==typeof e||function isObjectLike(e){return!!e&&"object"==typeof e}(e)&&"[object Number]"==t.call(e)}},74977:(e,t,r)=>{var n=r(99589);e.exports=n.satisfies(process.version,"^6.12.0 || >=8.0.0")},79001:e=>{var t=Function.prototype,r=Object.prototype,n=t.toString,i=r.hasOwnProperty,o=n.call(Object),a=r.toString,s=function overArg(e,t){return function(r){return e(t(r))}}(Object.getPrototypeOf,Object);e.exports=function isPlainObject(e){if(!function isObjectLike(e){return!!e&&"object"==typeof e}(e)||"[object Object]"!=a.call(e)||function isHostObject(e){var t=!1;if(null!=e&&"function"!=typeof e.toString)try{t=!!(e+"")}catch(e){}return t}(e))return!1;var t=s(e);if(null===t)return!0;var r=i.call(t,"constructor")&&t.constructor;return"function"==typeof r&&r instanceof r&&n.call(r)==o}},81741:e=>{var JsonWebTokenError=function(e,t){Error.call(this,e),Error.captureStackTrace&&Error.captureStackTrace(this,this.constructor),this.name="JsonWebTokenError",this.message=e,t&&(this.inner=t)};(JsonWebTokenError.prototype=Object.create(Error.prototype)).constructor=JsonWebTokenError,e.exports=JsonWebTokenError},86813:(e,t,r)=>{"use strict";r.d(t,{ClientAssertionCredential:()=>clientAssertionCredential_ClientAssertionCredential});const n="4.8.0",i="04b07795-8ddb-461a-bbee-02f9e1bf7b46";var o;!function(e){e.AzureChina="https://login.chinacloudapi.cn",e.AzureGermany="https://login.microsoftonline.de",e.AzureGovernment="https://login.microsoftonline.us",e.AzurePublicCloud="https://login.microsoftonline.com"}(o||(o={}));const a=o.AzurePublicCloud,s=["*"];let c;let l;const u={generatePluginConfiguration:function generatePluginConfiguration(e){var t,r,n,i,o,a,s;const u={cache:{},broker:{isEnabled:null!==(r=null===(t=e.brokerOptions)||void 0===t?void 0:t.enabled)&&void 0!==r&&r,enableMsaPassthrough:null!==(i=null===(n=e.brokerOptions)||void 0===n?void 0:n.legacyEnableMsaPassthrough)&&void 0!==i&&i,parentWindowHandle:null===(o=e.brokerOptions)||void 0===o?void 0:o.parentWindowHandle}};if(null===(a=e.tokenCachePersistenceOptions)||void 0===a?void 0:a.enabled){if(void 0===c)throw new Error(["Persistent token caching was requested, but no persistence provider was configured.","You must install the identity-cache-persistence plugin package (`npm install --save @azure/identity-cache-persistence`)","and enable it by importing `useIdentityPlugin` from `@azure/identity` and calling","`useIdentityPlugin(cachePersistencePlugin)` before using `tokenCachePersistenceOptions`."].join(" "));const t=e.tokenCachePersistenceOptions.name||"msal.cache";u.cache.cachePlugin=c(Object.assign({name:`${t}.nocae`},e.tokenCachePersistenceOptions)),u.cache.cachePluginCae=c(Object.assign({name:`${t}.cae`},e.tokenCachePersistenceOptions))}if(null===(s=e.brokerOptions)||void 0===s?void 0:s.enabled){if(void 0===l)throw new Error(["Broker for WAM was requested to be enabled, but no native broker was configured.","You must install the identity-broker plugin package (`npm install --save @azure/identity-broker`)","and enable it by importing `useIdentityPlugin` from `@azure/identity` and calling","`useIdentityPlugin(createNativeBrokerPlugin())` before using `enableBroker`."].join(" "));u.broker.nativeBrokerPlugin=l.broker}return u}};var d=r(5136);const h=(0,d.KV)("identity");function logging_formatSuccess(e){return`SUCCESS. Scopes: ${Array.isArray(e)?e.join(", "):e}.`}function logging_formatError(e,t){let r="ERROR.";return(null==e?void 0:e.length)&&(r+=` Scopes: ${Array.isArray(e)?e.join(", "):e}.`),`${r} Error message: ${"string"==typeof t?t:t.message}.`}function credentialLoggerInstance(e,t,r=h){const n=t?`${t.fullTitle} ${e}`:e;return{title:e,fullTitle:n,info:function info(e){r.info(`${n} =>`,e)},warning:function warning(e){r.warning(`${n} =>`,e)},verbose:function verbose(e){r.verbose(`${n} =>`,e)},error:function error(e){r.error(`${n} =>`,e)}}}function credentialLogger(e,t=h){const r=credentialLoggerInstance(e,void 0,t);return Object.assign(Object.assign({},r),{parent:t,getToken:credentialLoggerInstance("=> getToken()",r,t)})}class errors_CredentialUnavailableError extends Error{constructor(e,t){super(e,t),this.name="CredentialUnavailableError"}}const g="AuthenticationError";class errors_AuthenticationError extends Error{constructor(e,t,r){let n={error:"unknown",errorDescription:"An unknown error occurred and no additional details are available."};if(function isErrorResponse(e){return e&&"string"==typeof e.error&&"string"==typeof e.error_description}(t))n=convertOAuthErrorResponseToErrorResponse(t);else if("string"==typeof t)try{n=convertOAuthErrorResponseToErrorResponse(JSON.parse(t))}catch(r){n=400===e?{error:"invalid_request",errorDescription:`The service indicated that the request was invalid.\n\n${t}`}:{error:"unknown_error",errorDescription:`An unknown error has occurred. Response body:\n\n${t}`}}else n={error:"unknown_error",errorDescription:"An unknown error occurred and no additional details are available."};super(`${n.error} Status code: ${e}\nMore details:\n${n.errorDescription},`,r),this.statusCode=e,this.errorResponse=n,this.name=g}}Error;function convertOAuthErrorResponseToErrorResponse(e){return{error:e.error,errorDescription:e.error_description,correlationId:e.correlation_id,errorCodes:e.error_codes,timestamp:e.timestamp,traceId:e.trace_id}}class AuthenticationRequiredError extends Error{constructor(e){super(e.message,e.cause?{cause:e.cause}:void 0),this.scopes=e.scopes,this.getTokenOptions=e.getTokenOptions,this.name="AuthenticationRequiredError"}}function processMultiTenantRequest_processMultiTenantRequest(e,t,r=[],n){var i;let o;if(o=process.env.AZURE_IDENTITY_DISABLE_MULTITENANTAUTH||"adfs"===e?e:null!==(i=null==t?void 0:t.tenantId)&&void 0!==i?i:e,e&&o!==e&&!r.includes("*")&&!r.some((e=>0===e.localeCompare(o)))){const e=function createConfigurationErrorMessage(e){return`The current credential is not configured to acquire tokens for tenant ${e}. To enable acquiring tokens for this tenant add it to the AdditionallyAllowedTenants on the credential options, or add "*" to AdditionallyAllowedTenants to allow acquiring tokens for any tenant.`}(o);throw null==n||n.info(e),new errors_CredentialUnavailableError(e)}return o}function tenantIdUtils_checkTenantId(e,t){if(!t.match(/^[0-9a-zA-Z-.]+$/)){const t=new Error("Invalid tenant id provided. You can locate your tenant id by following the instructions listed here: https://learn.microsoft.com/partner-center/find-ids-and-domain-names.");throw e.info(logging_formatError("",t)),t}}function tenantIdUtils_resolveAdditionallyAllowedTenantIds(e){return e&&0!==e.length?e.includes("*")?s:e:[]}var p=r(99834),f=r(10151),m=r(1965);const y=(0,r(11652).y)({namespace:"Microsoft.AAD",packageName:"@azure/identity",packageVersion:n});function parseExpirationTimestamp(e){if("number"==typeof e.expires_on)return 1e3*e.expires_on;if("string"==typeof e.expires_on){const t=+e.expires_on;if(!isNaN(t))return 1e3*t;const r=Date.parse(e.expires_on);if(!isNaN(r))return r}if("number"==typeof e.expires_in)return Date.now()+1e3*e.expires_in;throw new Error(`Failed to parse token expiration from body. expires_in="${e.expires_in}", expires_on="${e.expires_on}"`)}function parseRefreshTimestamp(e){if(e.refresh_on){if("number"==typeof e.refresh_on)return 1e3*e.refresh_on;if("string"==typeof e.refresh_on){const t=+e.refresh_on;if(!isNaN(t))return 1e3*t;const r=Date.parse(e.refresh_on);if(!isNaN(r))return r}throw new Error(`Failed to parse refresh_on from body. refresh_on="${e.refresh_on}"`)}}const C="noCorrelationId";class identityClient_IdentityClient extends p.ServiceClient{constructor(e){var t,r;const i=`azsdk-js-identity/${n}`,o=(null===(t=null==e?void 0:e.userAgentOptions)||void 0===t?void 0:t.userAgentPrefix)?`${e.userAgentOptions.userAgentPrefix} ${i}`:`${i}`,s=function getIdentityClientAuthorityHost(e){let t=null==e?void 0:e.authorityHost;return f.Ll&&(t=null!=t?t:process.env.AZURE_AUTHORITY_HOST),null!=t?t:a}(e);if(!s.startsWith("https:"))throw new Error("The authorityHost address must use the 'https' protocol.");super(Object.assign(Object.assign({requestContentType:"application/json; charset=utf-8",retryOptions:{maxRetries:3}},e),{userAgentOptions:{userAgentPrefix:o},baseUri:s})),this.allowInsecureConnection=!1,this.authorityHost=s,this.abortControllers=new Map,this.allowLoggingAccountIdentifiers=null===(r=null==e?void 0:e.loggingOptions)||void 0===r?void 0:r.allowLoggingAccountIdentifiers,this.tokenCredentialOptions=Object.assign({},e),(null==e?void 0:e.allowInsecureConnection)&&(this.allowInsecureConnection=e.allowInsecureConnection)}async sendTokenRequest(e){h.info(`IdentityClient: sending token request to [${e.url}]`);const t=await this.sendRequest(e);if(!t.bodyAsText||200!==t.status&&201!==t.status){const e=new errors_AuthenticationError(t.status,t.bodyAsText);throw h.warning(`IdentityClient: authentication error. HTTP status: ${t.status}, ${e.errorResponse.errorDescription}`),e}{const r=JSON.parse(t.bodyAsText);if(!r.access_token)return null;this.logIdentifiers(t);const n={accessToken:{token:r.access_token,expiresOnTimestamp:parseExpirationTimestamp(r),refreshAfterTimestamp:parseRefreshTimestamp(r),tokenType:"Bearer"},refreshToken:r.refresh_token};return h.info(`IdentityClient: [${e.url}] token acquired, expires on ${n.accessToken.expiresOnTimestamp}`),n}}async refreshAccessToken(e,t,r,n,i,o={}){if(void 0===n)return null;h.info(`IdentityClient: refreshing access token with client ID: ${t}, scopes: ${r} started`);const a={grant_type:"refresh_token",client_id:t,refresh_token:n,scope:r};void 0!==i&&(a.client_secret=i);const s=new URLSearchParams(a);return y.withSpan("IdentityClient.refreshAccessToken",o,(async r=>{try{const n=function getIdentityTokenEndpointSuffix(e){return"adfs"===e?"oauth2/token":"oauth2/v2.0/token"}(e),i=(0,m.createPipelineRequest)({url:`${this.authorityHost}/${e}/${n}`,method:"POST",body:s.toString(),abortSignal:o.abortSignal,headers:(0,m.createHttpHeaders)({Accept:"application/json","Content-Type":"application/x-www-form-urlencoded"}),tracingOptions:r.tracingOptions}),a=await this.sendTokenRequest(i);return h.info(`IdentityClient: refreshed token for client ID: ${t}`),a}catch(e){if(e.name===g&&"interaction_required"===e.errorResponse.error)return h.info(`IdentityClient: interaction required for client ID: ${t}`),null;throw h.warning(`IdentityClient: failed refreshing token for client ID: ${t}: ${e}`),e}}))}generateAbortSignal(e){const t=new AbortController,r=this.abortControllers.get(e)||[];r.push(t),this.abortControllers.set(e,r);const n=t.signal.onabort;return t.signal.onabort=(...r)=>{this.abortControllers.set(e,void 0),n&&n.apply(t.signal,r)},t.signal}abortRequests(e){const t=e||C,r=[...this.abortControllers.get(t)||[],...this.abortControllers.get(C)||[]];if(r.length){for(const e of r)e.abort();this.abortControllers.set(t,void 0)}}getCorrelationId(e){var t;const r=null===(t=null==e?void 0:e.body)||void 0===t?void 0:t.split("&").map((e=>e.split("="))).find((([e])=>"client-request-id"===e));return r&&r.length&&r[1]||C}async sendGetRequestAsync(e,t){const r=(0,m.createPipelineRequest)({url:e,method:"GET",body:null==t?void 0:t.body,allowInsecureConnection:this.allowInsecureConnection,headers:(0,m.createHttpHeaders)(null==t?void 0:t.headers),abortSignal:this.generateAbortSignal(C)}),n=await this.sendRequest(r);return this.logIdentifiers(n),{body:n.bodyAsText?JSON.parse(n.bodyAsText):void 0,headers:n.headers.toJSON(),status:n.status}}async sendPostRequestAsync(e,t){const r=(0,m.createPipelineRequest)({url:e,method:"POST",body:null==t?void 0:t.body,headers:(0,m.createHttpHeaders)(null==t?void 0:t.headers),allowInsecureConnection:this.allowInsecureConnection,abortSignal:this.generateAbortSignal(this.getCorrelationId(t))}),n=await this.sendRequest(r);return this.logIdentifiers(n),{body:n.bodyAsText?JSON.parse(n.bodyAsText):void 0,headers:n.headers.toJSON(),status:n.status}}getTokenCredentialOptions(){return this.tokenCredentialOptions}logIdentifiers(e){if(!this.allowLoggingAccountIdentifiers||!e.bodyAsText)return;try{const t=(e.parsedBody||JSON.parse(e.bodyAsText)).access_token;if(!t)return;const r=t.split(".")[1],{appid:n,upn:i,tid:o,oid:a}=JSON.parse(Buffer.from(r,"base64").toString("utf8"));h.info(`[Authenticated account] Client ID: ${n}. Tenant ID: ${o}. User Principal Name: ${i||"No User Principal Name available"}. Object ID (user): ${a}`)}catch(e){h.warning("allowLoggingAccountIdentifiers was set, but we couldn't log the account information. Error:",e.message)}}}r(73024),r(48161),r(76760);credentialLogger("VisualStudioCodeCredential");o.AzurePublicCloud,o.AzureChina,o.AzureGermany,o.AzureGovernment;const A={LIBRARY_NAME:"MSAL.JS",SKU:"msal.js.common",CACHE_PREFIX:"msal",DEFAULT_AUTHORITY:"https://login.microsoftonline.com/common/",DEFAULT_AUTHORITY_HOST:"login.microsoftonline.com",DEFAULT_COMMON_TENANT:"common",ADFS:"adfs",DSTS:"dstsv2",AAD_INSTANCE_DISCOVERY_ENDPT:"https://login.microsoftonline.com/common/discovery/instance?api-version=1.1&authorization_endpoint=",CIAM_AUTH_URL:".ciamlogin.com",AAD_TENANT_DOMAIN_SUFFIX:".onmicrosoft.com",RESOURCE_DELIM:"|",NO_ACCOUNT:"NO_ACCOUNT",CLAIMS:"claims",CONSUMER_UTID:"9188040d-6c67-4c5b-b112-36a304b66dad",OPENID_SCOPE:"openid",PROFILE_SCOPE:"profile",OFFLINE_ACCESS_SCOPE:"offline_access",EMAIL_SCOPE:"email",CODE_RESPONSE_TYPE:"code",CODE_GRANT_TYPE:"authorization_code",RT_GRANT_TYPE:"refresh_token",FRAGMENT_RESPONSE_MODE:"fragment",S256_CODE_CHALLENGE_METHOD:"S256",URL_FORM_CONTENT_TYPE:"application/x-www-form-urlencoded;charset=utf-8",AUTHORIZATION_PENDING:"authorization_pending",NOT_DEFINED:"not_defined",EMPTY_STRING:"",NOT_APPLICABLE:"N/A",NOT_AVAILABLE:"Not Available",FORWARD_SLASH:"/",IMDS_ENDPOINT:"http://169.254.169.254/metadata/instance/compute/location",IMDS_VERSION:"2020-06-01",IMDS_TIMEOUT:2e3,AZURE_REGION_AUTO_DISCOVER_FLAG:"TryAutoDetect",REGIONAL_AUTH_PUBLIC_CLOUD_SUFFIX:"login.microsoft.com",KNOWN_PUBLIC_CLOUDS:["login.microsoftonline.com","login.windows.net","login.microsoft.com","sts.windows.net"],TOKEN_RESPONSE_TYPE:"token",ID_TOKEN_RESPONSE_TYPE:"id_token",SHR_NONCE_VALIDITY:240,INVALID_INSTANCE:"invalid_instance"},T=200,I=200,S=299,v=302,w=400,k=499,E=500,b=500,_=599,R=[A.OPENID_SCOPE,A.PROFILE_SCOPE,A.OFFLINE_ACCESS_SCOPE],O=[...R,A.EMAIL_SCOPE],P="Content-Type",M="Content-Length",N="Retry-After",U="X-AnchorMailbox",q="x-ms-request-id",x="x-ms-httpver",H={COMMON:"common",ORGANIZATIONS:"organizations",CONSUMERS:"consumers"},L="access_token",D="xms_cc",B={LOGIN:"login",SELECT_ACCOUNT:"select_account",CONSENT:"consent",NONE:"none",CREATE:"create",NO_SESSION:"no_session"},F={PLAIN:"plain",S256:"S256"},j={QUERY:"query",FRAGMENT:"fragment",FORM_POST:"form_post"},$="authorization_code",K="client_credentials",z="password",G="refresh_token",V="device_code",Q="urn:ietf:params:oauth:grant-type:jwt-bearer",Y="MSSTS",W="ADFS",J="Generic",Z="-",X=".",ee={ID_TOKEN:"IdToken",ACCESS_TOKEN:"AccessToken",ACCESS_TOKEN_WITH_AUTH_SCHEME:"AccessToken_With_AuthScheme",REFRESH_TOKEN:"RefreshToken"},te="appmetadata",re="1",ne="authority-metadata",ie=86400,oe="config",ae="cache",se="network",ce="hardcoded_values",le={SCHEMA_VERSION:5,MAX_CUR_HEADER_BYTES:80,MAX_LAST_HEADER_BYTES:330,MAX_CACHED_ERRORS:50,CACHE_KEY:"server-telemetry",CATEGORY_SEPARATOR:"|",VALUE_SEPARATOR:",",OVERFLOW_TRUE:"1",OVERFLOW_FALSE:"0",UNKNOWN_ERROR:"unknown_error"},ue={BEARER:"Bearer",POP:"pop",SSH:"ssh-cert"},de=60,he=3600,ge="throttling",pe="retry-after, h429",fe="invalid_grant",me="client_mismatch",ye="username",Ce="password",Ae=200,Te=400,Ie="1",Se="3",ve="4",we="2",ke="4",Ee="5",be="0",_e="1",Re="2",Oe="3",Pe="4",Me="AZURE_POD_IDENTITY_AUTHORITY_HOST",Ne="IDENTITY_ENDPOINT",Ue="IMDS_ENDPOINT",qe="MSI_ENDPOINT",xe="user-assigned-client-id",He="user-assigned-resource-id",Le="user-assigned-object-id",De="get",Be="post",Fe={SUCCESS:T,SUCCESS_RANGE_START:I,SUCCESS_RANGE_END:S,SERVER_ERROR:E},je="sha256",$e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-._~",Ke="msal.js.node",ze="urn:ietf:params:oauth:client-assertion-type:jwt-bearer",Ge="authorization_pending",Ve="http://",Qe="localhost",Ye=62,We=371,Je=671,Ze=771,Xe=871,et=872,tt="RS256",rt="PS256",nt="x5t#S256",it="x5t",ot="x5c",at="aud",st="exp",ct="iss",lt="sub",ut="nbf",dt="jti",ht=100,gt=5e3,pt="unexpected_error",ft="post_request_failed",mt={[pt]:"Unexpected error in authentication.",[ft]:"Post request failed from the network, could be a 4xx/5xx or a network unavailability. Please check the exact error code for details."};class AuthError extends Error{constructor(e,t,r){super(t?`${e}: ${t}`:e),Object.setPrototypeOf(this,AuthError.prototype),this.errorCode=e||A.EMPTY_STRING,this.errorMessage=t||A.EMPTY_STRING,this.subError=r||A.EMPTY_STRING,this.name="AuthError"}setCorrelationId(e){this.correlationId=e}}function makeExtraSkuString(e){const{skus:t,libraryName:r,libraryVersion:n,extensionName:i,extensionVersion:o}=e,a=new Map([[0,[r,n]],[2,[i,o]]]);let s=[];if(t?.length){if(s=t.split(","),s.length<4)return t}else s=Array.from({length:4},(()=>"|"));return a.forEach(((e,t)=>{2===e.length&&e[0]?.length&&e[1]?.length&&function setSku(e){const{skuArr:t,index:r,skuName:n,skuVersion:i}=e;if(r>=t.length)return;t[r]=[n,i].join("|")}({skuArr:s,index:t,skuName:e[0],skuVersion:e[1]})})),s.join(",")}class ServerTelemetryManager{constructor(e,t){this.cacheOutcome=be,this.cacheManager=t,this.apiId=e.apiId,this.correlationId=e.correlationId,this.wrapperSKU=e.wrapperSKU||A.EMPTY_STRING,this.wrapperVer=e.wrapperVer||A.EMPTY_STRING,this.telemetryCacheKey=le.CACHE_KEY+Z+e.clientId}generateCurrentRequestHeaderValue(){const e=`${this.apiId}${le.VALUE_SEPARATOR}${this.cacheOutcome}`,t=[this.wrapperSKU,this.wrapperVer],r=this.getNativeBrokerErrorCode();r?.length&&t.push(`broker_error=${r}`);const n=t.join(le.VALUE_SEPARATOR),i=[e,this.getRegionDiscoveryFields()].join(le.VALUE_SEPARATOR);return[le.SCHEMA_VERSION,i,n].join(le.CATEGORY_SEPARATOR)}generateLastRequestHeaderValue(){const e=this.getLastRequests(),t=ServerTelemetryManager.maxErrorsToSend(e),r=e.failedRequests.slice(0,2*t).join(le.VALUE_SEPARATOR),n=e.errors.slice(0,t).join(le.VALUE_SEPARATOR),i=e.errors.length,o=[i,t<i?le.OVERFLOW_TRUE:le.OVERFLOW_FALSE].join(le.VALUE_SEPARATOR);return[le.SCHEMA_VERSION,e.cacheHits,r,n,o].join(le.CATEGORY_SEPARATOR)}cacheFailedRequest(e){const t=this.getLastRequests();t.errors.length>=le.MAX_CACHED_ERRORS&&(t.failedRequests.shift(),t.failedRequests.shift(),t.errors.shift()),t.failedRequests.push(this.apiId,this.correlationId),e instanceof Error&&e&&e.toString()?e instanceof AuthError?e.subError?t.errors.push(e.subError):e.errorCode?t.errors.push(e.errorCode):t.errors.push(e.toString()):t.errors.push(e.toString()):t.errors.push(le.UNKNOWN_ERROR),this.cacheManager.setServerTelemetry(this.telemetryCacheKey,t)}incrementCacheHits(){const e=this.getLastRequests();return e.cacheHits+=1,this.cacheManager.setServerTelemetry(this.telemetryCacheKey,e),e.cacheHits}getLastRequests(){return this.cacheManager.getServerTelemetry(this.telemetryCacheKey)||{failedRequests:[],errors:[],cacheHits:0}}clearTelemetryCache(){const e=this.getLastRequests(),t=ServerTelemetryManager.maxErrorsToSend(e);if(t===e.errors.length)this.cacheManager.removeItem(this.telemetryCacheKey);else{const r={failedRequests:e.failedRequests.slice(2*t),errors:e.errors.slice(t),cacheHits:0};this.cacheManager.setServerTelemetry(this.telemetryCacheKey,r)}}static maxErrorsToSend(e){let t,r=0,n=0;const i=e.errors.length;for(t=0;t<i;t++){const i=e.failedRequests[2*t]||A.EMPTY_STRING,o=e.failedRequests[2*t+1]||A.EMPTY_STRING,a=e.errors[t]||A.EMPTY_STRING;if(n+=i.toString().length+o.toString().length+a.length+3,!(n<le.MAX_LAST_HEADER_BYTES))break;r+=1}return r}getRegionDiscoveryFields(){const e=[];return e.push(this.regionUsed||A.EMPTY_STRING),e.push(this.regionSource||A.EMPTY_STRING),e.push(this.regionOutcome||A.EMPTY_STRING),e.join(",")}updateRegionDiscoveryMetadata(e){this.regionUsed=e.region_used,this.regionSource=e.region_source,this.regionOutcome=e.region_outcome}setCacheOutcome(e){this.cacheOutcome=e}setNativeBrokerErrorCode(e){const t=this.getLastRequests();t.nativeBrokerErrorCode=e,this.cacheManager.setServerTelemetry(this.telemetryCacheKey,t)}getNativeBrokerErrorCode(){return this.getLastRequests().nativeBrokerErrorCode}clearNativeBrokerErrorCode(){const e=this.getLastRequests();delete e.nativeBrokerErrorCode,this.cacheManager.setServerTelemetry(this.telemetryCacheKey,e)}static makeExtraSkuString(e){return makeExtraSkuString(e)}}const yt="client_id",Ct="redirect_uri",At="response_type",Tt="token_type",It="req_cnf",St="return_spa_code",vt="x-client-xtra-sku",wt="brk_client_id";class ServerError extends AuthError{constructor(e,t,r,n,i){super(e,t,r),this.name="ServerError",this.errorNo=n,this.status=i,Object.setPrototypeOf(this,ServerError.prototype)}}var kt;!function(e){e[e.Error=0]="Error",e[e.Warning=1]="Warning",e[e.Info=2]="Info",e[e.Verbose=3]="Verbose",e[e.Trace=4]="Trace"}(kt||(kt={}));class Logger{constructor(e,t,r){this.level=kt.Info;const n=e||Logger.createDefaultLoggerOptions();this.localCallback=n.loggerCallback||(()=>{}),this.piiLoggingEnabled=n.piiLoggingEnabled||!1,this.level="number"==typeof n.logLevel?n.logLevel:kt.Info,this.correlationId=n.correlationId||A.EMPTY_STRING,this.packageName=t||A.EMPTY_STRING,this.packageVersion=r||A.EMPTY_STRING}static createDefaultLoggerOptions(){return{loggerCallback:()=>{},piiLoggingEnabled:!1,logLevel:kt.Info}}clone(e,t,r){return new Logger({loggerCallback:this.localCallback,piiLoggingEnabled:this.piiLoggingEnabled,logLevel:this.level,correlationId:r||this.correlationId},e,t)}logMessage(e,t){if(t.logLevel>this.level||!this.piiLoggingEnabled&&t.containsPii)return;const r=`${`[${(new Date).toUTCString()}] : [${t.correlationId||this.correlationId||""}]`} : ${this.packageName}@${this.packageVersion} : ${kt[t.logLevel]} - ${e}`;this.executeCallback(t.logLevel,r,t.containsPii||!1)}executeCallback(e,t,r){this.localCallback&&this.localCallback(e,t,r)}error(e,t){this.logMessage(e,{logLevel:kt.Error,containsPii:!1,correlationId:t||A.EMPTY_STRING})}errorPii(e,t){this.logMessage(e,{logLevel:kt.Error,containsPii:!0,correlationId:t||A.EMPTY_STRING})}warning(e,t){this.logMessage(e,{logLevel:kt.Warning,containsPii:!1,correlationId:t||A.EMPTY_STRING})}warningPii(e,t){this.logMessage(e,{logLevel:kt.Warning,containsPii:!0,correlationId:t||A.EMPTY_STRING})}info(e,t){this.logMessage(e,{logLevel:kt.Info,containsPii:!1,correlationId:t||A.EMPTY_STRING})}infoPii(e,t){this.logMessage(e,{logLevel:kt.Info,containsPii:!0,correlationId:t||A.EMPTY_STRING})}verbose(e,t){this.logMessage(e,{logLevel:kt.Verbose,containsPii:!1,correlationId:t||A.EMPTY_STRING})}verbosePii(e,t){this.logMessage(e,{logLevel:kt.Verbose,containsPii:!0,correlationId:t||A.EMPTY_STRING})}trace(e,t){this.logMessage(e,{logLevel:kt.Trace,containsPii:!1,correlationId:t||A.EMPTY_STRING})}tracePii(e,t){this.logMessage(e,{logLevel:kt.Trace,containsPii:!0,correlationId:t||A.EMPTY_STRING})}isPiiLoggingEnabled(){return this.piiLoggingEnabled||!1}}const Et=0,bt=1,_t=2,Rt=3;const Ot="redirect_uri_empty",Pt="claims_request_parsing_error",Mt="authority_uri_insecure",Nt="url_parse_error",Ut="empty_url_error",qt="empty_input_scopes_error",xt="invalid_prompt_value",Ht="invalid_claims",Lt="token_request_empty",Dt="logout_request_empty",Bt="invalid_code_challenge_method",Ft="pkce_params_missing",jt="invalid_cloud_discovery_metadata",$t="invalid_authority_metadata",Kt="untrusted_authority",zt="missing_ssh_jwk",Gt="missing_ssh_kid",Vt="missing_nonce_authentication_header",Qt="invalid_authentication_header",Yt="cannot_set_OIDCOptions",Wt="cannot_allow_platform_broker",Jt="authority_mismatch",Zt={[Ot]:"A redirect URI is required for all calls, and none has been set.",[Pt]:"Could not parse the given claims request object.",[Mt]:"Authority URIs must use https.  Please see here for valid authority configuration options: https://docs.microsoft.com/en-us/azure/active-directory/develop/msal-js-initializing-client-applications#configuration-options",[Nt]:"URL could not be parsed into appropriate segments.",[Ut]:"URL was empty or null.",[qt]:"Scopes cannot be passed as null, undefined or empty array because they are required to obtain an access token.",[xt]:"Please see here for valid configuration options: https://azuread.github.io/microsoft-authentication-library-for-js/ref/modules/_azure_msal_common.html#commonauthorizationurlrequest",[Ht]:"Given claims parameter must be a stringified JSON object.",[Lt]:"Token request was empty and not found in cache.",[Dt]:"The logout request was null or undefined.",[Bt]:'code_challenge_method passed is invalid. Valid values are "plain" and "S256".',[Ft]:"Both params: code_challenge and code_challenge_method are to be passed if to be sent in the request",[jt]:"Invalid cloudDiscoveryMetadata provided. Must be a stringified JSON object containing tenant_discovery_endpoint and metadata fields",[$t]:"Invalid authorityMetadata provided. Must by a stringified JSON object containing authorization_endpoint, token_endpoint, issuer fields.",[Kt]:"The provided authority is not a trusted authority. Please include this authority in the knownAuthorities config parameter.",[zt]:"Missing sshJwk in SSH certificate request. A stringified JSON Web Key is required when using the SSH authentication scheme.",[Gt]:"Missing sshKid in SSH certificate request. A string that uniquely identifies the public SSH key is required when using the SSH authentication scheme.",[Vt]:"Unable to find an authentication header containing server nonce. Either the Authentication-Info or WWW-Authenticate headers must be present in order to obtain a server nonce.",[Qt]:"Invalid authentication header provided",[Yt]:"Cannot set OIDCOptions parameter. Please change the protocol mode to OIDC or use a non-Microsoft authority.",[Wt]:"Cannot set allowPlatformBroker parameter to true when not in AAD protocol mode.",[Jt]:"Authority mismatch error. Authority provided in login request or PublicClientApplication config does not match the environment of the provided account. Please use a matching account or make an interactive request to login to this authority."};class ClientConfigurationError extends AuthError{constructor(e){super(e,Zt[e]),this.name="ClientConfigurationError",Object.setPrototypeOf(this,ClientConfigurationError.prototype)}}function createClientConfigurationError(e){return new ClientConfigurationError(e)}class StringUtils{static isEmptyObj(e){if(e)try{const t=JSON.parse(e);return 0===Object.keys(t).length}catch(e){}return!0}static startsWith(e,t){return 0===e.indexOf(t)}static endsWith(e,t){return e.length>=t.length&&e.lastIndexOf(t)===e.length-t.length}static queryStringToObject(e){const t={},r=e.split("&"),decode=e=>decodeURIComponent(e.replace(/\+/g," "));return r.forEach((e=>{if(e.trim()){const[r,n]=e.split(/=(.+)/g,2);r&&n&&(t[decode(r)]=decode(n))}})),t}static trimArrayEntries(e){return e.map((e=>e.trim()))}static removeEmptyStringsFromArray(e){return e.filter((e=>!!e))}static jsonParseHelper(e){try{return JSON.parse(e)}catch(e){return null}}static matchPattern(e,t){return new RegExp(e.replace(/\\/g,"\\\\").replace(/\*/g,"[^ ]*").replace(/\?/g,"\\?")).test(t)}}const Xt="client_info_decoding_error",er="client_info_empty_error",tr="token_parsing_error",rr="null_or_empty_token",nr="endpoints_resolution_error",ir="network_error",or="openid_config_error",ar="hash_not_deserialized",sr="invalid_state",cr="state_mismatch",lr="state_not_found",ur="nonce_mismatch",dr="auth_time_not_found",hr="max_age_transpired",gr="multiple_matching_tokens",pr="multiple_matching_accounts",fr="multiple_matching_appMetadata",mr="request_cannot_be_made",yr="cannot_remove_empty_scope",Cr="cannot_append_scopeset",Ar="empty_input_scopeset",Tr="device_code_polling_cancelled",Ir="device_code_expired",Sr="device_code_unknown_error",vr="no_account_in_silent_request",wr="invalid_cache_record",kr="invalid_cache_environment",Er="no_account_found",br="no_crypto_object",_r="unexpected_credential_type",Rr="invalid_assertion",Or="invalid_client_credential",Pr="token_refresh_required",Mr="user_timeout_reached",Nr="token_claims_cnf_required_for_signedjwt",Ur="authorization_code_missing_from_server_response",qr="binding_key_not_removed",xr="end_session_endpoint_not_supported",Hr="key_id_missing",Lr="no_network_connectivity",Dr="user_canceled",Br="missing_tenant_id_error",Fr="method_not_implemented",jr="nested_app_auth_bridge_disabled",$r={[Xt]:"The client info could not be parsed/decoded correctly",[er]:"The client info was empty",[tr]:"Token cannot be parsed",[rr]:"The token is null or empty",[nr]:"Endpoints cannot be resolved",[ir]:"Network request failed",[or]:"Could not retrieve endpoints. Check your authority and verify the .well-known/openid-configuration endpoint returns the required endpoints.",[ar]:"The hash parameters could not be deserialized",[sr]:"State was not the expected format",[cr]:"State mismatch error",[lr]:"State not found",[ur]:"Nonce mismatch error",[dr]:"Max Age was requested and the ID token is missing the auth_time variable. auth_time is an optional claim and is not enabled by default - it must be enabled. See https://aka.ms/msaljs/optional-claims for more information.",[hr]:"Max Age is set to 0, or too much time has elapsed since the last end-user authentication.",[gr]:"The cache contains multiple tokens satisfying the requirements. Call AcquireToken again providing more requirements such as authority or account.",[pr]:"The cache contains multiple accounts satisfying the given parameters. Please pass more info to obtain the correct account",[fr]:"The cache contains multiple appMetadata satisfying the given parameters. Please pass more info to obtain the correct appMetadata",[mr]:"Token request cannot be made without authorization code or refresh token.",[yr]:"Cannot remove null or empty scope from ScopeSet",[Cr]:"Cannot append ScopeSet",[Ar]:"Empty input ScopeSet cannot be processed",[Tr]:"Caller has cancelled token endpoint polling during device code flow by setting DeviceCodeRequest.cancel = true.",[Ir]:"Device code is expired.",[Sr]:"Device code stopped polling for unknown reasons.",[vr]:"Please pass an account object, silent flow is not supported without account information",[wr]:"Cache record object was null or undefined.",[kr]:"Invalid environment when attempting to create cache entry",[Er]:"No account found in cache for given key.",[br]:"No crypto object detected.",[_r]:"Unexpected credential type.",[Rr]:"Client assertion must meet requirements described in https://tools.ietf.org/html/rfc7515",[Or]:"Client credential (secret, certificate, or assertion) must not be empty when creating a confidential client. An application should at most have one credential",[Pr]:"Cannot return token from cache because it must be refreshed. This may be due to one of the following reasons: forceRefresh parameter is set to true, claims have been requested, there is no cached access token or it is expired.",[Mr]:"User defined timeout for device code polling reached",[Nr]:"Cannot generate a POP jwt if the token_claims are not populated",[Ur]:"Server response does not contain an authorization code to proceed",[qr]:"Could not remove the credential's binding key from storage.",[xr]:"The provided authority does not support logout",[Hr]:"A keyId value is missing from the requested bound token's cache record and is required to match the token to it's stored binding key.",[Lr]:"No network connectivity. Check your internet connection.",[Dr]:"User cancelled the flow.",[Br]:"A tenant id - not common, organizations, or consumers - must be specified when using the client_credentials flow.",[Fr]:"This method has not been implemented",[jr]:"The nested app auth bridge is disabled"};class ClientAuthError extends AuthError{constructor(e,t){super(e,t?`${$r[e]}: ${t}`:$r[e]),this.name="ClientAuthError",Object.setPrototypeOf(this,ClientAuthError.prototype)}}function createClientAuthError(e,t){return new ClientAuthError(e,t)}function getDeserializedResponse(e){if(!e||e.indexOf("=")<0)return null;try{const t=function stripLeadingHashOrQuery(e){return e.startsWith("#/")?e.substring(2):e.startsWith("#")||e.startsWith("?")?e.substring(1):e}(e),r=Object.fromEntries(new URLSearchParams(t));if(r.code||r.error||r.error_description||r.state)return r}catch(e){throw createClientAuthError(ar)}return null}class UrlString{get urlString(){return this._urlString}constructor(e){if(this._urlString=e,!this._urlString)throw createClientConfigurationError(Ut);e.includes("#")||(this._urlString=UrlString.canonicalizeUri(e))}static canonicalizeUri(e){if(e){let t=e.toLowerCase();return StringUtils.endsWith(t,"?")?t=t.slice(0,-1):StringUtils.endsWith(t,"?/")&&(t=t.slice(0,-2)),StringUtils.endsWith(t,"/")||(t+="/"),t}return e}validateAsUri(){let e;try{e=this.getUrlComponents()}catch(e){throw createClientConfigurationError(Nt)}if(!e.HostNameAndPort||!e.PathSegments)throw createClientConfigurationError(Nt);if(!e.Protocol||"https:"!==e.Protocol.toLowerCase())throw createClientConfigurationError(Mt)}static appendQueryString(e,t){return t?e.indexOf("?")<0?`${e}?${t}`:`${e}&${t}`:e}static removeHashFromUrl(e){return UrlString.canonicalizeUri(e.split("#")[0])}replaceTenantPath(e){const t=this.getUrlComponents(),r=t.PathSegments;return!e||0===r.length||r[0]!==H.COMMON&&r[0]!==H.ORGANIZATIONS||(r[0]=e),UrlString.constructAuthorityUriFromObject(t)}getUrlComponents(){const e=RegExp("^(([^:/?#]+):)?(//([^/?#]*))?([^?#]*)(\\?([^#]*))?(#(.*))?"),t=this.urlString.match(e);if(!t)throw createClientConfigurationError(Nt);const r={Protocol:t[1],HostNameAndPort:t[4],AbsolutePath:t[5],QueryString:t[7]};let n=r.AbsolutePath.split("/");return n=n.filter((e=>e&&e.length>0)),r.PathSegments=n,r.QueryString&&r.QueryString.endsWith("/")&&(r.QueryString=r.QueryString.substring(0,r.QueryString.length-1)),r}static getDomainFromUrl(e){const t=RegExp("^([^:/?#]+://)?([^/?#]*)"),r=e.match(t);if(!r)throw createClientConfigurationError(Nt);return r[2]}static getAbsoluteUrl(e,t){if(e[0]===A.FORWARD_SLASH){const r=new UrlString(t).getUrlComponents();return r.Protocol+"//"+r.HostNameAndPort+e}return e}static constructAuthorityUriFromObject(e){return new UrlString(e.Protocol+"//"+e.HostNameAndPort+"/"+e.PathSegments.join("/"))}static hashContainsKnownProperties(e){return!!getDeserializedResponse(e)}}const Kr={"login.microsoftonline.com":{token_endpoint:"https://login.microsoftonline.com/{tenantid}/oauth2/v2.0/token",jwks_uri:"https://login.microsoftonline.com/{tenantid}/discovery/v2.0/keys",issuer:"https://login.microsoftonline.com/{tenantid}/v2.0",authorization_endpoint:"https://login.microsoftonline.com/{tenantid}/oauth2/v2.0/authorize",end_session_endpoint:"https://login.microsoftonline.com/{tenantid}/oauth2/v2.0/logout"},"login.chinacloudapi.cn":{token_endpoint:"https://login.chinacloudapi.cn/{tenantid}/oauth2/v2.0/token",jwks_uri:"https://login.chinacloudapi.cn/{tenantid}/discovery/v2.0/keys",issuer:"https://login.partner.microsoftonline.cn/{tenantid}/v2.0",authorization_endpoint:"https://login.chinacloudapi.cn/{tenantid}/oauth2/v2.0/authorize",end_session_endpoint:"https://login.chinacloudapi.cn/{tenantid}/oauth2/v2.0/logout"},"login.microsoftonline.us":{token_endpoint:"https://login.microsoftonline.us/{tenantid}/oauth2/v2.0/token",jwks_uri:"https://login.microsoftonline.us/{tenantid}/discovery/v2.0/keys",issuer:"https://login.microsoftonline.us/{tenantid}/v2.0",authorization_endpoint:"https://login.microsoftonline.us/{tenantid}/oauth2/v2.0/authorize",end_session_endpoint:"https://login.microsoftonline.us/{tenantid}/oauth2/v2.0/logout"}},zr={tenant_discovery_endpoint:"https://{canonicalAuthority}/v2.0/.well-known/openid-configuration",metadata:[{preferred_network:"login.microsoftonline.com",preferred_cache:"login.windows.net",aliases:["login.microsoftonline.com","login.windows.net","login.microsoft.com","sts.windows.net"]},{preferred_network:"login.partner.microsoftonline.cn",preferred_cache:"login.partner.microsoftonline.cn",aliases:["login.partner.microsoftonline.cn","login.chinacloudapi.cn"]},{preferred_network:"login.microsoftonline.de",preferred_cache:"login.microsoftonline.de",aliases:["login.microsoftonline.de"]},{preferred_network:"login.microsoftonline.us",preferred_cache:"login.microsoftonline.us",aliases:["login.microsoftonline.us","login.usgovcloudapi.net"]},{preferred_network:"login-us.microsoftonline.com",preferred_cache:"login-us.microsoftonline.com",aliases:["login-us.microsoftonline.com"]}]},Gr=new Set;function getAliasesFromMetadata(e,t,r,n){if(n?.trace(`getAliasesFromMetadata called with source: ${r}`),e&&t){const i=getCloudDiscoveryMetadataFromNetworkResponse(t,e);if(i)return n?.trace(`getAliasesFromMetadata: found cloud discovery metadata in ${r}, returning aliases`),i.aliases;n?.trace(`getAliasesFromMetadata: did not find cloud discovery metadata in ${r}`)}return null}function getCloudDiscoveryMetadataFromNetworkResponse(e,t){for(let r=0;r<e.length;r++){const n=e[r];if(n.aliases.includes(t))return n}return null}zr.metadata.forEach((e=>{e.aliases.forEach((e=>{Gr.add(e)}))}));const Vr="AAD",Qr="OIDC",Yr="none";const Wr="networkClientSendPostRequestAsync",Jr="refreshTokenClientExecutePostToTokenEndpoint",Zr="authorizationCodeClientExecutePostToTokenEndpoint",Xr="refreshTokenClientExecuteTokenRequest",en="refreshTokenClientAcquireToken",tn="refreshTokenClientAcquireTokenWithCachedRefreshToken",rn="refreshTokenClientAcquireTokenByRefreshToken",nn="refreshTokenClientCreateTokenRequestBody",on="silentFlowClientAcquireCachedToken",an="silentFlowClientGenerateResultFromCacheRecord",sn="getAuthCodeUrl",cn="updateTokenEndpointAuthority",ln="authClientAcquireToken",un="authClientExecuteTokenRequest",dn="authClientCreateTokenRequestBody",hn="authClientCreateQueryString",gn="popTokenGenerateCnf",pn="popTokenGenerateKid",fn="handleServerTokenResponse",mn="authorityFactoryCreateDiscoveredInstance",yn="authorityResolveEndpointsAsync",Cn="authorityGetCloudDiscoveryMetadataFromNetwork",An="authorityUpdateCloudDiscoveryMetadata",Tn="authorityGetEndpointMetadataFromNetwork",In="authorityUpdateEndpointMetadata",Sn="authorityUpdateMetadataWithRegionalInformation",vn="regionDiscoveryDetectRegion",wn="regionDiscoveryGetRegionFromIMDS",kn="regionDiscoveryGetCurrentVersion",En="cacheManagerGetRefreshToken",bn=(new Map([["acquireTokenByCode","ATByCode"],["acquireTokenByRefreshToken","ATByRT"],["acquireTokenSilent","ATS"],["acquireTokenSilentAsync","ATSAsync"],["acquireTokenPopup","ATPopup"],["acquireTokenRedirect","ATRedirect"],["cryptoOptsGetPublicKeyThumbprint","CryptoGetPKThumb"],["cryptoOptsSignJwt","CryptoSignJwt"],["silentCacheClientAcquireToken","SltCacheClientAT"],["silentIframeClientAcquireToken","SltIframeClientAT"],["silentRefreshClientAcquireToken","SltRClientAT"],["ssoSilent","SsoSlt"],["standardInteractionClientGetDiscoveredAuthority","StdIntClientGetDiscAuth"],["fetchAccountIdWithNativeBroker","FetchAccIdWithNtvBroker"],["nativeInteractionClientAcquireToken","NtvIntClientAT"],["baseClientCreateTokenRequestHeaders","BaseClientCreateTReqHead"],[Wr,"NetClientSendPost"],[Jr,"RTClientExecPost"],[Zr,"AuthCodeClientExecPost"],["brokerHandshake","BrokerHandshake"],["acquireTokenByRefreshTokenInBroker","ATByRTInBroker"],["acquireTokenByBroker","ATByBroker"],[Xr,"RTClientExecTReq"],[en,"RTClientAT"],[tn,"RTClientATWithCachedRT"],[rn,"RTClientATByRT"],[nn,"RTClientCreateTReqBody"],["acquireTokenFromCache","ATFromCache"],[on,"SltFlowClientATCached"],[an,"SltFlowClientGenResFromCache"],["acquireTokenBySilentIframe","ATBySltIframe"],["initializeBaseRequest","InitBaseReq"],["initializeSilentRequest","InitSltReq"],["initializeClientApplication","InitClientApplication"],["initializeCache","InitCache"],["importExistingCache","importCache"],["setUserData","setUserData"],["localStorageUpdated","localStorageUpdated"],["silentIframeClientTokenHelper","SIClientTHelper"],["silentHandlerInitiateAuthRequest","SHandlerInitAuthReq"],["silentHandlerMonitorIframeForHash","SltHandlerMonitorIframeForHash"],["silentHandlerLoadFrame","SHandlerLoadFrame"],["silentHandlerLoadFrameSync","SHandlerLoadFrameSync"],["standardInteractionClientCreateAuthCodeClient","StdIntClientCreateAuthCodeClient"],["standardInteractionClientGetClientConfiguration","StdIntClientGetClientConf"],["standardInteractionClientInitializeAuthorizationRequest","StdIntClientInitAuthReq"],["standardInteractionClientInitializeAuthorizationCodeRequest","StdIntClientInitAuthCodeReq"],[sn,"GetAuthCodeUrl"],["handleCodeResponseFromServer","HandleCodeResFromServer"],["handleCodeResponse","HandleCodeResp"],[cn,"UpdTEndpointAuth"],[ln,"AuthClientAT"],[un,"AuthClientExecTReq"],[dn,"AuthClientCreateTReqBody"],[hn,"AuthClientCreateQueryStr"],[gn,"PopTGenCnf"],[pn,"PopTGenKid"],[fn,"HandleServerTRes"],["deserializeResponse","DeserializeRes"],[mn,"AuthFactCreateDiscInst"],[yn,"AuthResolveEndpointsAsync"],["authorityResolveEndpointsFromLocalSources","AuthResolveEndpointsFromLocal"],[Cn,"AuthGetCDMetaFromNet"],[An,"AuthUpdCDMeta"],[Tn,"AuthUpdCDMetaFromNet"],[In,"AuthUpdEndpointMeta"],[Sn,"AuthUpdMetaWithRegInfo"],[vn,"RegDiscDetectReg"],[wn,"RegDiscGetRegFromIMDS"],[kn,"RegDiscGetCurrentVer"],["acquireTokenByCodeAsync","ATByCodeAsync"],["getEndpointMetadataFromNetwork","GetEndpointMetaFromNet"],["getCloudDiscoveryMetadataFromNetworkMeasurement","GetCDMetaFromNet"],["handleRedirectPromise","HandleRedirectPromise"],["handleNativeRedirectPromise","HandleNtvRedirectPromise"],["updateCloudDiscoveryMetadataMeasurement","UpdateCDMeta"],["usernamePasswordClientAcquireToken","UserPassClientAT"],["nativeMessageHandlerHandshake","NtvMsgHandlerHandshake"],["nativeGenerateAuthResult","NtvGenAuthRes"],["removeHiddenIframe","RemoveHiddenIframe"],["clearTokensAndKeysWithClaims","ClearTAndKeysWithClaims"],[En,"CacheManagerGetRT"],["generatePkceCodes","GenPkceCodes"],["generateCodeVerifier","GenCodeVerifier"],["generateCodeChallengeFromVerifier","GenCodeChallengeFromVerifier"],["sha256Digest","Sha256Digest"],["getRandomValues","GetRandomValues"],["generateHKDF","genHKDF"],["generateBaseKey","genBaseKey"],["base64Decode","b64Decode"],["urlEncodeArr","urlEncArr"],["encrypt","encrypt"],["decrypt","decrypt"]]),new Set(["accessTokenSize","durationMs","idTokenSize","matsSilentStatus","matsHttpStatus","refreshTokenSize","queuedTimeMs","startTimeMs","status","multiMatchedAT","multiMatchedID","multiMatchedRT","unencryptedCacheCount","encryptedCacheExpiredCount"]),(e,t,r,n,i)=>(...o)=>{r.trace(`Executing function ${t}`);const a=n?.startMeasurement(t,i);if(i){const e=t+"CallCount";n?.incrementFields({[e]:1},i)}return n?.setPreQueueTime(t,i),e(...o).then((e=>(r.trace(`Returning result from ${t}`),a?.end({success:!0}),e))).catch((e=>{r.trace(`Error occurred in ${t}`);try{r.trace(JSON.stringify(e))}catch(e){r.trace("Unable to print error message.")}throw a?.end({success:!1},e),e}))});class RegionDiscovery{constructor(e,t,r,n){this.networkInterface=e,this.logger=t,this.performanceClient=r,this.correlationId=n}async detectRegion(e,t){this.performanceClient?.addQueueMeasurement(vn,this.correlationId);let r=e;if(r)t.region_source=Se;else{const e=RegionDiscovery.IMDS_OPTIONS;try{const n=await bn(this.getRegionFromIMDS.bind(this),wn,this.logger,this.performanceClient,this.correlationId)(A.IMDS_VERSION,e);if(n.status===Ae&&(r=n.body,t.region_source=ve),n.status===Te){const n=await bn(this.getCurrentVersion.bind(this),kn,this.logger,this.performanceClient,this.correlationId)(e);if(!n)return t.region_source=Ie,null;const i=await bn(this.getRegionFromIMDS.bind(this),wn,this.logger,this.performanceClient,this.correlationId)(n,e);i.status===Ae&&(r=i.body,t.region_source=ve)}}catch(e){return t.region_source=Ie,null}}return r||(t.region_source=Ie),r||null}async getRegionFromIMDS(e,t){return this.performanceClient?.addQueueMeasurement(wn,this.correlationId),this.networkInterface.sendGetRequestAsync(`${A.IMDS_ENDPOINT}?api-version=${e}&format=text`,t,A.IMDS_TIMEOUT)}async getCurrentVersion(e){this.performanceClient?.addQueueMeasurement(kn,this.correlationId);try{const t=await this.networkInterface.sendGetRequestAsync(`${A.IMDS_ENDPOINT}?format=json`,e);return t.status===Te&&t.body&&t.body["newest-versions"]&&t.body["newest-versions"].length>0?t.body["newest-versions"][0]:null}catch(e){return null}}}function extractTokenClaims(e,t){const r=function getJWSPayload(e){if(!e)throw createClientAuthError(rr);const t=/^([^\.\s]*)\.([^\.\s]+)\.([^\.\s]*)$/.exec(e);if(!t||t.length<4)throw createClientAuthError(tr);return t[2]}(e);try{const e=t(r);return JSON.parse(e)}catch(e){throw createClientAuthError(tr)}}function checkMaxAge(e,t){if(0===t||Date.now()-3e5>e+t)throw createClientAuthError(hr)}function nowSeconds(){return Math.round((new Date).getTime()/1e3)}function toDateFromSeconds(e){return e?new Date(1e3*Number(e)):new Date}function isTokenExpired(e,t){const r=Number(e)||0;return nowSeconds()+t>r}function delay(e,t){return new Promise((r=>setTimeout((()=>r(t)),e)))}function generateCredentialKey(e){return[generateAccountId(e),generateCredentialId(e),generateTarget(e),generateClaimsHash(e),generateScheme(e)].join(Z).toLowerCase()}function isCredentialEntity(e){return e.hasOwnProperty("homeAccountId")&&e.hasOwnProperty("environment")&&e.hasOwnProperty("credentialType")&&e.hasOwnProperty("clientId")&&e.hasOwnProperty("secret")}function isAccessTokenEntity(e){return!!e&&(isCredentialEntity(e)&&e.hasOwnProperty("realm")&&e.hasOwnProperty("target")&&(e.credentialType===ee.ACCESS_TOKEN||e.credentialType===ee.ACCESS_TOKEN_WITH_AUTH_SCHEME))}function isIdTokenEntity(e){return!!e&&(isCredentialEntity(e)&&e.hasOwnProperty("realm")&&e.credentialType===ee.ID_TOKEN)}function isRefreshTokenEntity(e){return!!e&&(isCredentialEntity(e)&&e.credentialType===ee.REFRESH_TOKEN)}function generateAccountId(e){return[e.homeAccountId,e.environment].join(Z).toLowerCase()}function generateCredentialId(e){const t=e.credentialType===ee.REFRESH_TOKEN&&e.familyId||e.clientId;return[e.credentialType,t,e.realm||""].join(Z).toLowerCase()}function generateTarget(e){return(e.target||"").toLowerCase()}function generateClaimsHash(e){return(e.requestedClaimsHash||"").toLowerCase()}function generateScheme(e){return e.tokenType&&e.tokenType.toLowerCase()!==ue.BEARER.toLowerCase()?e.tokenType.toLowerCase():""}function isAppMetadataEntity(e,t){return!!t&&(0===e.indexOf(te)&&t.hasOwnProperty("clientId")&&t.hasOwnProperty("environment"))}function generateAuthorityMetadataExpiresAt(){return nowSeconds()+ie}function updateAuthorityEndpointMetadata(e,t,r){e.authorization_endpoint=t.authorization_endpoint,e.token_endpoint=t.token_endpoint,e.end_session_endpoint=t.end_session_endpoint,e.issuer=t.issuer,e.endpointsFromNetwork=r,e.jwks_uri=t.jwks_uri}function updateCloudDiscoveryMetadata(e,t,r){e.aliases=t.aliases,e.preferred_cache=t.preferred_cache,e.preferred_network=t.preferred_network,e.aliasesFromNetwork=r}function isAuthorityMetadataExpired(e){return e.expiresAt<=nowSeconds()}RegionDiscovery.IMDS_OPTIONS={headers:{Metadata:"true"}};class Authority{constructor(e,t,r,n,i,o,a,s){this.canonicalAuthority=e,this._canonicalAuthority.validateAsUri(),this.networkInterface=t,this.cacheManager=r,this.authorityOptions=n,this.regionDiscoveryMetadata={region_used:void 0,region_source:void 0,region_outcome:void 0},this.logger=i,this.performanceClient=a,this.correlationId=o,this.managedIdentity=s||!1,this.regionDiscovery=new RegionDiscovery(t,this.logger,this.performanceClient,this.correlationId)}getAuthorityType(e){if(e.HostNameAndPort.endsWith(A.CIAM_AUTH_URL))return Rt;const t=e.PathSegments;if(t.length)switch(t[0].toLowerCase()){case A.ADFS:return bt;case A.DSTS:return _t}return Et}get authorityType(){return this.getAuthorityType(this.canonicalAuthorityUrlComponents)}get protocolMode(){return this.authorityOptions.protocolMode}get options(){return this.authorityOptions}get canonicalAuthority(){return this._canonicalAuthority.urlString}set canonicalAuthority(e){this._canonicalAuthority=new UrlString(e),this._canonicalAuthority.validateAsUri(),this._canonicalAuthorityUrlComponents=null}get canonicalAuthorityUrlComponents(){return this._canonicalAuthorityUrlComponents||(this._canonicalAuthorityUrlComponents=this._canonicalAuthority.getUrlComponents()),this._canonicalAuthorityUrlComponents}get hostnameAndPort(){return this.canonicalAuthorityUrlComponents.HostNameAndPort.toLowerCase()}get tenant(){return this.canonicalAuthorityUrlComponents.PathSegments[0]}get authorizationEndpoint(){if(this.discoveryComplete())return this.replacePath(this.metadata.authorization_endpoint);throw createClientAuthError(nr)}get tokenEndpoint(){if(this.discoveryComplete())return this.replacePath(this.metadata.token_endpoint);throw createClientAuthError(nr)}get deviceCodeEndpoint(){if(this.discoveryComplete())return this.replacePath(this.metadata.token_endpoint.replace("/token","/devicecode"));throw createClientAuthError(nr)}get endSessionEndpoint(){if(this.discoveryComplete()){if(!this.metadata.end_session_endpoint)throw createClientAuthError(xr);return this.replacePath(this.metadata.end_session_endpoint)}throw createClientAuthError(nr)}get selfSignedJwtAudience(){if(this.discoveryComplete())return this.replacePath(this.metadata.issuer);throw createClientAuthError(nr)}get jwksUri(){if(this.discoveryComplete())return this.replacePath(this.metadata.jwks_uri);throw createClientAuthError(nr)}canReplaceTenant(e){return 1===e.PathSegments.length&&!Authority.reservedTenantDomains.has(e.PathSegments[0])&&this.getAuthorityType(e)===Et&&this.protocolMode===Vr}replaceTenant(e){return e.replace(/{tenant}|{tenantid}/g,this.tenant)}replacePath(e){let t=e;const r=new UrlString(this.metadata.canonical_authority).getUrlComponents(),n=r.PathSegments;return this.canonicalAuthorityUrlComponents.PathSegments.forEach(((e,i)=>{let o=n[i];if(0===i&&this.canReplaceTenant(r)){const e=new UrlString(this.metadata.authorization_endpoint).getUrlComponents().PathSegments[0];o!==e&&(this.logger.verbose(`Replacing tenant domain name ${o} with id ${e}`),o=e)}e!==o&&(t=t.replace(`/${o}/`,`/${e}/`))})),this.replaceTenant(t)}get defaultOpenIdConfigurationEndpoint(){const e=this.hostnameAndPort;return this.canonicalAuthority.endsWith("v2.0/")||this.authorityType===bt||this.protocolMode!==Vr&&!this.isAliasOfKnownMicrosoftAuthority(e)?`${this.canonicalAuthority}.well-known/openid-configuration`:`${this.canonicalAuthority}v2.0/.well-known/openid-configuration`}discoveryComplete(){return!!this.metadata}async resolveEndpointsAsync(){this.performanceClient?.addQueueMeasurement(yn,this.correlationId);const e=this.getCurrentMetadataEntity(),t=await bn(this.updateCloudDiscoveryMetadata.bind(this),An,this.logger,this.performanceClient,this.correlationId)(e);this.canonicalAuthority=this.canonicalAuthority.replace(this.hostnameAndPort,e.preferred_network);const r=await bn(this.updateEndpointMetadata.bind(this),In,this.logger,this.performanceClient,this.correlationId)(e);this.updateCachedMetadata(e,t,{source:r}),this.performanceClient?.addFields({cloudDiscoverySource:t,authorityEndpointSource:r},this.correlationId)}getCurrentMetadataEntity(){let e=this.cacheManager.getAuthorityMetadataByAlias(this.hostnameAndPort);return e||(e={aliases:[],preferred_cache:this.hostnameAndPort,preferred_network:this.hostnameAndPort,canonical_authority:this.canonicalAuthority,authorization_endpoint:"",token_endpoint:"",end_session_endpoint:"",issuer:"",aliasesFromNetwork:!1,endpointsFromNetwork:!1,expiresAt:generateAuthorityMetadataExpiresAt(),jwks_uri:""}),e}updateCachedMetadata(e,t,r){t!==ae&&r?.source!==ae&&(e.expiresAt=generateAuthorityMetadataExpiresAt(),e.canonical_authority=this.canonicalAuthority);const n=this.cacheManager.generateAuthorityMetadataCacheKey(e.preferred_cache);this.cacheManager.setAuthorityMetadata(n,e),this.metadata=e}async updateEndpointMetadata(e){this.performanceClient?.addQueueMeasurement(In,this.correlationId);const t=this.updateEndpointMetadataFromLocalSources(e);if(t){if(t.source===ce&&this.authorityOptions.azureRegionConfiguration?.azureRegion&&t.metadata){updateAuthorityEndpointMetadata(e,await bn(this.updateMetadataWithRegionalInformation.bind(this),Sn,this.logger,this.performanceClient,this.correlationId)(t.metadata),!1),e.canonical_authority=this.canonicalAuthority}return t.source}let r=await bn(this.getEndpointMetadataFromNetwork.bind(this),Tn,this.logger,this.performanceClient,this.correlationId)();if(r)return this.authorityOptions.azureRegionConfiguration?.azureRegion&&(r=await bn(this.updateMetadataWithRegionalInformation.bind(this),Sn,this.logger,this.performanceClient,this.correlationId)(r)),updateAuthorityEndpointMetadata(e,r,!0),se;throw createClientAuthError(or,this.defaultOpenIdConfigurationEndpoint)}updateEndpointMetadataFromLocalSources(e){this.logger.verbose("Attempting to get endpoint metadata from authority configuration");const t=this.getEndpointMetadataFromConfig();if(t)return this.logger.verbose("Found endpoint metadata in authority configuration"),updateAuthorityEndpointMetadata(e,t,!1),{source:oe};if(this.logger.verbose("Did not find endpoint metadata in the config... Attempting to get endpoint metadata from the hardcoded values."),this.authorityOptions.skipAuthorityMetadataCache)this.logger.verbose("Skipping hardcoded metadata cache since skipAuthorityMetadataCache is set to true. Attempting to get endpoint metadata from the network metadata cache.");else{const t=this.getEndpointMetadataFromHardcodedValues();if(t)return updateAuthorityEndpointMetadata(e,t,!1),{source:ce,metadata:t};this.logger.verbose("Did not find endpoint metadata in hardcoded values... Attempting to get endpoint metadata from the network metadata cache.")}const r=isAuthorityMetadataExpired(e);return this.isAuthoritySameType(e)&&e.endpointsFromNetwork&&!r?(this.logger.verbose("Found endpoint metadata in the cache."),{source:ae}):(r&&this.logger.verbose("The metadata entity is expired."),null)}isAuthoritySameType(e){return new UrlString(e.canonical_authority).getUrlComponents().PathSegments.length===this.canonicalAuthorityUrlComponents.PathSegments.length}getEndpointMetadataFromConfig(){if(this.authorityOptions.authorityMetadata)try{return JSON.parse(this.authorityOptions.authorityMetadata)}catch(e){throw createClientConfigurationError($t)}return null}async getEndpointMetadataFromNetwork(){this.performanceClient?.addQueueMeasurement(Tn,this.correlationId);const e={},t=this.defaultOpenIdConfigurationEndpoint;this.logger.verbose(`Authority.getEndpointMetadataFromNetwork: attempting to retrieve OAuth endpoints from ${t}`);try{const r=await this.networkInterface.sendGetRequestAsync(t,e),n=function isOpenIdConfigResponse(e){return e.hasOwnProperty("authorization_endpoint")&&e.hasOwnProperty("token_endpoint")&&e.hasOwnProperty("issuer")&&e.hasOwnProperty("jwks_uri")}(r.body);return n?r.body:(this.logger.verbose("Authority.getEndpointMetadataFromNetwork: could not parse response as OpenID configuration"),null)}catch(e){return this.logger.verbose(`Authority.getEndpointMetadataFromNetwork: ${e}`),null}}getEndpointMetadataFromHardcodedValues(){return this.hostnameAndPort in Kr?Kr[this.hostnameAndPort]:null}async updateMetadataWithRegionalInformation(e){this.performanceClient?.addQueueMeasurement(Sn,this.correlationId);const t=this.authorityOptions.azureRegionConfiguration?.azureRegion;if(t){if(t!==A.AZURE_REGION_AUTO_DISCOVER_FLAG)return this.regionDiscoveryMetadata.region_outcome=we,this.regionDiscoveryMetadata.region_used=t,Authority.replaceWithRegionalInformation(e,t);const r=await bn(this.regionDiscovery.detectRegion.bind(this.regionDiscovery),vn,this.logger,this.performanceClient,this.correlationId)(this.authorityOptions.azureRegionConfiguration?.environmentRegion,this.regionDiscoveryMetadata);if(r)return this.regionDiscoveryMetadata.region_outcome=ke,this.regionDiscoveryMetadata.region_used=r,Authority.replaceWithRegionalInformation(e,r);this.regionDiscoveryMetadata.region_outcome=Ee}return e}async updateCloudDiscoveryMetadata(e){this.performanceClient?.addQueueMeasurement(An,this.correlationId);const t=this.updateCloudDiscoveryMetadataFromLocalSources(e);if(t)return t;const r=await bn(this.getCloudDiscoveryMetadataFromNetwork.bind(this),Cn,this.logger,this.performanceClient,this.correlationId)();if(r)return updateCloudDiscoveryMetadata(e,r,!0),se;throw createClientConfigurationError(Kt)}updateCloudDiscoveryMetadataFromLocalSources(e){this.logger.verbose("Attempting to get cloud discovery metadata  from authority configuration"),this.logger.verbosePii(`Known Authorities: ${this.authorityOptions.knownAuthorities||A.NOT_APPLICABLE}`),this.logger.verbosePii(`Authority Metadata: ${this.authorityOptions.authorityMetadata||A.NOT_APPLICABLE}`),this.logger.verbosePii(`Canonical Authority: ${e.canonical_authority||A.NOT_APPLICABLE}`);const t=this.getCloudDiscoveryMetadataFromConfig();if(t)return this.logger.verbose("Found cloud discovery metadata in authority configuration"),updateCloudDiscoveryMetadata(e,t,!1),oe;if(this.logger.verbose("Did not find cloud discovery metadata in the config... Attempting to get cloud discovery metadata from the hardcoded values."),this.options.skipAuthorityMetadataCache)this.logger.verbose("Skipping hardcoded cloud discovery metadata cache since skipAuthorityMetadataCache is set to true. Attempting to get cloud discovery metadata from the network metadata cache.");else{const t=function getCloudDiscoveryMetadataFromHardcodedValues(e){return getCloudDiscoveryMetadataFromNetworkResponse(zr.metadata,e)}(this.hostnameAndPort);if(t)return this.logger.verbose("Found cloud discovery metadata from hardcoded values."),updateCloudDiscoveryMetadata(e,t,!1),ce;this.logger.verbose("Did not find cloud discovery metadata in hardcoded values... Attempting to get cloud discovery metadata from the network metadata cache.")}const r=isAuthorityMetadataExpired(e);return this.isAuthoritySameType(e)&&e.aliasesFromNetwork&&!r?(this.logger.verbose("Found cloud discovery metadata in the cache."),ae):(r&&this.logger.verbose("The metadata entity is expired."),null)}getCloudDiscoveryMetadataFromConfig(){if(this.authorityType===Rt)return this.logger.verbose("CIAM authorities do not support cloud discovery metadata, generate the aliases from authority host."),Authority.createCloudDiscoveryMetadataFromHost(this.hostnameAndPort);if(this.authorityOptions.cloudDiscoveryMetadata){this.logger.verbose("The cloud discovery metadata has been provided as a network response, in the config.");try{this.logger.verbose("Attempting to parse the cloud discovery metadata.");const e=getCloudDiscoveryMetadataFromNetworkResponse(JSON.parse(this.authorityOptions.cloudDiscoveryMetadata).metadata,this.hostnameAndPort);if(this.logger.verbose("Parsed the cloud discovery metadata."),e)return this.logger.verbose("There is returnable metadata attached to the parsed cloud discovery metadata."),e;this.logger.verbose("There is no metadata attached to the parsed cloud discovery metadata.")}catch(e){throw this.logger.verbose("Unable to parse the cloud discovery metadata. Throwing Invalid Cloud Discovery Metadata Error."),createClientConfigurationError(jt)}}return this.isInKnownAuthorities()?(this.logger.verbose("The host is included in knownAuthorities. Creating new cloud discovery metadata from the host."),Authority.createCloudDiscoveryMetadataFromHost(this.hostnameAndPort)):null}async getCloudDiscoveryMetadataFromNetwork(){this.performanceClient?.addQueueMeasurement(Cn,this.correlationId);const e=`${A.AAD_INSTANCE_DISCOVERY_ENDPT}${this.canonicalAuthority}oauth2/v2.0/authorize`,t={};let r=null;try{const n=await this.networkInterface.sendGetRequestAsync(e,t);let i,o;if(function isCloudInstanceDiscoveryResponse(e){return e.hasOwnProperty("tenant_discovery_endpoint")&&e.hasOwnProperty("metadata")}(n.body))i=n.body,o=i.metadata,this.logger.verbosePii(`tenant_discovery_endpoint is: ${i.tenant_discovery_endpoint}`);else{if(!function isCloudInstanceDiscoveryErrorResponse(e){return e.hasOwnProperty("error")&&e.hasOwnProperty("error_description")}(n.body))return this.logger.error("AAD did not return a CloudInstanceDiscoveryResponse or CloudInstanceDiscoveryErrorResponse"),null;if(this.logger.warning(`A CloudInstanceDiscoveryErrorResponse was returned. The cloud instance discovery network request's status code is: ${n.status}`),i=n.body,i.error===A.INVALID_INSTANCE)return this.logger.error("The CloudInstanceDiscoveryErrorResponse error is invalid_instance."),null;this.logger.warning(`The CloudInstanceDiscoveryErrorResponse error is ${i.error}`),this.logger.warning(`The CloudInstanceDiscoveryErrorResponse error description is ${i.error_description}`),this.logger.warning("Setting the value of the CloudInstanceDiscoveryMetadata (returned from the network) to []"),o=[]}this.logger.verbose("Attempting to find a match between the developer's authority and the CloudInstanceDiscoveryMetadata returned from the network request."),r=getCloudDiscoveryMetadataFromNetworkResponse(o,this.hostnameAndPort)}catch(e){if(e instanceof AuthError)this.logger.error(`There was a network error while attempting to get the cloud discovery instance metadata.\nError: ${e.errorCode}\nError Description: ${e.errorMessage}`);else{const t=e;this.logger.error(`A non-MSALJS error was thrown while attempting to get the cloud instance discovery metadata.\nError: ${t.name}\nError Description: ${t.message}`)}return null}return r||(this.logger.warning("The developer's authority was not found within the CloudInstanceDiscoveryMetadata returned from the network request."),this.logger.verbose("Creating custom Authority for custom domain scenario."),r=Authority.createCloudDiscoveryMetadataFromHost(this.hostnameAndPort)),r}isInKnownAuthorities(){return this.authorityOptions.knownAuthorities.filter((e=>e&&UrlString.getDomainFromUrl(e).toLowerCase()===this.hostnameAndPort)).length>0}static generateAuthority(e,t){let r;if(t&&t.azureCloudInstance!==Yr){const e=t.tenant?t.tenant:A.DEFAULT_COMMON_TENANT;r=`${t.azureCloudInstance}/${e}/`}return r||e}static createCloudDiscoveryMetadataFromHost(e){return{preferred_network:e,preferred_cache:e,aliases:[e]}}getPreferredCache(){if(this.managedIdentity)return A.DEFAULT_AUTHORITY_HOST;if(this.discoveryComplete())return this.metadata.preferred_cache;throw createClientAuthError(nr)}isAlias(e){return this.metadata.aliases.indexOf(e)>-1}isAliasOfKnownMicrosoftAuthority(e){return Gr.has(e)}static isPublicCloudAuthority(e){return A.KNOWN_PUBLIC_CLOUDS.indexOf(e)>=0}static buildRegionalAuthorityString(e,t,r){const n=new UrlString(e);n.validateAsUri();const i=n.getUrlComponents();let o=`${t}.${i.HostNameAndPort}`;this.isPublicCloudAuthority(i.HostNameAndPort)&&(o=`${t}.${A.REGIONAL_AUTH_PUBLIC_CLOUD_SUFFIX}`);const a=UrlString.constructAuthorityUriFromObject({...n.getUrlComponents(),HostNameAndPort:o}).urlString;return r?`${a}?${r}`:a}static replaceWithRegionalInformation(e,t){const r={...e};return r.authorization_endpoint=Authority.buildRegionalAuthorityString(r.authorization_endpoint,t),r.token_endpoint=Authority.buildRegionalAuthorityString(r.token_endpoint,t),r.end_session_endpoint&&(r.end_session_endpoint=Authority.buildRegionalAuthorityString(r.end_session_endpoint,t)),r}static transformCIAMAuthority(e){let t=e;const r=new UrlString(e).getUrlComponents();if(0===r.PathSegments.length&&r.HostNameAndPort.endsWith(A.CIAM_AUTH_URL)){t=`${t}${r.HostNameAndPort.split(".")[0]}${A.AAD_TENANT_DOMAIN_SUFFIX}`}return t}}function formatAuthorityUri(e){return e.endsWith(A.FORWARD_SLASH)?e:`${e}${A.FORWARD_SLASH}`}Authority.reservedTenantDomains=new Set(["{tenant}","{tenantid}",H.COMMON,H.CONSUMERS,H.ORGANIZATIONS]);const _n={createNewGuid:()=>{throw createClientAuthError(Fr)},base64Decode:()=>{throw createClientAuthError(Fr)},base64Encode:()=>{throw createClientAuthError(Fr)},base64UrlEncode:()=>{throw createClientAuthError(Fr)},encodeKid:()=>{throw createClientAuthError(Fr)},async getPublicKeyThumbprint(){throw createClientAuthError(Fr)},async removeTokenBindingKey(){throw createClientAuthError(Fr)},async clearKeystore(){throw createClientAuthError(Fr)},async signJwt(){throw createClientAuthError(Fr)},async hashString(){throw createClientAuthError(Fr)}},Rn="@azure/msal-common",On="15.2.1";class ScopeSet{constructor(e){const t=e?StringUtils.trimArrayEntries([...e]):[],r=t?StringUtils.removeEmptyStringsFromArray(t):[];if(!r||!r.length)throw createClientConfigurationError(qt);this.scopes=new Set,r.forEach((e=>this.scopes.add(e)))}static fromString(e){const t=(e||A.EMPTY_STRING).split(" ");return new ScopeSet(t)}static createSearchScopes(e){const t=new ScopeSet(e);return t.containsOnlyOIDCScopes()?t.removeScope(A.OFFLINE_ACCESS_SCOPE):t.removeOIDCScopes(),t}containsScope(e){const t=this.printScopesLowerCase().split(" "),r=new ScopeSet(t);return!!e&&r.scopes.has(e.toLowerCase())}containsScopeSet(e){return!(!e||e.scopes.size<=0)&&(this.scopes.size>=e.scopes.size&&e.asArray().every((e=>this.containsScope(e))))}containsOnlyOIDCScopes(){let e=0;return O.forEach((t=>{this.containsScope(t)&&(e+=1)})),this.scopes.size===e}appendScope(e){e&&this.scopes.add(e.trim())}appendScopes(e){try{e.forEach((e=>this.appendScope(e)))}catch(e){throw createClientAuthError(Cr)}}removeScope(e){if(!e)throw createClientAuthError(yr);this.scopes.delete(e.trim())}removeOIDCScopes(){O.forEach((e=>{this.scopes.delete(e)}))}unionScopeSets(e){if(!e)throw createClientAuthError(Ar);const t=new Set;return e.scopes.forEach((e=>t.add(e.toLowerCase()))),this.scopes.forEach((e=>t.add(e.toLowerCase()))),t}intersectingScopeSets(e){if(!e)throw createClientAuthError(Ar);e.containsOnlyOIDCScopes()||e.removeOIDCScopes();const t=this.unionScopeSets(e),r=e.getScopeCount(),n=this.getScopeCount();return t.size<n+r}getScopeCount(){return this.scopes.size}asArray(){const e=[];return this.scopes.forEach((t=>e.push(t))),e}printScopes(){if(this.scopes){return this.asArray().join(" ")}return A.EMPTY_STRING}printScopesLowerCase(){return this.printScopes().toLowerCase()}}function buildClientInfo(e,t){if(!e)throw createClientAuthError(er);try{const r=t(e);return JSON.parse(r)}catch(e){throw createClientAuthError(Xt)}}function buildClientInfoFromHomeAccountId(e){if(!e)throw createClientAuthError(Xt);const t=e.split(X,2);return{uid:t[0],utid:t.length<2?A.EMPTY_STRING:t[1]}}function tenantIdMatchesHomeTenant(e,t){return!!e&&!!t&&e===t.split(".")[1]}function buildTenantProfile(e,t,r,n){if(n){const{oid:t,sub:r,tid:i,name:o,tfp:a,acr:s}=n,c=i||a||s||"";return{tenantId:c,localAccountId:t||r||"",name:o,isHomeTenant:tenantIdMatchesHomeTenant(c,e)}}return{tenantId:r,localAccountId:t,isHomeTenant:tenantIdMatchesHomeTenant(r,e)}}function updateAccountTenantProfileData(e,t,r,n){let i=e;if(t){const{isHomeTenant:r,...n}=t;i={...e,...n}}if(r){const{isHomeTenant:t,...o}=buildTenantProfile(e.homeAccountId,e.localAccountId,e.tenantId,r);return i={...i,...o,idTokenClaims:r,idToken:n},i}return i}function getTenantIdFromIdTokenClaims(e){if(e){return e.tid||e.tfp||e.acr||null}return null}class AccountEntity{generateAccountId(){return[this.homeAccountId,this.environment].join(Z).toLowerCase()}generateAccountKey(){return AccountEntity.generateAccountCacheKey({homeAccountId:this.homeAccountId,environment:this.environment,tenantId:this.realm,username:this.username,localAccountId:this.localAccountId})}getAccountInfo(){return{homeAccountId:this.homeAccountId,environment:this.environment,tenantId:this.realm,username:this.username,localAccountId:this.localAccountId,name:this.name,nativeAccountId:this.nativeAccountId,authorityType:this.authorityType,tenantProfiles:new Map((this.tenantProfiles||[]).map((e=>[e.tenantId,e])))}}isSingleTenant(){return!this.tenantProfiles}static generateAccountCacheKey(e){const t=e.homeAccountId.split(".")[1];return[e.homeAccountId,e.environment||"",t||e.tenantId||""].join(Z).toLowerCase()}static createAccount(e,t,r){const n=new AccountEntity;let i;t.authorityType===bt?n.authorityType=W:t.protocolMode===Vr?n.authorityType=Y:n.authorityType=J,e.clientInfo&&r&&(i=buildClientInfo(e.clientInfo,r)),n.clientInfo=e.clientInfo,n.homeAccountId=e.homeAccountId,n.nativeAccountId=e.nativeAccountId;const o=e.environment||t&&t.getPreferredCache();if(!o)throw createClientAuthError(kr);n.environment=o,n.realm=i?.utid||getTenantIdFromIdTokenClaims(e.idTokenClaims)||"",n.localAccountId=i?.uid||e.idTokenClaims?.oid||e.idTokenClaims?.sub||"";const a=e.idTokenClaims?.preferred_username||e.idTokenClaims?.upn,s=e.idTokenClaims?.emails?e.idTokenClaims.emails[0]:null;if(n.username=a||s||"",n.name=e.idTokenClaims?.name||"",n.cloudGraphHostName=e.cloudGraphHostName,n.msGraphHost=e.msGraphHost,e.tenantProfiles)n.tenantProfiles=e.tenantProfiles;else{const t=buildTenantProfile(e.homeAccountId,n.localAccountId,n.realm,e.idTokenClaims);n.tenantProfiles=[t]}return n}static createFromAccountInfo(e,t,r){const n=new AccountEntity;return n.authorityType=e.authorityType||J,n.homeAccountId=e.homeAccountId,n.localAccountId=e.localAccountId,n.nativeAccountId=e.nativeAccountId,n.realm=e.tenantId,n.environment=e.environment,n.username=e.username,n.name=e.name,n.cloudGraphHostName=t,n.msGraphHost=r,n.tenantProfiles=Array.from(e.tenantProfiles?.values()||[]),n}static generateHomeAccountId(e,t,r,n,i){if(t!==bt&&t!==_t){if(e)try{const t=buildClientInfo(e,n.base64Decode);if(t.uid&&t.utid)return`${t.uid}.${t.utid}`}catch(e){}r.warning("No client info in response")}return i?.sub||""}static isAccountEntity(e){return!!e&&(e.hasOwnProperty("homeAccountId")&&e.hasOwnProperty("environment")&&e.hasOwnProperty("realm")&&e.hasOwnProperty("localAccountId")&&e.hasOwnProperty("username")&&e.hasOwnProperty("authorityType"))}static accountInfoIsEqual(e,t,r){if(!e||!t)return!1;let n=!0;if(r){const r=e.idTokenClaims||{},i=t.idTokenClaims||{};n=r.iat===i.iat&&r.nonce===i.nonce}return e.homeAccountId===t.homeAccountId&&e.localAccountId===t.localAccountId&&e.username===t.username&&e.tenantId===t.tenantId&&e.environment===t.environment&&e.nativeAccountId===t.nativeAccountId&&n}}const Pn="cache_quota_exceeded",Mn="cache_error_unknown",Nn={[Pn]:"Exceeded cache storage capacity.",[Mn]:"Unexpected error occurred when using cache storage."};class CacheError extends Error{constructor(e,t){const r=t||(Nn[e]?Nn[e]:Nn[Mn]);super(`${e}: ${r}`),Object.setPrototypeOf(this,CacheError.prototype),this.name="CacheError",this.errorCode=e,this.errorMessage=r}}class CacheManager{constructor(e,t,r,n){this.clientId=e,this.cryptoImpl=t,this.commonLogger=r.clone(Rn,On),this.staticAuthorityOptions=n}getAllAccounts(e){return this.buildTenantProfiles(this.getAccountsFilteredBy(e||{}),e)}getAccountInfoFilteredBy(e){const t=this.getAllAccounts(e);if(t.length>1){return t.sort((e=>e.idTokenClaims?-1:1))[0]}return 1===t.length?t[0]:null}getBaseAccountInfo(e){const t=this.getAccountsFilteredBy(e);return t.length>0?t[0].getAccountInfo():null}buildTenantProfiles(e,t){return e.flatMap((e=>this.getTenantProfilesFromAccountEntity(e,t?.tenantId,t)))}getTenantedAccountInfoByFilter(e,t,r,n){let i,o=null;if(n&&!this.tenantProfileMatchesFilter(r,n))return null;const a=this.getIdToken(e,t,r.tenantId);return a&&(i=extractTokenClaims(a.secret,this.cryptoImpl.base64Decode),!this.idTokenClaimsMatchTenantProfileFilter(i,n))?null:(o=updateAccountTenantProfileData(e,r,i,a?.secret),o)}getTenantProfilesFromAccountEntity(e,t,r){const n=e.getAccountInfo();let i=n.tenantProfiles||new Map;const o=this.getTokenKeys();if(t){const e=i.get(t);if(!e)return[];i=new Map([[t,e]])}const a=[];return i.forEach((e=>{const t=this.getTenantedAccountInfoByFilter(n,o,e,r);t&&a.push(t)})),a}tenantProfileMatchesFilter(e,t){return!(t.localAccountId&&!this.matchLocalAccountIdFromTenantProfile(e,t.localAccountId))&&((!t.name||e.name===t.name)&&(void 0===t.isHomeTenant||e.isHomeTenant===t.isHomeTenant))}idTokenClaimsMatchTenantProfileFilter(e,t){if(t){if(t.localAccountId&&!this.matchLocalAccountIdFromTokenClaims(e,t.localAccountId))return!1;if(t.loginHint&&!this.matchLoginHintFromTokenClaims(e,t.loginHint))return!1;if(t.username&&!this.matchUsername(e.preferred_username,t.username))return!1;if(t.name&&!this.matchName(e,t.name))return!1;if(t.sid&&!this.matchSid(e,t.sid))return!1}return!0}async saveCacheRecord(e,t,r){if(!e)throw createClientAuthError(wr);try{e.account&&await this.setAccount(e.account,t),e.idToken&&!1!==r?.idToken&&await this.setIdTokenCredential(e.idToken,t),e.accessToken&&!1!==r?.accessToken&&await this.saveAccessToken(e.accessToken,t),e.refreshToken&&!1!==r?.refreshToken&&await this.setRefreshTokenCredential(e.refreshToken,t),e.appMetadata&&this.setAppMetadata(e.appMetadata)}catch(e){throw this.commonLogger?.error("CacheManager.saveCacheRecord: failed"),e instanceof Error?(this.commonLogger?.errorPii(`CacheManager.saveCacheRecord: ${e.message}`,t),"QuotaExceededError"===e.name||"NS_ERROR_DOM_QUOTA_REACHED"===e.name||e.message.includes("exceeded the quota")?(this.commonLogger?.error("CacheManager.saveCacheRecord: exceeded storage quota",t),new CacheError(Pn)):new CacheError(e.name,e.message)):(this.commonLogger?.errorPii(`CacheManager.saveCacheRecord: ${e}`,t),new CacheError(Mn))}}async saveAccessToken(e,t){const r={clientId:e.clientId,credentialType:e.credentialType,environment:e.environment,homeAccountId:e.homeAccountId,realm:e.realm,tokenType:e.tokenType,requestedClaimsHash:e.requestedClaimsHash},n=this.getTokenKeys(),i=ScopeSet.fromString(e.target),o=[];n.accessToken.forEach((e=>{if(!this.accessTokenKeyMatchesFilter(e,r,!1))return;const t=this.getAccessTokenCredential(e);if(t&&this.credentialMatchesFilter(t,r)){ScopeSet.fromString(t.target).intersectingScopeSets(i)&&o.push(this.removeAccessToken(e))}})),await Promise.all(o),await this.setAccessTokenCredential(e,t)}getAccountsFilteredBy(e){const t=this.getAccountKeys(),r=[];return t.forEach((t=>{if(!this.isAccountKey(t,e.homeAccountId))return;const n=this.getAccount(t,this.commonLogger);if(!n)return;if(e.homeAccountId&&!this.matchHomeAccountId(n,e.homeAccountId))return;if(e.username&&!this.matchUsername(n.username,e.username))return;if(e.environment&&!this.matchEnvironment(n,e.environment))return;if(e.realm&&!this.matchRealm(n,e.realm))return;if(e.nativeAccountId&&!this.matchNativeAccountId(n,e.nativeAccountId))return;if(e.authorityType&&!this.matchAuthorityType(n,e.authorityType))return;const i={localAccountId:e?.localAccountId,name:e?.name},o=n.tenantProfiles?.filter((e=>this.tenantProfileMatchesFilter(e,i)));o&&0===o.length||r.push(n)})),r}isAccountKey(e,t,r){return!(e.split(Z).length<3)&&(!(t&&!e.toLowerCase().includes(t.toLowerCase()))&&!(r&&!e.toLowerCase().includes(r.toLowerCase())))}isCredentialKey(e){if(e.split(Z).length<6)return!1;const t=e.toLowerCase();if(-1===t.indexOf(ee.ID_TOKEN.toLowerCase())&&-1===t.indexOf(ee.ACCESS_TOKEN.toLowerCase())&&-1===t.indexOf(ee.ACCESS_TOKEN_WITH_AUTH_SCHEME.toLowerCase())&&-1===t.indexOf(ee.REFRESH_TOKEN.toLowerCase()))return!1;if(t.indexOf(ee.REFRESH_TOKEN.toLowerCase())>-1){const e=`${ee.REFRESH_TOKEN}${Z}${this.clientId}${Z}`,r=`${ee.REFRESH_TOKEN}${Z}${re}${Z}`;if(-1===t.indexOf(e.toLowerCase())&&-1===t.indexOf(r.toLowerCase()))return!1}else if(-1===t.indexOf(this.clientId.toLowerCase()))return!1;return!0}credentialMatchesFilter(e,t){if(t.clientId&&!this.matchClientId(e,t.clientId))return!1;if(t.userAssertionHash&&!this.matchUserAssertionHash(e,t.userAssertionHash))return!1;if("string"==typeof t.homeAccountId&&!this.matchHomeAccountId(e,t.homeAccountId))return!1;if(t.environment&&!this.matchEnvironment(e,t.environment))return!1;if(t.realm&&!this.matchRealm(e,t.realm))return!1;if(t.credentialType&&!this.matchCredentialType(e,t.credentialType))return!1;if(t.familyId&&!this.matchFamilyId(e,t.familyId))return!1;if(t.target&&!this.matchTarget(e,t.target))return!1;if((t.requestedClaimsHash||e.requestedClaimsHash)&&e.requestedClaimsHash!==t.requestedClaimsHash)return!1;if(e.credentialType===ee.ACCESS_TOKEN_WITH_AUTH_SCHEME){if(t.tokenType&&!this.matchTokenType(e,t.tokenType))return!1;if(t.tokenType===ue.SSH&&t.keyId&&!this.matchKeyId(e,t.keyId))return!1}return!0}getAppMetadataFilteredBy(e){const t=this.getKeys(),r={};return t.forEach((t=>{if(!this.isAppMetadata(t))return;const n=this.getAppMetadata(t);n&&(e.environment&&!this.matchEnvironment(n,e.environment)||e.clientId&&!this.matchClientId(n,e.clientId)||(r[t]=n))})),r}getAuthorityMetadataByAlias(e){const t=this.getAuthorityMetadataKeys();let r=null;return t.forEach((t=>{if(!this.isAuthorityMetadata(t)||-1===t.indexOf(this.clientId))return;const n=this.getAuthorityMetadata(t);n&&-1!==n.aliases.indexOf(e)&&(r=n)})),r}async removeAllAccounts(){const e=this.getAccountKeys(),t=[];e.forEach((e=>{t.push(this.removeAccount(e))})),await Promise.all(t)}async removeAccount(e){const t=this.getAccount(e,this.commonLogger);t&&(await this.removeAccountContext(t),this.removeItem(e))}async removeAccountContext(e){const t=this.getTokenKeys(),r=e.generateAccountId(),n=[];t.idToken.forEach((e=>{0===e.indexOf(r)&&this.removeIdToken(e)})),t.accessToken.forEach((e=>{0===e.indexOf(r)&&n.push(this.removeAccessToken(e))})),t.refreshToken.forEach((e=>{0===e.indexOf(r)&&this.removeRefreshToken(e)})),await Promise.all(n)}async removeAccessToken(e){const t=this.getAccessTokenCredential(e);if(t){if(t.credentialType.toLowerCase()===ee.ACCESS_TOKEN_WITH_AUTH_SCHEME.toLowerCase()&&t.tokenType===ue.POP){const e=t.keyId;if(e)try{await this.cryptoImpl.removeTokenBindingKey(e)}catch(e){throw createClientAuthError(qr)}}return this.removeItem(e)}}removeAppMetadata(){return this.getKeys().forEach((e=>{this.isAppMetadata(e)&&this.removeItem(e)})),!0}readAccountFromCache(e){const t=AccountEntity.generateAccountCacheKey(e);return this.getAccount(t,this.commonLogger)}getIdToken(e,t,r,n,i){this.commonLogger.trace("CacheManager - getIdToken called");const o={homeAccountId:e.homeAccountId,environment:e.environment,credentialType:ee.ID_TOKEN,clientId:this.clientId,realm:r},a=this.getIdTokensByFilter(o,t),s=a.size;if(s<1)return this.commonLogger.info("CacheManager:getIdToken - No token found"),null;if(s>1){let t=a;if(!r){const r=new Map;a.forEach(((t,n)=>{t.realm===e.tenantId&&r.set(n,t)}));const n=r.size;if(n<1)return this.commonLogger.info("CacheManager:getIdToken - Multiple ID tokens found for account but none match account entity tenant id, returning first result"),a.values().next().value;if(1===n)return this.commonLogger.info("CacheManager:getIdToken - Multiple ID tokens found for account, defaulting to home tenant profile"),r.values().next().value;t=r}return this.commonLogger.info("CacheManager:getIdToken - Multiple matching ID tokens found, clearing them"),t.forEach(((e,t)=>{this.removeIdToken(t)})),n&&i&&n.addFields({multiMatchedID:a.size},i),null}return this.commonLogger.info("CacheManager:getIdToken - Returning ID token"),a.values().next().value}getIdTokensByFilter(e,t){const r=t&&t.idToken||this.getTokenKeys().idToken,n=new Map;return r.forEach((t=>{if(!this.idTokenKeyMatchesFilter(t,{clientId:this.clientId,...e}))return;const r=this.getIdTokenCredential(t);r&&this.credentialMatchesFilter(r,e)&&n.set(t,r)})),n}idTokenKeyMatchesFilter(e,t){const r=e.toLowerCase();return(!t.clientId||-1!==r.indexOf(t.clientId.toLowerCase()))&&(!t.homeAccountId||-1!==r.indexOf(t.homeAccountId.toLowerCase()))}removeIdToken(e){this.removeItem(e)}removeRefreshToken(e){this.removeItem(e)}getAccessToken(e,t,r,n,i,o){this.commonLogger.trace("CacheManager - getAccessToken called");const a=ScopeSet.createSearchScopes(t.scopes),s=t.authenticationScheme||ue.BEARER,c=s&&s.toLowerCase()!==ue.BEARER.toLowerCase()?ee.ACCESS_TOKEN_WITH_AUTH_SCHEME:ee.ACCESS_TOKEN,l={homeAccountId:e.homeAccountId,environment:e.environment,credentialType:c,clientId:this.clientId,realm:n||e.tenantId,target:a,tokenType:s,keyId:t.sshKid,requestedClaimsHash:t.requestedClaimsHash},u=r&&r.accessToken||this.getTokenKeys().accessToken,d=[];u.forEach((e=>{if(this.accessTokenKeyMatchesFilter(e,l,!0)){const t=this.getAccessTokenCredential(e);t&&this.credentialMatchesFilter(t,l)&&d.push(t)}}));const h=d.length;return h<1?(this.commonLogger.info("CacheManager:getAccessToken - No token found"),null):h>1?(this.commonLogger.info("CacheManager:getAccessToken - Multiple access tokens found, clearing them"),d.forEach((e=>{this.removeAccessToken(generateCredentialKey(e))})),i&&o&&i.addFields({multiMatchedAT:d.length},o),null):(this.commonLogger.info("CacheManager:getAccessToken - Returning access token"),d[0])}accessTokenKeyMatchesFilter(e,t,r){const n=e.toLowerCase();if(t.clientId&&-1===n.indexOf(t.clientId.toLowerCase()))return!1;if(t.homeAccountId&&-1===n.indexOf(t.homeAccountId.toLowerCase()))return!1;if(t.realm&&-1===n.indexOf(t.realm.toLowerCase()))return!1;if(t.requestedClaimsHash&&-1===n.indexOf(t.requestedClaimsHash.toLowerCase()))return!1;if(t.target){const e=t.target.asArray();for(let t=0;t<e.length;t++){if(r&&!n.includes(e[t].toLowerCase()))return!1;if(!r&&n.includes(e[t].toLowerCase()))return!0}}return!0}getAccessTokensByFilter(e){const t=this.getTokenKeys(),r=[];return t.accessToken.forEach((t=>{if(!this.accessTokenKeyMatchesFilter(t,e,!0))return;const n=this.getAccessTokenCredential(t);n&&this.credentialMatchesFilter(n,e)&&r.push(n)})),r}getRefreshToken(e,t,r,n,i){this.commonLogger.trace("CacheManager - getRefreshToken called");const o=t?re:void 0,a={homeAccountId:e.homeAccountId,environment:e.environment,credentialType:ee.REFRESH_TOKEN,clientId:this.clientId,familyId:o},s=r&&r.refreshToken||this.getTokenKeys().refreshToken,c=[];s.forEach((e=>{if(this.refreshTokenKeyMatchesFilter(e,a)){const t=this.getRefreshTokenCredential(e);t&&this.credentialMatchesFilter(t,a)&&c.push(t)}}));const l=c.length;return l<1?(this.commonLogger.info("CacheManager:getRefreshToken - No refresh token found."),null):(l>1&&n&&i&&n.addFields({multiMatchedRT:l},i),this.commonLogger.info("CacheManager:getRefreshToken - returning refresh token"),c[0])}refreshTokenKeyMatchesFilter(e,t){const r=e.toLowerCase();return(!t.familyId||-1!==r.indexOf(t.familyId.toLowerCase()))&&(!(!t.familyId&&t.clientId&&-1===r.indexOf(t.clientId.toLowerCase()))&&(!t.homeAccountId||-1!==r.indexOf(t.homeAccountId.toLowerCase())))}readAppMetadataFromCache(e){const t={environment:e,clientId:this.clientId},r=this.getAppMetadataFilteredBy(t),n=Object.keys(r).map((e=>r[e])),i=n.length;if(i<1)return null;if(i>1)throw createClientAuthError(fr);return n[0]}isAppMetadataFOCI(e){const t=this.readAppMetadataFromCache(e);return!(!t||t.familyId!==re)}matchHomeAccountId(e,t){return!("string"!=typeof e.homeAccountId||t!==e.homeAccountId)}matchLocalAccountIdFromTokenClaims(e,t){return t===(e.oid||e.sub)}matchLocalAccountIdFromTenantProfile(e,t){return e.localAccountId===t}matchName(e,t){return!(t.toLowerCase()!==e.name?.toLowerCase())}matchUsername(e,t){return!(!e||"string"!=typeof e||t?.toLowerCase()!==e.toLowerCase())}matchUserAssertionHash(e,t){return!(!e.userAssertionHash||t!==e.userAssertionHash)}matchEnvironment(e,t){if(this.staticAuthorityOptions){const r=function getAliasesFromStaticSources(e,t){let r;const n=e.canonicalAuthority;if(n){const i=new UrlString(n).getUrlComponents().HostNameAndPort;r=getAliasesFromMetadata(i,e.cloudDiscoveryMetadata?.metadata,oe,t)||getAliasesFromMetadata(i,zr.metadata,ce,t)||e.knownAuthorities}return r||[]}(this.staticAuthorityOptions,this.commonLogger);if(r.includes(t)&&r.includes(e.environment))return!0}const r=this.getAuthorityMetadataByAlias(t);return!!(r&&r.aliases.indexOf(e.environment)>-1)}matchCredentialType(e,t){return e.credentialType&&t.toLowerCase()===e.credentialType.toLowerCase()}matchClientId(e,t){return!(!e.clientId||t!==e.clientId)}matchFamilyId(e,t){return!(!e.familyId||t!==e.familyId)}matchRealm(e,t){return!(e.realm?.toLowerCase()!==t.toLowerCase())}matchNativeAccountId(e,t){return!(!e.nativeAccountId||t!==e.nativeAccountId)}matchLoginHintFromTokenClaims(e,t){return e.login_hint===t||(e.preferred_username===t||e.upn===t)}matchSid(e,t){return e.sid===t}matchAuthorityType(e,t){return!(!e.authorityType||t.toLowerCase()!==e.authorityType.toLowerCase())}matchTarget(e,t){if(e.credentialType!==ee.ACCESS_TOKEN&&e.credentialType!==ee.ACCESS_TOKEN_WITH_AUTH_SCHEME||!e.target)return!1;return ScopeSet.fromString(e.target).containsScopeSet(t)}matchTokenType(e,t){return!(!e.tokenType||e.tokenType!==t)}matchKeyId(e,t){return!(!e.keyId||e.keyId!==t)}isAppMetadata(e){return-1!==e.indexOf(te)}isAuthorityMetadata(e){return-1!==e.indexOf(ne)}generateAuthorityMetadataCacheKey(e){return`${ne}-${this.clientId}-${e}`}static toObject(e,t){for(const r in t)e[r]=t[r];return e}}class DefaultStorageClass extends CacheManager{async setAccount(){throw createClientAuthError(Fr)}getAccount(){throw createClientAuthError(Fr)}async setIdTokenCredential(){throw createClientAuthError(Fr)}getIdTokenCredential(){throw createClientAuthError(Fr)}async setAccessTokenCredential(){throw createClientAuthError(Fr)}getAccessTokenCredential(){throw createClientAuthError(Fr)}async setRefreshTokenCredential(){throw createClientAuthError(Fr)}getRefreshTokenCredential(){throw createClientAuthError(Fr)}setAppMetadata(){throw createClientAuthError(Fr)}getAppMetadata(){throw createClientAuthError(Fr)}setServerTelemetry(){throw createClientAuthError(Fr)}getServerTelemetry(){throw createClientAuthError(Fr)}setAuthorityMetadata(){throw createClientAuthError(Fr)}getAuthorityMetadata(){throw createClientAuthError(Fr)}getAuthorityMetadataKeys(){throw createClientAuthError(Fr)}setThrottlingCache(){throw createClientAuthError(Fr)}getThrottlingCache(){throw createClientAuthError(Fr)}removeItem(){throw createClientAuthError(Fr)}getKeys(){throw createClientAuthError(Fr)}getAccountKeys(){throw createClientAuthError(Fr)}getTokenKeys(){throw createClientAuthError(Fr)}}const Un={tokenRenewalOffsetSeconds:300,preventCorsPreflight:!1},qn={loggerCallback:()=>{},piiLoggingEnabled:!1,logLevel:kt.Info,correlationId:A.EMPTY_STRING},xn={claimsBasedCachingEnabled:!1},Hn={async sendGetRequestAsync(){throw createClientAuthError(Fr)},async sendPostRequestAsync(){throw createClientAuthError(Fr)}},Ln={sku:A.SKU,version:On,cpu:A.EMPTY_STRING,os:A.EMPTY_STRING},Dn={clientSecret:A.EMPTY_STRING,clientAssertion:void 0},Bn={azureCloudInstance:Yr,tenant:`${A.DEFAULT_COMMON_TENANT}`},Fn={application:{appName:"",appVersion:""}};function isOidcProtocolMode(e){return e.authOptions.authority.options.protocolMode===Qr}const jn="home_account_id",$n="UPN";class RequestValidator{static validateRedirectUri(e){if(!e)throw createClientConfigurationError(Ot)}static validatePrompt(e){const t=[];for(const e in B)t.push(B[e]);if(t.indexOf(e)<0)throw createClientConfigurationError(xt)}static validateClaims(e){try{JSON.parse(e)}catch(e){throw createClientConfigurationError(Ht)}}static validateCodeChallengeParams(e,t){if(!e||!t)throw createClientConfigurationError(Ft);this.validateCodeChallengeMethod(t)}static validateCodeChallengeMethod(e){if([F.PLAIN,F.S256].indexOf(e)<0)throw createClientConfigurationError(Bt)}}class RequestParameterBuilder{constructor(e,t){this.parameters=new Map,this.performanceClient=t,this.correlationId=e}addResponseTypeCode(){this.parameters.set(At,encodeURIComponent(A.CODE_RESPONSE_TYPE))}addResponseTypeForTokenAndIdToken(){this.parameters.set(At,encodeURIComponent(`${A.TOKEN_RESPONSE_TYPE} ${A.ID_TOKEN_RESPONSE_TYPE}`))}addResponseMode(e){this.parameters.set("response_mode",encodeURIComponent(e||j.QUERY))}addNativeBroker(){this.parameters.set("nativebroker",encodeURIComponent("1"))}addScopes(e,t=!0,r=R){!t||r.includes("openid")||e.includes("openid")||r.push("openid");const n=t?[...e||[],...r]:e||[],i=new ScopeSet(n);this.parameters.set("scope",encodeURIComponent(i.printScopes()))}addClientId(e){this.parameters.set(yt,encodeURIComponent(e))}addRedirectUri(e){RequestValidator.validateRedirectUri(e),this.parameters.set(Ct,encodeURIComponent(e))}addPostLogoutRedirectUri(e){RequestValidator.validateRedirectUri(e),this.parameters.set("post_logout_redirect_uri",encodeURIComponent(e))}addIdTokenHint(e){this.parameters.set("id_token_hint",encodeURIComponent(e))}addDomainHint(e){this.parameters.set("domain_hint",encodeURIComponent(e))}addLoginHint(e){this.parameters.set("login_hint",encodeURIComponent(e))}addCcsUpn(e){this.parameters.set(U,encodeURIComponent(`UPN:${e}`))}addCcsOid(e){this.parameters.set(U,encodeURIComponent(`Oid:${e.uid}@${e.utid}`))}addSid(e){this.parameters.set("sid",encodeURIComponent(e))}addClaims(e,t){const r=this.addClientCapabilitiesToClaims(e,t);RequestValidator.validateClaims(r),this.parameters.set("claims",encodeURIComponent(r))}addCorrelationId(e){this.parameters.set("client-request-id",encodeURIComponent(e))}addLibraryInfo(e){this.parameters.set("x-client-SKU",e.sku),this.parameters.set("x-client-VER",e.version),e.os&&this.parameters.set("x-client-OS",e.os),e.cpu&&this.parameters.set("x-client-CPU",e.cpu)}addApplicationTelemetry(e){e?.appName&&this.parameters.set("x-app-name",e.appName),e?.appVersion&&this.parameters.set("x-app-ver",e.appVersion)}addPrompt(e){RequestValidator.validatePrompt(e),this.parameters.set("prompt",encodeURIComponent(e))}addState(e){e&&this.parameters.set("state",encodeURIComponent(e))}addNonce(e){this.parameters.set("nonce",encodeURIComponent(e))}addCodeChallengeParams(e,t){if(RequestValidator.validateCodeChallengeParams(e,t),!e||!t)throw createClientConfigurationError(Ft);this.parameters.set("code_challenge",encodeURIComponent(e)),this.parameters.set("code_challenge_method",encodeURIComponent(t))}addAuthorizationCode(e){this.parameters.set("code",encodeURIComponent(e))}addDeviceCode(e){this.parameters.set("device_code",encodeURIComponent(e))}addRefreshToken(e){this.parameters.set("refresh_token",encodeURIComponent(e))}addCodeVerifier(e){this.parameters.set("code_verifier",encodeURIComponent(e))}addClientSecret(e){this.parameters.set("client_secret",encodeURIComponent(e))}addClientAssertion(e){e&&this.parameters.set("client_assertion",encodeURIComponent(e))}addClientAssertionType(e){e&&this.parameters.set("client_assertion_type",encodeURIComponent(e))}addOboAssertion(e){this.parameters.set("assertion",encodeURIComponent(e))}addRequestTokenUse(e){this.parameters.set("requested_token_use",encodeURIComponent(e))}addGrantType(e){this.parameters.set("grant_type",encodeURIComponent(e))}addClientInfo(){this.parameters.set("client_info","1")}addExtraQueryParameters(e){Object.entries(e).forEach((([e,t])=>{!this.parameters.has(e)&&t&&this.parameters.set(e,t)}))}addClientCapabilitiesToClaims(e,t){let r;if(e)try{r=JSON.parse(e)}catch(e){throw createClientConfigurationError(Ht)}else r={};return t&&t.length>0&&(r.hasOwnProperty(L)||(r[L]={}),r[L][D]={values:t}),JSON.stringify(r)}addUsername(e){this.parameters.set(ye,encodeURIComponent(e))}addPassword(e){this.parameters.set(Ce,encodeURIComponent(e))}addPopToken(e){e&&(this.parameters.set(Tt,ue.POP),this.parameters.set(It,encodeURIComponent(e)))}addSshJwk(e){e&&(this.parameters.set(Tt,ue.SSH),this.parameters.set(It,encodeURIComponent(e)))}addServerTelemetry(e){this.parameters.set("x-client-current-telemetry",e.generateCurrentRequestHeaderValue()),this.parameters.set("x-client-last-telemetry",e.generateLastRequestHeaderValue())}addThrottling(){this.parameters.set("x-ms-lib-capability",pe)}addLogoutHint(e){this.parameters.set("logout_hint",encodeURIComponent(e))}addBrokerParameters(e){const t={};t[wt]=e.brokerClientId,t.brk_redirect_uri=e.brokerRedirectUri,this.addExtraQueryParameters(t)}createQueryString(){const e=new Array;return this.parameters.forEach(((t,r)=>{e.push(`${r}=${t}`)})),function instrumentBrokerParams(e,t,r){if(!t)return;const n=e.get(yt);n&&e.has(wt)&&r?.addFields({embeddedClientId:n,embeddedRedirectUri:e.get(Ct)},t)}(this.parameters,this.correlationId,this.performanceClient),e.join("&")}}async function createDiscoveredInstance(e,t,r,n,i,o,a){a?.addQueueMeasurement(mn,o);const s=Authority.transformCIAMAuthority(formatAuthorityUri(e)),c=new Authority(s,t,r,n,i,o,a);try{return await bn(c.resolveEndpointsAsync.bind(c),yn,i,a,o)(),c}catch(e){throw createClientAuthError(nr)}}function getRequestThumbprint(e,t,r){return{clientId:e,authority:t.authority,scopes:t.scopes,homeAccountIdentifier:r,claims:t.claims,authenticationScheme:t.authenticationScheme,resourceRequestMethod:t.resourceRequestMethod,resourceRequestUri:t.resourceRequestUri,shrClaims:t.shrClaims,sshKid:t.sshKid,embeddedClientId:t.embeddedClientId||t.tokenBodyParameters?.clientId}}class ThrottlingUtils{static generateThrottlingStorageKey(e){return`${ge}.${JSON.stringify(e)}`}static preProcess(e,t){const r=ThrottlingUtils.generateThrottlingStorageKey(t),n=e.getThrottlingCache(r);if(n){if(n.throttleTime<Date.now())return void e.removeItem(r);throw new ServerError(n.errorCodes?.join(" ")||A.EMPTY_STRING,n.errorMessage,n.subError)}}static postProcess(e,t,r){if(ThrottlingUtils.checkResponseStatus(r)||ThrottlingUtils.checkResponseForRetryAfter(r)){const n={throttleTime:ThrottlingUtils.calculateThrottleTime(parseInt(r.headers[N])),error:r.body.error,errorCodes:r.body.error_codes,errorMessage:r.body.error_description,subError:r.body.suberror};e.setThrottlingCache(ThrottlingUtils.generateThrottlingStorageKey(t),n)}}static checkResponseStatus(e){return 429===e.status||e.status>=500&&e.status<600}static checkResponseForRetryAfter(e){return!!e.headers&&(e.headers.hasOwnProperty(N)&&(e.status<200||e.status>=300))}static calculateThrottleTime(e){const t=e<=0?0:e,r=Date.now()/1e3;return Math.floor(1e3*Math.min(r+(t||de),r+he))}static removeThrottle(e,t,r,n){const i=getRequestThumbprint(t,r,n),o=this.generateThrottlingStorageKey(i);e.removeItem(o)}}class NetworkError extends AuthError{constructor(e,t,r){super(e.errorCode,e.errorMessage,e.subError),Object.setPrototypeOf(this,NetworkError.prototype),this.name="NetworkError",this.error=e,this.httpStatus=t,this.responseHeaders=r}}class BaseClient{constructor(e,t){this.config=function buildClientConfiguration({authOptions:e,systemOptions:t,loggerOptions:r,cacheOptions:n,storageInterface:i,networkInterface:o,cryptoInterface:a,clientCredentials:s,libraryInfo:c,telemetry:l,serverTelemetryManager:u,persistencePlugin:d,serializableCache:h}){const g={...qn,...r};return{authOptions:(p=e,{clientCapabilities:[],azureCloudOptions:Bn,skipAuthorityMetadataCache:!1,instanceAware:!1,...p}),systemOptions:{...Un,...t},loggerOptions:g,cacheOptions:{...xn,...n},storageInterface:i||new DefaultStorageClass(e.clientId,_n,new Logger(g)),networkInterface:o||Hn,cryptoInterface:a||_n,clientCredentials:s||Dn,libraryInfo:{...Ln,...c},telemetry:{...Fn,...l},serverTelemetryManager:u||null,persistencePlugin:d||null,serializableCache:h||null};var p}(e),this.logger=new Logger(this.config.loggerOptions,Rn,On),this.cryptoUtils=this.config.cryptoInterface,this.cacheManager=this.config.storageInterface,this.networkClient=this.config.networkInterface,this.serverTelemetryManager=this.config.serverTelemetryManager,this.authority=this.config.authOptions.authority,this.performanceClient=t}createTokenRequestHeaders(e){const t={};if(t[P]=A.URL_FORM_CONTENT_TYPE,!this.config.systemOptions.preventCorsPreflight&&e)switch(e.type){case jn:try{const r=buildClientInfoFromHomeAccountId(e.credential);t[U]=`Oid:${r.uid}@${r.utid}`}catch(e){this.logger.verbose("Could not parse home account ID for CCS Header: "+e)}break;case $n:t[U]=`UPN: ${e.credential}`}return t}async executePostToTokenEndpoint(e,t,r,n,i,o){o&&this.performanceClient?.addQueueMeasurement(o,i);const a=await this.sendPostRequest(n,e,{body:t,headers:r},i);return this.config.serverTelemetryManager&&a.status<500&&429!==a.status&&this.config.serverTelemetryManager.clearTelemetryCache(),a}async sendPostRequest(e,t,r,n){let i;ThrottlingUtils.preProcess(this.cacheManager,e);try{i=await bn(this.networkClient.sendPostRequestAsync.bind(this.networkClient),Wr,this.logger,this.performanceClient,n)(t,r);const e=i.headers||{};this.performanceClient?.addFields({refreshTokenSize:i.body.refresh_token?.length||0,httpVerToken:e[x]||"",requestId:e[q]||""},n)}catch(e){if(e instanceof NetworkError){const t=e.responseHeaders;throw t&&this.performanceClient?.addFields({httpVerToken:t[x]||"",requestId:t[q]||"",contentTypeHeader:t[P]||void 0,contentLengthHeader:t[M]||void 0,httpStatus:e.httpStatus},n),e.error}throw e instanceof AuthError?e:createClientAuthError(ir)}return ThrottlingUtils.postProcess(this.cacheManager,e,i),i}async updateAuthority(e,t){this.performanceClient?.addQueueMeasurement(cn,t);const r=`https://${e}/${this.authority.tenant}/`,n=await createDiscoveredInstance(r,this.networkClient,this.cacheManager,this.authority.options,this.logger,t,this.performanceClient);this.authority=n}createTokenQueryParameters(e){const t=new RequestParameterBuilder(e.correlationId,this.performanceClient);return e.embeddedClientId&&t.addBrokerParameters({brokerClientId:this.config.authOptions.clientId,brokerRedirectUri:this.config.authOptions.redirectUri}),e.tokenQueryParameters&&t.addExtraQueryParameters(e.tokenQueryParameters),t.addCorrelationId(e.correlationId),t.createQueryString()}}const Kn="no_tokens_found",zn="native_account_unavailable",Gn="refresh_token_expired",Vn="bad_token",Qn=["interaction_required","consent_required","login_required",Vn],Yn=["message_only","additional_action","basic_action","user_password_expired","consent_required","bad_token"],Wn={[Kn]:"No refresh token found in the cache. Please sign-in.",[zn]:"The requested account is not available in the native broker. It may have been deleted or logged out. Please sign-in again using an interactive API.",[Gn]:"Refresh token has expired.",[Vn]:"Identity provider returned bad_token due to an expired or invalid refresh token. Please invoke an interactive API to resolve."};class InteractionRequiredAuthError extends AuthError{constructor(e,t,r,n,i,o,a,s){super(e,t,r),Object.setPrototypeOf(this,InteractionRequiredAuthError.prototype),this.timestamp=n||A.EMPTY_STRING,this.traceId=i||A.EMPTY_STRING,this.correlationId=o||A.EMPTY_STRING,this.claims=a||A.EMPTY_STRING,this.name="InteractionRequiredAuthError",this.errorNo=s}}function isInteractionRequiredError(e,t,r){const n=!!e&&Qn.indexOf(e)>-1,i=!!r&&Yn.indexOf(r)>-1,o=!!t&&Qn.some((e=>t.indexOf(e)>-1));return n||o||i}function createInteractionRequiredAuthError(e){return new InteractionRequiredAuthError(e,Wn[e])}class ProtocolUtils{static setRequestState(e,t,r){const n=ProtocolUtils.generateLibraryState(e,r);return t?`${n}${A.RESOURCE_DELIM}${t}`:n}static generateLibraryState(e,t){if(!e)throw createClientAuthError(br);const r={id:e.createNewGuid()};t&&(r.meta=t);const n=JSON.stringify(r);return e.base64Encode(n)}static parseRequestState(e,t){if(!e)throw createClientAuthError(br);if(!t)throw createClientAuthError(sr);try{const r=t.split(A.RESOURCE_DELIM),n=r[0],i=r.length>1?r.slice(1).join(A.RESOURCE_DELIM):A.EMPTY_STRING,o=e.base64Decode(n),a=JSON.parse(o);return{userRequestState:i||A.EMPTY_STRING,libraryState:a}}catch(e){throw createClientAuthError(sr)}}}const Jn="sw";class PopTokenGenerator{constructor(e,t){this.cryptoUtils=e,this.performanceClient=t}async generateCnf(e,t){this.performanceClient?.addQueueMeasurement(gn,e.correlationId);const r=await bn(this.generateKid.bind(this),gn,t,this.performanceClient,e.correlationId)(e),n=this.cryptoUtils.base64UrlEncode(JSON.stringify(r));return{kid:r.kid,reqCnfString:n}}async generateKid(e){this.performanceClient?.addQueueMeasurement(pn,e.correlationId);return{kid:await this.cryptoUtils.getPublicKeyThumbprint(e),xms_ksl:Jn}}async signPopToken(e,t,r){return this.signPayload(e,t,r)}async signPayload(e,t,r,n){const{resourceRequestMethod:i,resourceRequestUri:o,shrClaims:a,shrNonce:s,shrOptions:c}=r,l=o?new UrlString(o):void 0,u=l?.getUrlComponents();return this.cryptoUtils.signJwt({at:e,ts:nowSeconds(),m:i?.toUpperCase(),u:u?.HostNameAndPort,nonce:s||this.cryptoUtils.createNewGuid(),p:u?.AbsolutePath,q:u?.QueryString?[[],u.QueryString]:void 0,client_claims:a||void 0,...n},t,c,r.correlationId)}}class TokenCacheContext{constructor(e,t){this.cache=e,this.hasChanged=t}get cacheHasChanged(){return this.hasChanged}get tokenCache(){return this.cache}}class ResponseHandler{constructor(e,t,r,n,i,o,a){this.clientId=e,this.cacheStorage=t,this.cryptoObj=r,this.logger=n,this.serializableCache=i,this.persistencePlugin=o,this.performanceClient=a}validateServerAuthorizationCodeResponse(e,t){if(!e.state||!t)throw e.state?createClientAuthError(lr,"Cached State"):createClientAuthError(lr,"Server State");let r,n;try{r=decodeURIComponent(e.state)}catch(t){throw createClientAuthError(sr,e.state)}try{n=decodeURIComponent(t)}catch(t){throw createClientAuthError(sr,e.state)}if(r!==n)throw createClientAuthError(cr);if(e.error||e.error_description||e.suberror){const t=function parseServerErrorNo(e){const t="code=",r=e.error_uri?.lastIndexOf(t);return r&&r>=0?e.error_uri?.substring(r+5):void 0}(e);if(isInteractionRequiredError(e.error,e.error_description,e.suberror))throw new InteractionRequiredAuthError(e.error||"",e.error_description,e.suberror,e.timestamp||"",e.trace_id||"",e.correlation_id||"",e.claims||"",t);throw new ServerError(e.error||"",e.error_description,e.suberror,t)}}validateTokenResponse(e,t){if(e.error||e.error_description||e.suberror){const r=`Error(s): ${e.error_codes||A.NOT_AVAILABLE} - Timestamp: ${e.timestamp||A.NOT_AVAILABLE} - Description: ${e.error_description||A.NOT_AVAILABLE} - Correlation ID: ${e.correlation_id||A.NOT_AVAILABLE} - Trace ID: ${e.trace_id||A.NOT_AVAILABLE}`,n=e.error_codes?.length?e.error_codes[0]:void 0,i=new ServerError(e.error,r,e.suberror,n,e.status);if(t&&e.status&&e.status>=b&&e.status<=_)return void this.logger.warning(`executeTokenRequest:validateTokenResponse - AAD is currently unavailable and the access token is unable to be refreshed.\n${i}`);if(t&&e.status&&e.status>=w&&e.status<=k)return void this.logger.warning(`executeTokenRequest:validateTokenResponse - AAD is currently available but is unable to refresh the access token.\n${i}`);if(isInteractionRequiredError(e.error,e.error_description,e.suberror))throw new InteractionRequiredAuthError(e.error,e.error_description,e.suberror,e.timestamp||A.EMPTY_STRING,e.trace_id||A.EMPTY_STRING,e.correlation_id||A.EMPTY_STRING,e.claims||A.EMPTY_STRING,n);throw i}}async handleServerTokenResponse(e,t,r,n,i,o,a,s,c){let l,u;if(this.performanceClient?.addQueueMeasurement(fn,e.correlation_id),e.id_token){if(l=extractTokenClaims(e.id_token||A.EMPTY_STRING,this.cryptoObj.base64Decode),i&&i.nonce&&l.nonce!==i.nonce)throw createClientAuthError(ur);if(n.maxAge||0===n.maxAge){const e=l.auth_time;if(!e)throw createClientAuthError(dr);checkMaxAge(e,n.maxAge)}}this.homeAccountIdentifier=AccountEntity.generateHomeAccountId(e.client_info||A.EMPTY_STRING,t.authorityType,this.logger,this.cryptoObj,l),i&&i.state&&(u=ProtocolUtils.parseRequestState(this.cryptoObj,i.state)),e.key_id=e.key_id||n.sshKid||void 0;const d=this.generateCacheRecord(e,t,r,n,l,o,i);let h;try{if(this.persistencePlugin&&this.serializableCache&&(this.logger.verbose("Persistence enabled, calling beforeCacheAccess"),h=new TokenCacheContext(this.serializableCache,!0),await this.persistencePlugin.beforeCacheAccess(h)),a&&!s&&d.account){const e=d.account.generateAccountKey();if(!this.cacheStorage.getAccount(e))return this.logger.warning("Account used to refresh tokens not in persistence, refreshed tokens will not be stored in the cache"),await ResponseHandler.generateAuthenticationResult(this.cryptoObj,t,d,!1,n,l,u,void 0,c)}await this.cacheStorage.saveCacheRecord(d,n.correlationId,n.storeInCache)}finally{this.persistencePlugin&&this.serializableCache&&h&&(this.logger.verbose("Persistence enabled, calling afterCacheAccess"),await this.persistencePlugin.afterCacheAccess(h))}return ResponseHandler.generateAuthenticationResult(this.cryptoObj,t,d,!1,n,l,u,e,c)}generateCacheRecord(e,t,r,n,i,o,a){const s=t.getPreferredCache();if(!s)throw createClientAuthError(kr);const c=getTenantIdFromIdTokenClaims(i);let l,u;e.id_token&&i&&(l=function createIdTokenEntity(e,t,r,n,i){return{credentialType:ee.ID_TOKEN,homeAccountId:e,environment:t,clientId:n,secret:r,realm:i}}(this.homeAccountIdentifier,s,e.id_token,this.clientId,c||""),u=function buildAccountToCache(e,t,r,n,i,o,a,s,c,l,u){u?.verbose("setCachedAccount called");const d=e.getAccountKeys().find((e=>e.startsWith(r)));let h=null;d&&(h=e.getAccount(d));const g=h||AccountEntity.createAccount({homeAccountId:r,idTokenClaims:i,clientInfo:o,environment:a,cloudGraphHostName:c?.cloud_graph_host_name,msGraphHost:c?.msgraph_host,nativeAccountId:l},t,n),p=g.tenantProfiles||[],f=s||g.realm;if(f&&!p.find((e=>e.tenantId===f))){const e=buildTenantProfile(r,g.localAccountId,f,i);p.push(e)}return g.tenantProfiles=p,g}(this.cacheStorage,t,this.homeAccountIdentifier,this.cryptoObj.base64Decode,i,e.client_info,s,c,a,void 0,this.logger));let d=null;if(e.access_token){const i=e.scope?ScopeSet.fromString(e.scope):new ScopeSet(n.scopes||[]),a=("string"==typeof e.expires_in?parseInt(e.expires_in,10):e.expires_in)||0,l=("string"==typeof e.ext_expires_in?parseInt(e.ext_expires_in,10):e.ext_expires_in)||0,u=("string"==typeof e.refresh_in?parseInt(e.refresh_in,10):e.refresh_in)||void 0,h=r+a,g=h+l,p=u&&u>0?r+u:void 0;d=function createAccessTokenEntity(e,t,r,n,i,o,a,s,c,l,u,d,h,g,p){const f={homeAccountId:e,credentialType:ee.ACCESS_TOKEN,secret:r,cachedAt:nowSeconds().toString(),expiresOn:a.toString(),extendedExpiresOn:s.toString(),environment:t,clientId:n,realm:i,target:o,tokenType:u||ue.BEARER};if(d&&(f.userAssertionHash=d),l&&(f.refreshOn=l.toString()),g&&(f.requestedClaims=g,f.requestedClaimsHash=p),f.tokenType?.toLowerCase()!==ue.BEARER.toLowerCase())switch(f.credentialType=ee.ACCESS_TOKEN_WITH_AUTH_SCHEME,f.tokenType){case ue.POP:const e=extractTokenClaims(r,c);if(!e?.cnf?.kid)throw createClientAuthError(Nr);f.keyId=e.cnf.kid;break;case ue.SSH:f.keyId=h}return f}(this.homeAccountIdentifier,s,e.access_token,this.clientId,c||t.tenant||"",i.printScopes(),h,g,this.cryptoObj.base64Decode,p,e.token_type,o,e.key_id,n.claims,n.requestedClaimsHash)}let h=null;if(e.refresh_token){let t;if(e.refresh_token_expires_in){t=r+("string"==typeof e.refresh_token_expires_in?parseInt(e.refresh_token_expires_in,10):e.refresh_token_expires_in)}h=function createRefreshTokenEntity(e,t,r,n,i,o,a){const s={credentialType:ee.REFRESH_TOKEN,homeAccountId:e,environment:t,clientId:n,secret:r};return o&&(s.userAssertionHash=o),i&&(s.familyId=i),a&&(s.expiresOn=a.toString()),s}(this.homeAccountIdentifier,s,e.refresh_token,this.clientId,e.foci,o,t)}let g=null;return e.foci&&(g={clientId:this.clientId,environment:s,familyId:e.foci}),{account:u,idToken:l,accessToken:d,refreshToken:h,appMetadata:g}}static async generateAuthenticationResult(e,t,r,n,i,o,a,s,c){let l,u,d=A.EMPTY_STRING,h=[],g=null,p=A.EMPTY_STRING;if(r.accessToken){if(r.accessToken.tokenType!==ue.POP||i.popKid)d=r.accessToken.secret;else{const t=new PopTokenGenerator(e),{secret:n,keyId:o}=r.accessToken;if(!o)throw createClientAuthError(Hr);d=await t.signPopToken(n,o,i)}h=ScopeSet.fromString(r.accessToken.target).asArray(),g=toDateFromSeconds(r.accessToken.expiresOn),l=toDateFromSeconds(r.accessToken.extendedExpiresOn),r.accessToken.refreshOn&&(u=toDateFromSeconds(r.accessToken.refreshOn))}r.appMetadata&&(p=r.appMetadata.familyId===re?re:"");const f=o?.oid||o?.sub||"",m=o?.tid||"";s?.spa_accountid&&r.account&&(r.account.nativeAccountId=s?.spa_accountid);const y=r.account?updateAccountTenantProfileData(r.account.getAccountInfo(),void 0,o,r.idToken?.secret):null;return{authority:t.canonicalAuthority,uniqueId:f,tenantId:m,scopes:h,account:y,idToken:r?.idToken?.secret||"",idTokenClaims:o||{},accessToken:d,fromCache:n,expiresOn:g,extExpiresOn:l,refreshOn:u,correlationId:i.correlationId,requestId:c||A.EMPTY_STRING,familyId:p,tokenType:r.accessToken?.tokenType||A.EMPTY_STRING,state:a?a.userRequestState:A.EMPTY_STRING,cloudGraphHostName:r.account?.cloudGraphHostName||A.EMPTY_STRING,msGraphHost:r.account?.msGraphHost||A.EMPTY_STRING,code:s?.spa_code,fromNativeBroker:!1}}}async function getClientAssertion(e,t,r){if("string"==typeof e)return e;return e({clientId:t,tokenEndpoint:r})}class AuthorizationCodeClient extends BaseClient{constructor(e,t){super(e,t),this.includeRedirectUri=!0,this.oidcDefaultScopes=this.config.authOptions.authority.options.OIDCOptions?.defaultScopes}async getAuthCodeUrl(e){this.performanceClient?.addQueueMeasurement(sn,e.correlationId);const t=await bn(this.createAuthCodeUrlQueryString.bind(this),hn,this.logger,this.performanceClient,e.correlationId)(e);return UrlString.appendQueryString(this.authority.authorizationEndpoint,t)}async acquireToken(e,t){if(this.performanceClient?.addQueueMeasurement(ln,e.correlationId),!e.code)throw createClientAuthError(mr);const r=nowSeconds(),n=await bn(this.executeTokenRequest.bind(this),un,this.logger,this.performanceClient,e.correlationId)(this.authority,e),i=n.headers?.[q],o=new ResponseHandler(this.config.authOptions.clientId,this.cacheManager,this.cryptoUtils,this.logger,this.config.serializableCache,this.config.persistencePlugin,this.performanceClient);return o.validateTokenResponse(n.body),bn(o.handleServerTokenResponse.bind(o),fn,this.logger,this.performanceClient,e.correlationId)(n.body,this.authority,r,e,t,void 0,void 0,void 0,i)}handleFragmentResponse(e,t){if(new ResponseHandler(this.config.authOptions.clientId,this.cacheManager,this.cryptoUtils,this.logger,null,null).validateServerAuthorizationCodeResponse(e,t),!e.code)throw createClientAuthError(Ur);return e}getLogoutUri(e){if(!e)throw createClientConfigurationError(Dt);const t=this.createLogoutUrlQueryString(e);return UrlString.appendQueryString(this.authority.endSessionEndpoint,t)}async executeTokenRequest(e,t){this.performanceClient?.addQueueMeasurement(un,t.correlationId);const r=this.createTokenQueryParameters(t),n=UrlString.appendQueryString(e.tokenEndpoint,r),i=await bn(this.createTokenRequestBody.bind(this),dn,this.logger,this.performanceClient,t.correlationId)(t);let o;if(t.clientInfo)try{const e=buildClientInfo(t.clientInfo,this.cryptoUtils.base64Decode);o={credential:`${e.uid}${X}${e.utid}`,type:jn}}catch(e){this.logger.verbose("Could not parse client info for CCS Header: "+e)}const a=this.createTokenRequestHeaders(o||t.ccsCredential),s=getRequestThumbprint(this.config.authOptions.clientId,t);return bn(this.executePostToTokenEndpoint.bind(this),Zr,this.logger,this.performanceClient,t.correlationId)(n,i,a,s,t.correlationId,Zr)}async createTokenRequestBody(e){this.performanceClient?.addQueueMeasurement(dn,e.correlationId);const t=new RequestParameterBuilder(e.correlationId,this.performanceClient);if(t.addClientId(e.embeddedClientId||e.tokenBodyParameters?.[yt]||this.config.authOptions.clientId),this.includeRedirectUri?t.addRedirectUri(e.redirectUri):RequestValidator.validateRedirectUri(e.redirectUri),t.addScopes(e.scopes,!0,this.oidcDefaultScopes),t.addAuthorizationCode(e.code),t.addLibraryInfo(this.config.libraryInfo),t.addApplicationTelemetry(this.config.telemetry.application),t.addThrottling(),this.serverTelemetryManager&&!isOidcProtocolMode(this.config)&&t.addServerTelemetry(this.serverTelemetryManager),e.codeVerifier&&t.addCodeVerifier(e.codeVerifier),this.config.clientCredentials.clientSecret&&t.addClientSecret(this.config.clientCredentials.clientSecret),this.config.clientCredentials.clientAssertion){const r=this.config.clientCredentials.clientAssertion;t.addClientAssertion(await getClientAssertion(r.assertion,this.config.authOptions.clientId,e.resourceRequestUri)),t.addClientAssertionType(r.assertionType)}if(t.addGrantType($),t.addClientInfo(),e.authenticationScheme===ue.POP){const r=new PopTokenGenerator(this.cryptoUtils,this.performanceClient);let n;if(e.popKid)n=this.cryptoUtils.encodeKid(e.popKid);else{n=(await bn(r.generateCnf.bind(r),gn,this.logger,this.performanceClient,e.correlationId)(e,this.logger)).reqCnfString}t.addPopToken(n)}else if(e.authenticationScheme===ue.SSH){if(!e.sshJwk)throw createClientConfigurationError(zt);t.addSshJwk(e.sshJwk)}let r;if((!StringUtils.isEmptyObj(e.claims)||this.config.authOptions.clientCapabilities&&this.config.authOptions.clientCapabilities.length>0)&&t.addClaims(e.claims,this.config.authOptions.clientCapabilities),e.clientInfo)try{const t=buildClientInfo(e.clientInfo,this.cryptoUtils.base64Decode);r={credential:`${t.uid}${X}${t.utid}`,type:jn}}catch(e){this.logger.verbose("Could not parse client info for CCS Header: "+e)}else r=e.ccsCredential;if(this.config.systemOptions.preventCorsPreflight&&r)switch(r.type){case jn:try{const e=buildClientInfoFromHomeAccountId(r.credential);t.addCcsOid(e)}catch(e){this.logger.verbose("Could not parse home account ID for CCS Header: "+e)}break;case $n:t.addCcsUpn(r.credential)}return e.embeddedClientId&&t.addBrokerParameters({brokerClientId:this.config.authOptions.clientId,brokerRedirectUri:this.config.authOptions.redirectUri}),e.tokenBodyParameters&&t.addExtraQueryParameters(e.tokenBodyParameters),!e.enableSpaAuthorizationCode||e.tokenBodyParameters&&e.tokenBodyParameters[St]||t.addExtraQueryParameters({[St]:"1"}),t.createQueryString()}async createAuthCodeUrlQueryString(e){const t=e.correlationId||this.config.cryptoInterface.createNewGuid();this.performanceClient?.addQueueMeasurement(hn,t);const r=new RequestParameterBuilder(t,this.performanceClient);r.addClientId(e.embeddedClientId||e.extraQueryParameters?.[yt]||this.config.authOptions.clientId);const n=[...e.scopes||[],...e.extraScopesToConsent||[]];if(r.addScopes(n,!0,this.oidcDefaultScopes),r.addRedirectUri(e.redirectUri),r.addCorrelationId(t),r.addResponseMode(e.responseMode),r.addResponseTypeCode(),r.addLibraryInfo(this.config.libraryInfo),isOidcProtocolMode(this.config)||r.addApplicationTelemetry(this.config.telemetry.application),r.addClientInfo(),e.codeChallenge&&e.codeChallengeMethod&&r.addCodeChallengeParams(e.codeChallenge,e.codeChallengeMethod),e.prompt&&r.addPrompt(e.prompt),e.domainHint&&(r.addDomainHint(e.domainHint),this.performanceClient?.addFields({domainHintFromRequest:!0},t)),this.performanceClient?.addFields({prompt:e.prompt},t),e.prompt!==B.SELECT_ACCOUNT)if(e.sid&&e.prompt===B.NONE)this.logger.verbose("createAuthCodeUrlQueryString: Prompt is none, adding sid from request"),r.addSid(e.sid),this.performanceClient?.addFields({sidFromRequest:!0},t);else if(e.account){const n=this.extractAccountSid(e.account);let i=this.extractLoginHint(e.account);if(i&&e.domainHint&&(this.logger.warning('AuthorizationCodeClient.createAuthCodeUrlQueryString: "domainHint" param is set, skipping opaque "login_hint" claim. Please consider not passing domainHint'),i=null),i){this.logger.verbose("createAuthCodeUrlQueryString: login_hint claim present on account"),r.addLoginHint(i),this.performanceClient?.addFields({loginHintFromClaim:!0},t);try{const t=buildClientInfoFromHomeAccountId(e.account.homeAccountId);r.addCcsOid(t)}catch(e){this.logger.verbose("createAuthCodeUrlQueryString: Could not parse home account ID for CCS Header")}}else if(n&&e.prompt===B.NONE){this.logger.verbose("createAuthCodeUrlQueryString: Prompt is none, adding sid from account"),r.addSid(n),this.performanceClient?.addFields({sidFromClaim:!0},t);try{const t=buildClientInfoFromHomeAccountId(e.account.homeAccountId);r.addCcsOid(t)}catch(e){this.logger.verbose("createAuthCodeUrlQueryString: Could not parse home account ID for CCS Header")}}else if(e.loginHint)this.logger.verbose("createAuthCodeUrlQueryString: Adding login_hint from request"),r.addLoginHint(e.loginHint),r.addCcsUpn(e.loginHint),this.performanceClient?.addFields({loginHintFromRequest:!0},t);else if(e.account.username){this.logger.verbose("createAuthCodeUrlQueryString: Adding login_hint from account"),r.addLoginHint(e.account.username),this.performanceClient?.addFields({loginHintFromUpn:!0},t);try{const t=buildClientInfoFromHomeAccountId(e.account.homeAccountId);r.addCcsOid(t)}catch(e){this.logger.verbose("createAuthCodeUrlQueryString: Could not parse home account ID for CCS Header")}}}else e.loginHint&&(this.logger.verbose("createAuthCodeUrlQueryString: No account, adding login_hint from request"),r.addLoginHint(e.loginHint),r.addCcsUpn(e.loginHint),this.performanceClient?.addFields({loginHintFromRequest:!0},t));else this.logger.verbose("createAuthCodeUrlQueryString: Prompt is select_account, ignoring account hints");if(e.nonce&&r.addNonce(e.nonce),e.state&&r.addState(e.state),(e.claims||this.config.authOptions.clientCapabilities&&this.config.authOptions.clientCapabilities.length>0)&&r.addClaims(e.claims,this.config.authOptions.clientCapabilities),e.embeddedClientId&&r.addBrokerParameters({brokerClientId:this.config.authOptions.clientId,brokerRedirectUri:this.config.authOptions.redirectUri}),this.addExtraQueryParams(e,r),e.platformBroker&&(r.addNativeBroker(),e.authenticationScheme===ue.POP)){const t=new PopTokenGenerator(this.cryptoUtils);let n;if(e.popKid)n=this.cryptoUtils.encodeKid(e.popKid);else{n=(await bn(t.generateCnf.bind(t),gn,this.logger,this.performanceClient,e.correlationId)(e,this.logger)).reqCnfString}r.addPopToken(n)}return r.createQueryString()}createLogoutUrlQueryString(e){const t=new RequestParameterBuilder(e.correlationId,this.performanceClient);return e.postLogoutRedirectUri&&t.addPostLogoutRedirectUri(e.postLogoutRedirectUri),e.correlationId&&t.addCorrelationId(e.correlationId),e.idTokenHint&&t.addIdTokenHint(e.idTokenHint),e.state&&t.addState(e.state),e.logoutHint&&t.addLogoutHint(e.logoutHint),this.addExtraQueryParams(e,t),t.createQueryString()}addExtraQueryParams(e,t){!(e.extraQueryParameters&&e.extraQueryParameters.hasOwnProperty("instance_aware"))&&this.config.authOptions.instanceAware&&(e.extraQueryParameters=e.extraQueryParameters||{},e.extraQueryParameters.instance_aware="true"),e.extraQueryParameters&&t.addExtraQueryParameters(e.extraQueryParameters)}extractAccountSid(e){return e.idTokenClaims?.sid||null}extractLoginHint(e){return e.idTokenClaims?.login_hint||null}}class RefreshTokenClient extends BaseClient{constructor(e,t){super(e,t)}async acquireToken(e){this.performanceClient?.addQueueMeasurement(en,e.correlationId);const t=nowSeconds(),r=await bn(this.executeTokenRequest.bind(this),Xr,this.logger,this.performanceClient,e.correlationId)(e,this.authority),n=r.headers?.[q],i=new ResponseHandler(this.config.authOptions.clientId,this.cacheManager,this.cryptoUtils,this.logger,this.config.serializableCache,this.config.persistencePlugin);return i.validateTokenResponse(r.body),bn(i.handleServerTokenResponse.bind(i),fn,this.logger,this.performanceClient,e.correlationId)(r.body,this.authority,t,e,void 0,void 0,!0,e.forceCache,n)}async acquireTokenByRefreshToken(e){if(!e)throw createClientConfigurationError(Lt);if(this.performanceClient?.addQueueMeasurement(rn,e.correlationId),!e.account)throw createClientAuthError(vr);if(this.cacheManager.isAppMetadataFOCI(e.account.environment))try{return await bn(this.acquireTokenWithCachedRefreshToken.bind(this),tn,this.logger,this.performanceClient,e.correlationId)(e,!0)}catch(t){const r=t instanceof InteractionRequiredAuthError&&t.errorCode===Kn,n=t instanceof ServerError&&t.errorCode===fe&&t.subError===me;if(r||n)return bn(this.acquireTokenWithCachedRefreshToken.bind(this),tn,this.logger,this.performanceClient,e.correlationId)(e,!1);throw t}return bn(this.acquireTokenWithCachedRefreshToken.bind(this),tn,this.logger,this.performanceClient,e.correlationId)(e,!1)}async acquireTokenWithCachedRefreshToken(e,t){this.performanceClient?.addQueueMeasurement(tn,e.correlationId);const r=((e,t,r,n,i)=>(...o)=>{r.trace(`Executing function ${t}`);const a=n?.startMeasurement(t,i);if(i){const e=t+"CallCount";n?.incrementFields({[e]:1},i)}try{const n=e(...o);return a?.end({success:!0}),r.trace(`Returning result from ${t}`),n}catch(e){r.trace(`Error occurred in ${t}`);try{r.trace(JSON.stringify(e))}catch(e){r.trace("Unable to print error message.")}throw a?.end({success:!1},e),e}})(this.cacheManager.getRefreshToken.bind(this.cacheManager),En,this.logger,this.performanceClient,e.correlationId)(e.account,t,void 0,this.performanceClient,e.correlationId);if(!r)throw createInteractionRequiredAuthError(Kn);if(r.expiresOn&&isTokenExpired(r.expiresOn,e.refreshTokenExpirationOffsetSeconds||300))throw this.performanceClient?.addFields({rtExpiresOnMs:Number(r.expiresOn)},e.correlationId),createInteractionRequiredAuthError(Gn);const n={...e,refreshToken:r.secret,authenticationScheme:e.authenticationScheme||ue.BEARER,ccsCredential:{credential:e.account.homeAccountId,type:jn}};try{return await bn(this.acquireToken.bind(this),en,this.logger,this.performanceClient,e.correlationId)(n)}catch(t){if(t instanceof InteractionRequiredAuthError&&(this.performanceClient?.addFields({rtExpiresOnMs:Number(r.expiresOn)},e.correlationId),t.subError===Vn)){this.logger.verbose("acquireTokenWithRefreshToken: bad refresh token, removing from cache");const e=generateCredentialKey(r);this.cacheManager.removeRefreshToken(e)}throw t}}async executeTokenRequest(e,t){this.performanceClient?.addQueueMeasurement(Xr,e.correlationId);const r=this.createTokenQueryParameters(e),n=UrlString.appendQueryString(t.tokenEndpoint,r),i=await bn(this.createTokenRequestBody.bind(this),nn,this.logger,this.performanceClient,e.correlationId)(e),o=this.createTokenRequestHeaders(e.ccsCredential),a=getRequestThumbprint(this.config.authOptions.clientId,e);return bn(this.executePostToTokenEndpoint.bind(this),Jr,this.logger,this.performanceClient,e.correlationId)(n,i,o,a,e.correlationId,Jr)}async createTokenRequestBody(e){this.performanceClient?.addQueueMeasurement(nn,e.correlationId);const t=e.correlationId,r=new RequestParameterBuilder(t,this.performanceClient);if(r.addClientId(e.embeddedClientId||e.tokenBodyParameters?.[yt]||this.config.authOptions.clientId),e.redirectUri&&r.addRedirectUri(e.redirectUri),r.addScopes(e.scopes,!0,this.config.authOptions.authority.options.OIDCOptions?.defaultScopes),r.addGrantType(G),r.addClientInfo(),r.addLibraryInfo(this.config.libraryInfo),r.addApplicationTelemetry(this.config.telemetry.application),r.addThrottling(),this.serverTelemetryManager&&!isOidcProtocolMode(this.config)&&r.addServerTelemetry(this.serverTelemetryManager),r.addRefreshToken(e.refreshToken),this.config.clientCredentials.clientSecret&&r.addClientSecret(this.config.clientCredentials.clientSecret),this.config.clientCredentials.clientAssertion){const t=this.config.clientCredentials.clientAssertion;r.addClientAssertion(await getClientAssertion(t.assertion,this.config.authOptions.clientId,e.resourceRequestUri)),r.addClientAssertionType(t.assertionType)}if(e.authenticationScheme===ue.POP){const t=new PopTokenGenerator(this.cryptoUtils,this.performanceClient);let n;if(e.popKid)n=this.cryptoUtils.encodeKid(e.popKid);else{n=(await bn(t.generateCnf.bind(t),gn,this.logger,this.performanceClient,e.correlationId)(e,this.logger)).reqCnfString}r.addPopToken(n)}else if(e.authenticationScheme===ue.SSH){if(!e.sshJwk)throw createClientConfigurationError(zt);r.addSshJwk(e.sshJwk)}if((!StringUtils.isEmptyObj(e.claims)||this.config.authOptions.clientCapabilities&&this.config.authOptions.clientCapabilities.length>0)&&r.addClaims(e.claims,this.config.authOptions.clientCapabilities),this.config.systemOptions.preventCorsPreflight&&e.ccsCredential)switch(e.ccsCredential.type){case jn:try{const t=buildClientInfoFromHomeAccountId(e.ccsCredential.credential);r.addCcsOid(t)}catch(e){this.logger.verbose("Could not parse home account ID for CCS Header: "+e)}break;case $n:r.addCcsUpn(e.ccsCredential.credential)}return e.embeddedClientId&&r.addBrokerParameters({brokerClientId:this.config.authOptions.clientId,brokerRedirectUri:this.config.authOptions.redirectUri}),e.tokenBodyParameters&&r.addExtraQueryParameters(e.tokenBodyParameters),r.createQueryString()}}class SilentFlowClient extends BaseClient{constructor(e,t){super(e,t)}async acquireCachedToken(e){this.performanceClient?.addQueueMeasurement(on,e.correlationId);let t=be;if(e.forceRefresh||!this.config.cacheOptions.claimsBasedCachingEnabled&&!StringUtils.isEmptyObj(e.claims))throw this.setCacheOutcome(_e,e.correlationId),createClientAuthError(Pr);if(!e.account)throw createClientAuthError(vr);const r=e.account.tenantId||function getTenantFromAuthorityString(e){const t=new UrlString(e).getUrlComponents(),r=t.PathSegments.slice(-1)[0]?.toLowerCase();switch(r){case H.COMMON:case H.ORGANIZATIONS:case H.CONSUMERS:return;default:return r}}(e.authority),n=this.cacheManager.getTokenKeys(),i=this.cacheManager.getAccessToken(e.account,e,n,r,this.performanceClient,e.correlationId);if(!i)throw this.setCacheOutcome(Re,e.correlationId),createClientAuthError(Pr);if(function wasClockTurnedBack(e){return Number(e)>nowSeconds()}(i.cachedAt)||isTokenExpired(i.expiresOn,this.config.systemOptions.tokenRenewalOffsetSeconds))throw this.setCacheOutcome(Oe,e.correlationId),createClientAuthError(Pr);i.refreshOn&&isTokenExpired(i.refreshOn,0)&&(t=Pe);const o=e.authority||this.authority.getPreferredCache(),a={account:this.cacheManager.readAccountFromCache(e.account),accessToken:i,idToken:this.cacheManager.getIdToken(e.account,n,r,this.performanceClient,e.correlationId),refreshToken:null,appMetadata:this.cacheManager.readAppMetadataFromCache(o)};return this.setCacheOutcome(t,e.correlationId),this.config.serverTelemetryManager&&this.config.serverTelemetryManager.incrementCacheHits(),[await bn(this.generateResultFromCacheRecord.bind(this),an,this.logger,this.performanceClient,e.correlationId)(a,e),t]}setCacheOutcome(e,t){this.serverTelemetryManager?.setCacheOutcome(e),this.performanceClient?.addFields({cacheOutcome:e},t),e!==be&&this.logger.info(`Token refresh is required due to cache outcome: ${e}`)}async generateResultFromCacheRecord(e,t){let r;if(this.performanceClient?.addQueueMeasurement(an,t.correlationId),e.idToken&&(r=extractTokenClaims(e.idToken.secret,this.config.cryptoInterface.base64Decode)),t.maxAge||0===t.maxAge){const e=r?.auth_time;if(!e)throw createClientAuthError(dr);checkMaxAge(e,t.maxAge)}return ResponseHandler.generateAuthenticationResult(this.cryptoUtils,this.authority,e,!0,t,r)}}class NetworkUtils{static getNetworkResponse(e,t,r){return{headers:e,body:t,status:r}}static urlToHttpOptions(e){const t={protocol:e.protocol,hostname:e.hostname&&e.hostname.startsWith("[")?e.hostname.slice(1,-1):e.hostname,hash:e.hash,search:e.search,pathname:e.pathname,path:`${e.pathname||""}${e.search||""}`,href:e.href};return""!==e.port&&(t.port=Number(e.port)),(e.username||e.password)&&(t.auth=`${decodeURIComponent(e.username)}:${decodeURIComponent(e.password)}`),t}}var Zn=r(58611),Xn=r(65692);class HttpClient{constructor(e,t){this.proxyUrl=e||"",this.customAgentOptions=t||{}}async sendGetRequestAsync(e,t,r){return this.proxyUrl?networkRequestViaProxy(e,this.proxyUrl,De,t,this.customAgentOptions,r):networkRequestViaHttps(e,De,t,this.customAgentOptions,r)}async sendPostRequestAsync(e,t){return this.proxyUrl?networkRequestViaProxy(e,this.proxyUrl,Be,t,this.customAgentOptions):networkRequestViaHttps(e,Be,t,this.customAgentOptions)}}const networkRequestViaProxy=(e,t,r,n,i,o)=>{const a=new URL(e),s=new URL(t),c=n?.headers||{},l={host:s.hostname,port:s.port,method:"CONNECT",path:a.hostname,headers:c};i&&Object.keys(i).length&&(l.agent=new Zn.Agent(i));let u="";if(r===Be){const e=n?.body||"";u=`Content-Type: application/x-www-form-urlencoded\r\nContent-Length: ${e.length}\r\n\r\n${e}`}else o&&(l.timeout=o);const d=`${r.toUpperCase()} ${a.href} HTTP/1.1\r\nHost: ${a.host}\r\nConnection: close\r\n`+u+"\r\n";return new Promise(((e,t)=>{const r=Zn.request(l);o&&r.on("timeout",(()=>{r.destroy(),t(new Error("Request time out"))})),r.end(),r.on("connect",((n,i)=>{const o=n?.statusCode||Fe.SERVER_ERROR;(o<Fe.SUCCESS_RANGE_START||o>Fe.SUCCESS_RANGE_END)&&(r.destroy(),i.destroy(),t(new Error(`Error connecting to proxy. Http status code: ${n.statusCode}. Http status message: ${n?.statusMessage||"Unknown"}`))),i.write(d);const a=[];i.on("data",(e=>{a.push(e)})),i.on("end",(()=>{const t=Buffer.concat([...a]).toString().split("\r\n"),n=parseInt(t[0].split(" ")[1]),i=t[0].split(" ").slice(2).join(" "),o=t[t.length-1],s=t.slice(1,t.length-2),c=new Map;s.forEach((e=>{const t=e.split(new RegExp(/:\s(.*)/s)),r=t[0];let n=t[1];try{const e=JSON.parse(n);e&&"object"==typeof e&&(n=e)}catch(e){}c.set(r,n)}));const l=Object.fromEntries(c),u=NetworkUtils.getNetworkResponse(l,parseBody(n,i,l,o),n);(n<I||n>S)&&u.body.error!==Ge&&r.destroy(),e(u)})),i.on("error",(e=>{r.destroy(),i.destroy(),t(new Error(e.toString()))}))})),r.on("error",(e=>{r.destroy(),t(new Error(e.toString()))}))}))},networkRequestViaHttps=(e,t,r,n,i)=>{const o=t===Be,a=r?.body||"",s=new URL(e),c={method:t,headers:r?.headers||{},...NetworkUtils.urlToHttpOptions(s)};return n&&Object.keys(n).length&&(c.agent=new Xn.Agent(n)),o?c.headers={...c.headers,"Content-Length":a.length}:i&&(c.timeout=i),new Promise(((e,t)=>{let r;r="http:"===c.protocol?Zn.request(c):Xn.request(c),o&&r.write(a),i&&r.on("timeout",(()=>{r.destroy(),t(new Error("Request time out"))})),r.end(),r.on("response",(t=>{const n=t.headers,i=t.statusCode,o=t.statusMessage,a=[];t.on("data",(e=>{a.push(e)})),t.on("end",(()=>{const t=Buffer.concat([...a]).toString(),s=n,c=NetworkUtils.getNetworkResponse(s,parseBody(i,o,s,t),i);(i<I||i>S)&&c.body.error!==Ge&&r.destroy(),e(c)}))})),r.on("error",(e=>{r.destroy(),t(new Error(e.toString()))}))}))},parseBody=(e,t,r,n)=>{let i;try{i=JSON.parse(n)}catch(n){let o,a;e>=w&&e<=k?(o="client_error",a="A client"):e>=b&&e<=_?(o="server_error",a="A server"):(o="unknown_error",a="An unknown"),i={error:o,error_description:`${a} error occured.\nHttp status code: ${e}\nHttp status message: ${t||"Unknown"}\nHeaders: ${JSON.stringify(r)}`}}return i},ei="invalid_file_extension",ti="invalid_file_path",ri="invalid_managed_identity_id_type",ni="invalid_secret",ii="missing_client_id",oi="network_unavailable",ai="platform_not_supported",si="unable_to_create_azure_arc",ci="unable_to_create_cloud_shell",li="unable_to_create_source",ui="unable_to_read_secret_file",di="user_assigned_not_available_at_runtime",hi="www_authenticate_header_missing",gi="www_authenticate_header_unsupported_format",pi={[Me]:"azure_pod_identity_authority_host_url_malformed",[Ne]:"identity_endpoint_url_malformed",[Ue]:"imds_endpoint_url_malformed",[qe]:"msi_endpoint_url_malformed"},fi={[ei]:"The file path in the WWW-Authenticate header does not contain a .key file.",[ti]:"The file path in the WWW-Authenticate header is not in a valid Windows or Linux Format.",[ri]:"More than one ManagedIdentityIdType was provided.",[ni]:"The secret in the file on the file path in the WWW-Authenticate header is greater than 4096 bytes.",[ai]:"The platform is not supported by Azure Arc. Azure Arc only supports Windows and Linux.",[ii]:"A ManagedIdentityId id was not provided.",[pi.AZURE_POD_IDENTITY_AUTHORITY_HOST]:`The Managed Identity's '${Me}' environment variable is malformed.`,[pi.IDENTITY_ENDPOINT]:`The Managed Identity's '${Ne}' environment variable is malformed.`,[pi.IMDS_ENDPOINT]:`The Managed Identity's '${Ue}' environment variable is malformed.`,[pi.MSI_ENDPOINT]:`The Managed Identity's '${qe}' environment variable is malformed.`,[oi]:"Authentication unavailable. The request to the managed identity endpoint timed out.",[si]:"Azure Arc Managed Identities can only be system assigned.",[ci]:"Cloud Shell Managed Identities can only be system assigned.",[li]:"Unable to create a Managed Identity source based on environment variables.",[ui]:"Unable to read the secret file.",[di]:"Service Fabric user assigned managed identity ClientId or ResourceId is not configurable at runtime.",[hi]:"A 401 response was received form the Azure Arc Managed Identity, but the www-authenticate header is missing.",[gi]:"A 401 response was received form the Azure Arc Managed Identity, but the www-authenticate header is in an unsupported format."};class ManagedIdentityError extends AuthError{constructor(e){super(e,fi[e]),this.name="ManagedIdentityError",Object.setPrototypeOf(this,ManagedIdentityError.prototype)}}function createManagedIdentityError(e){return new ManagedIdentityError(e)}const mi={code:"invalid_loopback_server_address_type",desc:"Loopback server address is not type string. This is unexpected."},yi={code:"unable_to_load_redirectUrl",desc:"Loopback server callback was invoked without a url. This is unexpected."},Ci={code:"no_auth_code_in_response",desc:"No auth code found in the server response. Please check your network trace to determine what happened."},Ai={code:"no_loopback_server_exists",desc:"No loopback server exists yet."},Ti={code:"loopback_server_already_exists",desc:"Loopback server already exists. Cannot create another."},Ii={code:"loopback_server_timeout",desc:"Timed out waiting for auth code listener to be registered."},Si={code:"state_not_found",desc:"State not found. Please verify that the request originated from msal."},vi={code:"thumbprint_missing_from_client_certificate",desc:"Client certificate does not contain a SHA-1 or SHA-256 thumbprint."};class NodeAuthError extends AuthError{constructor(e,t){super(e,t),this.name="NodeAuthError"}static createInvalidLoopbackAddressTypeError(){return new NodeAuthError(mi.code,`${mi.desc}`)}static createUnableToLoadRedirectUrlError(){return new NodeAuthError(yi.code,`${yi.desc}`)}static createNoAuthCodeInResponseError(){return new NodeAuthError(Ci.code,`${Ci.desc}`)}static createNoLoopbackServerExistsError(){return new NodeAuthError(Ai.code,`${Ai.desc}`)}static createLoopbackServerAlreadyExistsError(){return new NodeAuthError(Ti.code,`${Ti.desc}`)}static createLoopbackServerTimeoutError(){return new NodeAuthError(Ii.code,`${Ii.desc}`)}static createStateNotFoundError(){return new NodeAuthError(Si.code,Si.desc)}static createThumbprintMissingError(){return new NodeAuthError(vi.code,vi.desc)}}const wi={clientId:A.EMPTY_STRING,authority:A.DEFAULT_AUTHORITY,clientSecret:A.EMPTY_STRING,clientAssertion:A.EMPTY_STRING,clientCertificate:{thumbprint:A.EMPTY_STRING,thumbprintSha256:A.EMPTY_STRING,privateKey:A.EMPTY_STRING,x5c:A.EMPTY_STRING},knownAuthorities:[],cloudDiscoveryMetadata:A.EMPTY_STRING,authorityMetadata:A.EMPTY_STRING,clientCapabilities:[],protocolMode:Vr,azureCloudOptions:{azureCloudInstance:Yr,tenant:A.EMPTY_STRING},skipAuthorityMetadataCache:!1},ki={claimsBasedCachingEnabled:!1},Ei={loggerCallback:()=>{},piiLoggingEnabled:!1,logLevel:kt.Info},bi={loggerOptions:Ei,networkClient:new HttpClient,proxyUrl:A.EMPTY_STRING,customAgentOptions:{},disableInternalRetries:!1},_i={application:{appName:A.EMPTY_STRING,appVersion:A.EMPTY_STRING}};var Ri=r(76982),Oi=r.n(Ri);const Pi=new Uint8Array(256);let Mi=Pi.length;function rng(){return Mi>Pi.length-16&&(Oi().randomFillSync(Pi),Mi=0),Pi.slice(Mi,Mi+=16)}const Ni=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000)$/i;const Ui=function validate(e){return"string"==typeof e&&Ni.test(e)},qi=[];for(let e=0;e<256;++e)qi.push((e+256).toString(16).substr(1));const xi=function stringify(e,t=0){const r=(qi[e[t+0]]+qi[e[t+1]]+qi[e[t+2]]+qi[e[t+3]]+"-"+qi[e[t+4]]+qi[e[t+5]]+"-"+qi[e[t+6]]+qi[e[t+7]]+"-"+qi[e[t+8]]+qi[e[t+9]]+"-"+qi[e[t+10]]+qi[e[t+11]]+qi[e[t+12]]+qi[e[t+13]]+qi[e[t+14]]+qi[e[t+15]]).toLowerCase();if(!Ui(r))throw TypeError("Stringified UUID is invalid");return r};const Hi=function v4(e,t,r){const n=(e=e||{}).random||(e.rng||rng)();if(n[6]=15&n[6]|64,n[8]=63&n[8]|128,t){r=r||0;for(let e=0;e<16;++e)t[r+e]=n[e];return t}return xi(n)};class GuidGenerator{generateGuid(){return Hi()}isGuid(e){return/^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(e)}}class EncodingUtils{static base64Encode(e,t){return Buffer.from(e,t).toString("base64")}static base64EncodeUrl(e,t){return EncodingUtils.base64Encode(e,t).replace(/=/g,A.EMPTY_STRING).replace(/\+/g,"-").replace(/\//g,"_")}static base64Decode(e){return Buffer.from(e,"base64").toString("utf8")}static base64DecodeUrl(e){let t=e.replace(/-/g,"+").replace(/_/g,"/");for(;t.length%4;)t+="=";return EncodingUtils.base64Decode(t)}}class HashUtils{sha256(e){return Ri.createHash(je).update(e).digest()}}class PkceGenerator{constructor(){this.hashUtils=new HashUtils}async generatePkceCodes(){const e=this.generateCodeVerifier();return{verifier:e,challenge:this.generateCodeChallengeFromVerifier(e)}}generateCodeVerifier(){const e=[],t=256-256%$e.length;for(;e.length<=32;){const r=Ri.randomBytes(1)[0];if(r>=t)continue;const n=r%$e.length;e.push($e[n])}const r=e.join(A.EMPTY_STRING);return EncodingUtils.base64EncodeUrl(r)}generateCodeChallengeFromVerifier(e){return EncodingUtils.base64EncodeUrl(this.hashUtils.sha256(e).toString("base64"),"base64")}}class CryptoProvider{constructor(){this.pkceGenerator=new PkceGenerator,this.guidGenerator=new GuidGenerator,this.hashUtils=new HashUtils}base64UrlEncode(){throw new Error("Method not implemented.")}encodeKid(){throw new Error("Method not implemented.")}createNewGuid(){return this.guidGenerator.generateGuid()}base64Encode(e){return EncodingUtils.base64Encode(e)}base64Decode(e){return EncodingUtils.base64Decode(e)}generatePkceCodes(){return this.pkceGenerator.generatePkceCodes()}getPublicKeyThumbprint(){throw new Error("Method not implemented.")}removeTokenBindingKey(){throw new Error("Method not implemented.")}clearKeystore(){throw new Error("Method not implemented.")}signJwt(){throw new Error("Method not implemented.")}async hashString(e){return EncodingUtils.base64EncodeUrl(this.hashUtils.sha256(e).toString("base64"),"base64")}}class Deserializer{static deserializeJSONBlob(e){return e?JSON.parse(e):{}}static deserializeAccounts(e){const t={};return e&&Object.keys(e).map((function(r){const n=e[r],i={homeAccountId:n.home_account_id,environment:n.environment,realm:n.realm,localAccountId:n.local_account_id,username:n.username,authorityType:n.authority_type,name:n.name,clientInfo:n.client_info,lastModificationTime:n.last_modification_time,lastModificationApp:n.last_modification_app,tenantProfiles:n.tenantProfiles?.map((e=>JSON.parse(e)))},o=new AccountEntity;CacheManager.toObject(o,i),t[r]=o})),t}static deserializeIdTokens(e){const t={};return e&&Object.keys(e).map((function(r){const n=e[r],i={homeAccountId:n.home_account_id,environment:n.environment,credentialType:n.credential_type,clientId:n.client_id,secret:n.secret,realm:n.realm};t[r]=i})),t}static deserializeAccessTokens(e){const t={};return e&&Object.keys(e).map((function(r){const n=e[r],i={homeAccountId:n.home_account_id,environment:n.environment,credentialType:n.credential_type,clientId:n.client_id,secret:n.secret,realm:n.realm,target:n.target,cachedAt:n.cached_at,expiresOn:n.expires_on,extendedExpiresOn:n.extended_expires_on,refreshOn:n.refresh_on,keyId:n.key_id,tokenType:n.token_type,requestedClaims:n.requestedClaims,requestedClaimsHash:n.requestedClaimsHash,userAssertionHash:n.userAssertionHash};t[r]=i})),t}static deserializeRefreshTokens(e){const t={};return e&&Object.keys(e).map((function(r){const n=e[r],i={homeAccountId:n.home_account_id,environment:n.environment,credentialType:n.credential_type,clientId:n.client_id,secret:n.secret,familyId:n.family_id,target:n.target,realm:n.realm};t[r]=i})),t}static deserializeAppMetadata(e){const t={};return e&&Object.keys(e).map((function(r){const n=e[r];t[r]={clientId:n.client_id,environment:n.environment,familyId:n.family_id}})),t}static deserializeAllCache(e){return{accounts:e.Account?this.deserializeAccounts(e.Account):{},idTokens:e.IdToken?this.deserializeIdTokens(e.IdToken):{},accessTokens:e.AccessToken?this.deserializeAccessTokens(e.AccessToken):{},refreshTokens:e.RefreshToken?this.deserializeRefreshTokens(e.RefreshToken):{},appMetadata:e.AppMetadata?this.deserializeAppMetadata(e.AppMetadata):{}}}}class Serializer{static serializeJSONBlob(e){return JSON.stringify(e)}static serializeAccounts(e){const t={};return Object.keys(e).map((function(r){const n=e[r];t[r]={home_account_id:n.homeAccountId,environment:n.environment,realm:n.realm,local_account_id:n.localAccountId,username:n.username,authority_type:n.authorityType,name:n.name,client_info:n.clientInfo,last_modification_time:n.lastModificationTime,last_modification_app:n.lastModificationApp,tenantProfiles:n.tenantProfiles?.map((e=>JSON.stringify(e)))}})),t}static serializeIdTokens(e){const t={};return Object.keys(e).map((function(r){const n=e[r];t[r]={home_account_id:n.homeAccountId,environment:n.environment,credential_type:n.credentialType,client_id:n.clientId,secret:n.secret,realm:n.realm}})),t}static serializeAccessTokens(e){const t={};return Object.keys(e).map((function(r){const n=e[r];t[r]={home_account_id:n.homeAccountId,environment:n.environment,credential_type:n.credentialType,client_id:n.clientId,secret:n.secret,realm:n.realm,target:n.target,cached_at:n.cachedAt,expires_on:n.expiresOn,extended_expires_on:n.extendedExpiresOn,refresh_on:n.refreshOn,key_id:n.keyId,token_type:n.tokenType,requestedClaims:n.requestedClaims,requestedClaimsHash:n.requestedClaimsHash,userAssertionHash:n.userAssertionHash}})),t}static serializeRefreshTokens(e){const t={};return Object.keys(e).map((function(r){const n=e[r];t[r]={home_account_id:n.homeAccountId,environment:n.environment,credential_type:n.credentialType,client_id:n.clientId,secret:n.secret,family_id:n.familyId,target:n.target,realm:n.realm}})),t}static serializeAppMetadata(e){const t={};return Object.keys(e).map((function(r){const n=e[r];t[r]={client_id:n.clientId,environment:n.environment,family_id:n.familyId}})),t}static serializeAllCache(e){return{Account:this.serializeAccounts(e.accounts),IdToken:this.serializeIdTokens(e.idTokens),AccessToken:this.serializeAccessTokens(e.accessTokens),RefreshToken:this.serializeRefreshTokens(e.refreshTokens),AppMetadata:this.serializeAppMetadata(e.appMetadata)}}}class NodeStorage extends CacheManager{constructor(e,t,r,n){super(t,r,e,n),this.cache={},this.changeEmitters=[],this.logger=e}registerChangeEmitter(e){this.changeEmitters.push(e)}emitChange(){this.changeEmitters.forEach((e=>e.call(null)))}cacheToInMemoryCache(e){const t={accounts:{},idTokens:{},accessTokens:{},refreshTokens:{},appMetadata:{}};for(const r in e){const n=e[r];if("object"==typeof n)if(n instanceof AccountEntity)t.accounts[r]=n;else if(isIdTokenEntity(n))t.idTokens[r]=n;else if(isAccessTokenEntity(n))t.accessTokens[r]=n;else if(isRefreshTokenEntity(n))t.refreshTokens[r]=n;else{if(!isAppMetadataEntity(r,n))continue;t.appMetadata[r]=n}}return t}inMemoryCacheToCache(e){let t=this.getCache();return t={...t,...e.accounts,...e.idTokens,...e.accessTokens,...e.refreshTokens,...e.appMetadata},t}getInMemoryCache(){this.logger.trace("Getting in-memory cache");return this.cacheToInMemoryCache(this.getCache())}setInMemoryCache(e){this.logger.trace("Setting in-memory cache");const t=this.inMemoryCacheToCache(e);this.setCache(t),this.emitChange()}getCache(){return this.logger.trace("Getting cache key-value store"),this.cache}setCache(e){this.logger.trace("Setting cache key value store"),this.cache=e,this.emitChange()}getItem(e){this.logger.tracePii(`Item key: ${e}`);return this.getCache()[e]}setItem(e,t){this.logger.tracePii(`Item key: ${e}`);const r=this.getCache();r[e]=t,this.setCache(r)}getAccountKeys(){const e=this.getInMemoryCache();return Object.keys(e.accounts)}getTokenKeys(){const e=this.getInMemoryCache();return{idToken:Object.keys(e.idTokens),accessToken:Object.keys(e.accessTokens),refreshToken:Object.keys(e.refreshTokens)}}getAccount(e){return this.getItem(e)?Object.assign(new AccountEntity,this.getItem(e)):null}async setAccount(e){const t=e.generateAccountKey();this.setItem(t,e)}getIdTokenCredential(e){const t=this.getItem(e);return isIdTokenEntity(t)?t:null}async setIdTokenCredential(e){const t=generateCredentialKey(e);this.setItem(t,e)}getAccessTokenCredential(e){const t=this.getItem(e);return isAccessTokenEntity(t)?t:null}async setAccessTokenCredential(e){const t=generateCredentialKey(e);this.setItem(t,e)}getRefreshTokenCredential(e){const t=this.getItem(e);return isRefreshTokenEntity(t)?t:null}async setRefreshTokenCredential(e){const t=generateCredentialKey(e);this.setItem(t,e)}getAppMetadata(e){const t=this.getItem(e);return isAppMetadataEntity(e,t)?t:null}setAppMetadata(e){const t=function generateAppMetadataKey({environment:e,clientId:t}){return[te,e,t].join(Z).toLowerCase()}(e);this.setItem(t,e)}getServerTelemetry(e){const t=this.getItem(e);return t&&function isServerTelemetryEntity(e,t){const r=0===e.indexOf(le.CACHE_KEY);let n=!0;return t&&(n=t.hasOwnProperty("failedRequests")&&t.hasOwnProperty("errors")&&t.hasOwnProperty("cacheHits")),r&&n}(e,t)?t:null}setServerTelemetry(e,t){this.setItem(e,t)}getAuthorityMetadata(e){const t=this.getItem(e);return t&&function isAuthorityMetadataEntity(e,t){return!!t&&0===e.indexOf(ne)&&t.hasOwnProperty("aliases")&&t.hasOwnProperty("preferred_cache")&&t.hasOwnProperty("preferred_network")&&t.hasOwnProperty("canonical_authority")&&t.hasOwnProperty("authorization_endpoint")&&t.hasOwnProperty("token_endpoint")&&t.hasOwnProperty("issuer")&&t.hasOwnProperty("aliasesFromNetwork")&&t.hasOwnProperty("endpointsFromNetwork")&&t.hasOwnProperty("expiresAt")&&t.hasOwnProperty("jwks_uri")}(e,t)?t:null}getAuthorityMetadataKeys(){return this.getKeys().filter((e=>this.isAuthorityMetadata(e)))}setAuthorityMetadata(e,t){this.setItem(e,t)}getThrottlingCache(e){const t=this.getItem(e);return t&&function isThrottlingEntity(e,t){let r=!1;e&&(r=0===e.indexOf(ge));let n=!0;return t&&(n=t.hasOwnProperty("throttleTime")),r&&n}(e,t)?t:null}setThrottlingCache(e,t){this.setItem(e,t)}removeItem(e){this.logger.tracePii(`Item key: ${e}`);let t=!1;const r=this.getCache();return r[e]&&(delete r[e],t=!0),t&&(this.setCache(r),this.emitChange()),t}removeOutdatedAccount(e){this.removeItem(e)}containsKey(e){return this.getKeys().includes(e)}getKeys(){this.logger.trace("Retrieving all cache keys");const e=this.getCache();return[...Object.keys(e)]}clear(){this.logger.trace("Clearing cache entries created by MSAL");this.getKeys().forEach((e=>{this.removeItem(e)})),this.emitChange()}static generateInMemoryCache(e){return Deserializer.deserializeAllCache(Deserializer.deserializeJSONBlob(e))}static generateJsonCache(e){return Serializer.serializeAllCache(e)}updateCredentialCacheKey(e,t){const r=generateCredentialKey(t);if(e!==r){const n=this.getItem(e);if(n)return this.removeItem(e),this.setItem(r,n),this.logger.verbose(`Updated an outdated ${t.credentialType} cache key`),r;this.logger.error(`Attempted to update an outdated ${t.credentialType} cache key but no item matching the outdated key was found in storage`)}return e}}const Li={},Di={},Bi={},Fi={},ji={};class TokenCache{constructor(e,t,r){this.cacheHasChanged=!1,this.storage=e,this.storage.registerChangeEmitter(this.handleChangeEvent.bind(this)),r&&(this.persistence=r),this.logger=t}hasChanged(){return this.cacheHasChanged}serialize(){this.logger.trace("Serializing in-memory cache");let e=Serializer.serializeAllCache(this.storage.getInMemoryCache());return this.cacheSnapshot?(this.logger.trace("Reading cache snapshot from disk"),e=this.mergeState(JSON.parse(this.cacheSnapshot),e)):this.logger.trace("No cache snapshot to merge"),this.cacheHasChanged=!1,JSON.stringify(e)}deserialize(e){if(this.logger.trace("Deserializing JSON to in-memory cache"),this.cacheSnapshot=e,this.cacheSnapshot){this.logger.trace("Reading cache snapshot from disk");const e=Deserializer.deserializeAllCache(this.overlayDefaults(JSON.parse(this.cacheSnapshot)));this.storage.setInMemoryCache(e)}else this.logger.trace("No cache snapshot to deserialize")}getKVStore(){return this.storage.getCache()}getCacheSnapshot(){const e=NodeStorage.generateInMemoryCache(this.cacheSnapshot);return this.storage.inMemoryCacheToCache(e)}async getAllAccounts(){let e;this.logger.trace("getAllAccounts called");try{return this.persistence&&(e=new TokenCacheContext(this,!1),await this.persistence.beforeCacheAccess(e)),this.storage.getAllAccounts()}finally{this.persistence&&e&&await this.persistence.afterCacheAccess(e)}}async getAccountByHomeId(e){const t=await this.getAllAccounts();return e&&t&&t.length&&t.filter((t=>t.homeAccountId===e))[0]||null}async getAccountByLocalId(e){const t=await this.getAllAccounts();return e&&t&&t.length&&t.filter((t=>t.localAccountId===e))[0]||null}async removeAccount(e){let t;this.logger.trace("removeAccount called");try{this.persistence&&(t=new TokenCacheContext(this,!0),await this.persistence.beforeCacheAccess(t)),await this.storage.removeAccount(AccountEntity.generateAccountCacheKey(e))}finally{this.persistence&&t&&await this.persistence.afterCacheAccess(t)}}async overwriteCache(){if(!this.persistence)return void this.logger.info("No persistence layer specified, cache cannot be overwritten");this.logger.info("Overwriting in-memory cache with persistent cache"),this.storage.clear();const e=new TokenCacheContext(this,!1);await this.persistence.beforeCacheAccess(e);const t=this.getCacheSnapshot();this.storage.setCache(t),await this.persistence.afterCacheAccess(e)}handleChangeEvent(){this.cacheHasChanged=!0}mergeState(e,t){this.logger.trace("Merging in-memory cache with cache snapshot");const r=this.mergeRemovals(e,t);return this.mergeUpdates(r,t)}mergeUpdates(e,t){return Object.keys(t).forEach((r=>{const n=t[r];if(e.hasOwnProperty(r)){const t=null!==n,i="object"==typeof n,o=!Array.isArray(n),a=void 0!==e[r]&&null!==e[r];t&&i&&o&&a?this.mergeUpdates(e[r],n):e[r]=n}else null!==n&&(e[r]=n)})),e}mergeRemovals(e,t){this.logger.trace("Remove updated entries in cache");const r=e.Account?this.mergeRemovalsDict(e.Account,t.Account):e.Account,n=e.AccessToken?this.mergeRemovalsDict(e.AccessToken,t.AccessToken):e.AccessToken,i=e.RefreshToken?this.mergeRemovalsDict(e.RefreshToken,t.RefreshToken):e.RefreshToken,o=e.IdToken?this.mergeRemovalsDict(e.IdToken,t.IdToken):e.IdToken,a=e.AppMetadata?this.mergeRemovalsDict(e.AppMetadata,t.AppMetadata):e.AppMetadata;return{...e,Account:r,AccessToken:n,RefreshToken:i,IdToken:o,AppMetadata:a}}mergeRemovalsDict(e,t){const r={...e};return Object.keys(e).forEach((e=>{t&&t.hasOwnProperty(e)||delete r[e]})),r}overlayDefaults(e){return this.logger.trace("Overlaying input cache with the default cache"),{Account:{...Li,...e.Account},IdToken:{...Di,...e.IdToken},AccessToken:{...Bi,...e.AccessToken},RefreshToken:{...Fi,...e.RefreshToken},AppMetadata:{...ji,...e.AppMetadata}}}}var $i=r(44040);class ClientAssertion{static fromAssertion(e){const t=new ClientAssertion;return t.jwt=e,t}static fromCertificate(e,t,r){const n=new ClientAssertion;return n.privateKey=t,n.thumbprint=e,n.useSha256=!1,r&&(n.publicCertificate=this.parseCertificate(r)),n}static fromCertificateWithSha256Thumbprint(e,t,r){const n=new ClientAssertion;return n.privateKey=t,n.thumbprint=e,n.useSha256=!0,r&&(n.publicCertificate=this.parseCertificate(r)),n}getJwt(e,t,r){if(this.privateKey&&this.thumbprint)return this.jwt&&!this.isExpired()&&t===this.issuer&&r===this.jwtAudience?this.jwt:this.createJwt(e,t,r);if(this.jwt)return this.jwt;throw createClientAuthError(Rr)}createJwt(e,t,r){this.issuer=t,this.jwtAudience=r;const n=nowSeconds();this.expirationTime=n+600;const i={alg:this.useSha256?rt:tt},o=this.useSha256?nt:it;Object.assign(i,{[o]:EncodingUtils.base64EncodeUrl(this.thumbprint,"hex")}),this.publicCertificate&&Object.assign(i,{[ot]:this.publicCertificate});const a={[at]:this.jwtAudience,[st]:this.expirationTime,[ct]:this.issuer,[lt]:this.issuer,[ut]:n,[dt]:e.createNewGuid()};return this.jwt=$i.sign(a,this.privateKey,{header:i}),this.jwt}isExpired(){return this.expirationTime<nowSeconds()}static parseCertificate(e){const t=/-----BEGIN CERTIFICATE-----\r*\n(.+?)\r*\n-----END CERTIFICATE-----/gs,r=[];let n;for(;null!==(n=t.exec(e));)r.push(n[1].replace(/\r*\n/g,A.EMPTY_STRING));return r}}const Ki="@azure/msal-node",zi="3.3.0";class UsernamePasswordClient extends BaseClient{constructor(e){super(e)}async acquireToken(e){this.logger.info("in acquireToken call in username-password client");const t=nowSeconds(),r=await this.executeTokenRequest(this.authority,e),n=new ResponseHandler(this.config.authOptions.clientId,this.cacheManager,this.cryptoUtils,this.logger,this.config.serializableCache,this.config.persistencePlugin);n.validateTokenResponse(r.body);return n.handleServerTokenResponse(r.body,this.authority,t,e)}async executeTokenRequest(e,t){const r=this.createTokenQueryParameters(t),n=UrlString.appendQueryString(e.tokenEndpoint,r),i=await this.createTokenRequestBody(t),o=this.createTokenRequestHeaders({credential:t.username,type:$n}),a={clientId:this.config.authOptions.clientId,authority:e.canonicalAuthority,scopes:t.scopes,claims:t.claims,authenticationScheme:t.authenticationScheme,resourceRequestMethod:t.resourceRequestMethod,resourceRequestUri:t.resourceRequestUri,shrClaims:t.shrClaims,sshKid:t.sshKid};return this.executePostToTokenEndpoint(n,i,o,a,t.correlationId)}async createTokenRequestBody(e){const t=new RequestParameterBuilder;t.addClientId(this.config.authOptions.clientId),t.addUsername(e.username),t.addPassword(e.password),t.addScopes(e.scopes),t.addResponseTypeForTokenAndIdToken(),t.addGrantType(z),t.addClientInfo(),t.addLibraryInfo(this.config.libraryInfo),t.addApplicationTelemetry(this.config.telemetry.application),t.addThrottling(),this.serverTelemetryManager&&t.addServerTelemetry(this.serverTelemetryManager);const r=e.correlationId||this.config.cryptoInterface.createNewGuid();t.addCorrelationId(r),this.config.clientCredentials.clientSecret&&t.addClientSecret(this.config.clientCredentials.clientSecret);const n=this.config.clientCredentials.clientAssertion;return n&&(t.addClientAssertion(await getClientAssertion(n.assertion,this.config.authOptions.clientId,e.resourceRequestUri)),t.addClientAssertionType(n.assertionType)),(!StringUtils.isEmptyObj(e.claims)||this.config.authOptions.clientCapabilities&&this.config.authOptions.clientCapabilities.length>0)&&t.addClaims(e.claims,this.config.authOptions.clientCapabilities),this.config.systemOptions.preventCorsPreflight&&e.username&&t.addCcsUpn(e.username),t.createQueryString()}}class ClientApplication{constructor(e){this.config=function buildAppConfiguration({auth:e,broker:t,cache:r,system:n,telemetry:i}){const o={...bi,networkClient:new HttpClient(n?.proxyUrl,n?.customAgentOptions),loggerOptions:n?.loggerOptions||Ei,disableInternalRetries:n?.disableInternalRetries||!1};if(e.clientCertificate&&!e.clientCertificate.thumbprint&&!e.clientCertificate.thumbprintSha256)throw NodeAuthError.createStateNotFoundError();return{auth:{...wi,...e},broker:{...t},cache:{...ki,...r},system:{...o,...n},telemetry:{..._i,...i}}}(e),this.cryptoProvider=new CryptoProvider,this.logger=new Logger(this.config.system.loggerOptions,Ki,zi),this.storage=new NodeStorage(this.logger,this.config.auth.clientId,this.cryptoProvider,function buildStaticAuthorityOptions(e){const t=e.cloudDiscoveryMetadata;let r;if(t)try{r=JSON.parse(t)}catch(e){throw createClientConfigurationError(jt)}return{canonicalAuthority:e.authority?formatAuthorityUri(e.authority):void 0,knownAuthorities:e.knownAuthorities,cloudDiscoveryMetadata:r}}(this.config.auth)),this.tokenCache=new TokenCache(this.storage,this.logger,this.config.cache.cachePlugin)}async getAuthCodeUrl(e){this.logger.info("getAuthCodeUrl called",e.correlationId);const t={...e,...await this.initializeBaseRequest(e),responseMode:e.responseMode||j.QUERY,authenticationScheme:ue.BEARER},r=await this.buildOauthClientConfiguration(t.authority,t.correlationId,t.redirectUri,void 0,void 0,e.azureCloudOptions),n=new AuthorizationCodeClient(r);return this.logger.verbose("Auth code client created",t.correlationId),n.getAuthCodeUrl(t)}async acquireTokenByCode(e,t){this.logger.info("acquireTokenByCode called"),e.state&&t&&(this.logger.info("acquireTokenByCode - validating state"),this.validateState(e.state,t.state||""),t={...t,state:""});const r={...e,...await this.initializeBaseRequest(e),authenticationScheme:ue.BEARER},n=this.initializeServerTelemetryManager(Xe,r.correlationId);try{const i=await this.buildOauthClientConfiguration(r.authority,r.correlationId,r.redirectUri,n,void 0,e.azureCloudOptions),o=new AuthorizationCodeClient(i);return this.logger.verbose("Auth code client created",r.correlationId),await o.acquireToken(r,t)}catch(e){throw e instanceof AuthError&&e.setCorrelationId(r.correlationId),n.cacheFailedRequest(e),e}}async acquireTokenByRefreshToken(e){this.logger.info("acquireTokenByRefreshToken called",e.correlationId);const t={...e,...await this.initializeBaseRequest(e),authenticationScheme:ue.BEARER},r=this.initializeServerTelemetryManager(et,t.correlationId);try{const n=await this.buildOauthClientConfiguration(t.authority,t.correlationId,t.redirectUri||"",r,void 0,e.azureCloudOptions),i=new RefreshTokenClient(n);return this.logger.verbose("Refresh token client created",t.correlationId),await i.acquireToken(t)}catch(e){throw e instanceof AuthError&&e.setCorrelationId(t.correlationId),r.cacheFailedRequest(e),e}}async acquireTokenSilent(e){const t={...e,...await this.initializeBaseRequest(e),forceRefresh:e.forceRefresh||!1},r=this.initializeServerTelemetryManager(Ye,t.correlationId,t.forceRefresh);try{const e=await this.buildOauthClientConfiguration(t.authority,t.correlationId,t.redirectUri||"",r,void 0,t.azureCloudOptions),n=new SilentFlowClient(e);this.logger.verbose("Silent flow client created",t.correlationId);try{return await this.tokenCache.overwriteCache(),await this.acquireCachedTokenSilent(t,n,e)}catch(r){if(r instanceof ClientAuthError&&r.errorCode===Pr){return new RefreshTokenClient(e).acquireTokenByRefreshToken(t)}throw r}}catch(e){throw e instanceof AuthError&&e.setCorrelationId(t.correlationId),r.cacheFailedRequest(e),e}}async acquireCachedTokenSilent(e,t,r){const[n,i]=await t.acquireCachedToken({...e,scopes:e.scopes?.length?e.scopes:[...R]});if(i===Pe){this.logger.info("ClientApplication:acquireCachedTokenSilent - Cached access token's refreshOn property has been exceeded'. It's not expired, but must be refreshed.");const t=new RefreshTokenClient(r);try{await t.acquireTokenByRefreshToken(e)}catch{}}return n}async acquireTokenByUsernamePassword(e){this.logger.info("acquireTokenByUsernamePassword called",e.correlationId);const t={...e,...await this.initializeBaseRequest(e)},r=this.initializeServerTelemetryManager(We,t.correlationId);try{const n=await this.buildOauthClientConfiguration(t.authority,t.correlationId,"",r,void 0,e.azureCloudOptions),i=new UsernamePasswordClient(n);return this.logger.verbose("Username password client created",t.correlationId),await i.acquireToken(t)}catch(e){throw e instanceof AuthError&&e.setCorrelationId(t.correlationId),r.cacheFailedRequest(e),e}}getTokenCache(){return this.logger.info("getTokenCache called"),this.tokenCache}validateState(e,t){if(!e)throw NodeAuthError.createStateNotFoundError();if(e!==t)throw createClientAuthError(cr)}getLogger(){return this.logger}setLogger(e){this.logger=e}async buildOauthClientConfiguration(e,t,r,n,i,o){this.logger.verbose("buildOauthClientConfiguration called",t);const a=o||this.config.auth.azureCloudOptions,s=await this.createAuthority(e,t,i,a);this.logger.info(`Building oauth client configuration with the following authority: ${s.tokenEndpoint}.`,t),n?.updateRegionDiscoveryMetadata(s.regionDiscoveryMetadata);return{authOptions:{clientId:this.config.auth.clientId,authority:s,clientCapabilities:this.config.auth.clientCapabilities,redirectUri:r},loggerOptions:{logLevel:this.config.system.loggerOptions.logLevel,loggerCallback:this.config.system.loggerOptions.loggerCallback,piiLoggingEnabled:this.config.system.loggerOptions.piiLoggingEnabled,correlationId:t},cacheOptions:{claimsBasedCachingEnabled:this.config.cache.claimsBasedCachingEnabled},cryptoInterface:this.cryptoProvider,networkInterface:this.config.system.networkClient,storageInterface:this.storage,serverTelemetryManager:n,clientCredentials:{clientSecret:this.clientSecret,clientAssertion:await this.getClientAssertion(s)},libraryInfo:{sku:Ke,version:zi,cpu:process.arch||A.EMPTY_STRING,os:process.platform||A.EMPTY_STRING},telemetry:this.config.telemetry,persistencePlugin:this.config.cache.cachePlugin,serializableCache:this.tokenCache}}async getClientAssertion(e){return this.developerProvidedClientAssertion&&(this.clientAssertion=ClientAssertion.fromAssertion(await getClientAssertion(this.developerProvidedClientAssertion,this.config.auth.clientId,e.tokenEndpoint))),this.clientAssertion&&{assertion:this.clientAssertion.getJwt(this.cryptoProvider,this.config.auth.clientId,e.tokenEndpoint),assertionType:ze}}async initializeBaseRequest(e){return this.logger.verbose("initializeRequestScopes called",e.correlationId),e.authenticationScheme&&e.authenticationScheme===ue.POP&&this.logger.verbose("Authentication Scheme 'pop' is not supported yet, setting Authentication Scheme to 'Bearer' for request",e.correlationId),e.authenticationScheme=ue.BEARER,this.config.cache.claimsBasedCachingEnabled&&e.claims&&!StringUtils.isEmptyObj(e.claims)&&(e.requestedClaimsHash=await this.cryptoProvider.hashString(e.claims)),{...e,scopes:[...e&&e.scopes||[],...R],correlationId:e&&e.correlationId||this.cryptoProvider.createNewGuid(),authority:e.authority||this.config.auth.authority}}initializeServerTelemetryManager(e,t,r){const n={clientId:this.config.auth.clientId,correlationId:t,apiId:e,forceRefresh:r||!1};return new ServerTelemetryManager(n,this.storage)}async createAuthority(e,t,r,n){this.logger.verbose("createAuthority called",t);const i=Authority.generateAuthority(e,n),o={protocolMode:this.config.auth.protocolMode,knownAuthorities:this.config.auth.knownAuthorities,cloudDiscoveryMetadata:this.config.auth.cloudDiscoveryMetadata,authorityMetadata:this.config.auth.authorityMetadata,azureRegionConfiguration:r,skipAuthorityMetadataCache:this.config.auth.skipAuthorityMetadataCache};return createDiscoveredInstance(i,this.config.system.networkClient,this.storage,o,this.logger,t)}clearCache(){this.storage.clear()}}class LoopbackClient{async listenForAuthCode(e,t){if(this.server)throw NodeAuthError.createLoopbackServerAlreadyExistsError();return new Promise(((r,n)=>{this.server=Zn.createServer(((i,o)=>{const a=i.url;if(!a)return o.end(t||"Error occurred loading redirectUrl"),void n(NodeAuthError.createUnableToLoadRedirectUrlError());if(a===A.FORWARD_SLASH)return void o.end(e||"Auth code was successfully acquired. You can close this window now.");const s=this.getRedirectUri(),c=getDeserializedResponse(new URL(a,s).search)||{};c.code&&(o.writeHead(v,{location:s}),o.end()),c.error&&o.end(t||`Error occurred: ${c.error}`),r(c)})),this.server.listen(0,"127.0.0.1")}))}getRedirectUri(){if(!this.server||!this.server.listening)throw NodeAuthError.createNoLoopbackServerExistsError();const e=this.server.address();if(!e||"string"==typeof e||!e.port)throw this.closeServer(),NodeAuthError.createInvalidLoopbackAddressTypeError();const t=e&&e.port;return`${Ve}${Qe}:${t}`}closeServer(){this.server&&(this.server.close(),"function"==typeof this.server.closeAllConnections&&this.server.closeAllConnections(),this.server.unref(),this.server=void 0)}}class DeviceCodeClient extends BaseClient{constructor(e){super(e)}async acquireToken(e){const t=await this.getDeviceCode(e);e.deviceCodeCallback(t);const r=nowSeconds(),n=await this.acquireTokenWithDeviceCode(e,t),i=new ResponseHandler(this.config.authOptions.clientId,this.cacheManager,this.cryptoUtils,this.logger,this.config.serializableCache,this.config.persistencePlugin);return i.validateTokenResponse(n),i.handleServerTokenResponse(n,this.authority,r,e)}async getDeviceCode(e){const t=this.createExtraQueryParameters(e),r=UrlString.appendQueryString(this.authority.deviceCodeEndpoint,t),n=this.createQueryString(e),i=this.createTokenRequestHeaders(),o={clientId:this.config.authOptions.clientId,authority:e.authority,scopes:e.scopes,claims:e.claims,authenticationScheme:e.authenticationScheme,resourceRequestMethod:e.resourceRequestMethod,resourceRequestUri:e.resourceRequestUri,shrClaims:e.shrClaims,sshKid:e.sshKid};return this.executePostRequestToDeviceCodeEndpoint(r,n,i,o,e.correlationId)}createExtraQueryParameters(e){const t=new RequestParameterBuilder;return e.extraQueryParameters&&t.addExtraQueryParameters(e.extraQueryParameters),t.createQueryString()}async executePostRequestToDeviceCodeEndpoint(e,t,r,n,i){const{body:{user_code:o,device_code:a,verification_uri:s,expires_in:c,interval:l,message:u}}=await this.sendPostRequest(n,e,{body:t,headers:r},i);return{userCode:o,deviceCode:a,verificationUri:s,expiresIn:c,interval:l,message:u}}createQueryString(e){const t=new RequestParameterBuilder;return t.addScopes(e.scopes),t.addClientId(this.config.authOptions.clientId),e.extraQueryParameters&&t.addExtraQueryParameters(e.extraQueryParameters),(e.claims||this.config.authOptions.clientCapabilities&&this.config.authOptions.clientCapabilities.length>0)&&t.addClaims(e.claims,this.config.authOptions.clientCapabilities),t.createQueryString()}continuePolling(e,t,r){if(r)throw this.logger.error("Token request cancelled by setting DeviceCodeRequest.cancel = true"),createClientAuthError(Tr);if(t&&t<e&&nowSeconds()>t)throw this.logger.error(`User defined timeout for device code polling reached. The timeout was set for ${t}`),createClientAuthError(Mr);if(nowSeconds()>e)throw t&&this.logger.verbose(`User specified timeout ignored as the device code has expired before the timeout elapsed. The user specified timeout was set for ${t}`),this.logger.error(`Device code expired. Expiration time of device code was ${e}`),createClientAuthError(Ir);return!0}async acquireTokenWithDeviceCode(e,t){const r=this.createTokenQueryParameters(e),n=UrlString.appendQueryString(this.authority.tokenEndpoint,r),i=this.createTokenRequestBody(e,t),o=this.createTokenRequestHeaders(),a=e.timeout?nowSeconds()+e.timeout:void 0,s=nowSeconds()+t.expiresIn,c=1e3*t.interval;for(;this.continuePolling(s,a,e.cancel);){const t={clientId:this.config.authOptions.clientId,authority:e.authority,scopes:e.scopes,claims:e.claims,authenticationScheme:e.authenticationScheme,resourceRequestMethod:e.resourceRequestMethod,resourceRequestUri:e.resourceRequestUri,shrClaims:e.shrClaims,sshKid:e.sshKid},r=await this.executePostToTokenEndpoint(n,i,o,t,e.correlationId);if(!r.body||!r.body.error)return this.logger.verbose("Authorization completed successfully. Polling stopped."),r.body;if(r.body.error!==A.AUTHORIZATION_PENDING)throw this.logger.info("Unexpected error in polling from the server"),l=ft,u=r.body.error,new AuthError(l,u?`${mt[l]} ${u}`:mt[l]);this.logger.info("Authorization pending. Continue polling."),await delay(c)}var l,u;throw this.logger.error("Polling stopped for unknown reasons."),createClientAuthError(Sr)}createTokenRequestBody(e,t){const r=new RequestParameterBuilder;r.addScopes(e.scopes),r.addClientId(this.config.authOptions.clientId),r.addGrantType(V),r.addDeviceCode(t.deviceCode);const n=e.correlationId||this.config.cryptoInterface.createNewGuid();return r.addCorrelationId(n),r.addClientInfo(),r.addLibraryInfo(this.config.libraryInfo),r.addApplicationTelemetry(this.config.telemetry.application),r.addThrottling(),this.serverTelemetryManager&&r.addServerTelemetry(this.serverTelemetryManager),(!StringUtils.isEmptyObj(e.claims)||this.config.authOptions.clientCapabilities&&this.config.authOptions.clientCapabilities.length>0)&&r.addClaims(e.claims,this.config.authOptions.clientCapabilities),r.createQueryString()}}class PublicClientApplication extends ClientApplication{constructor(e){super(e),this.config.broker.nativeBrokerPlugin&&(this.config.broker.nativeBrokerPlugin.isBrokerAvailable?(this.nativeBrokerPlugin=this.config.broker.nativeBrokerPlugin,this.nativeBrokerPlugin.setLogger(this.config.system.loggerOptions)):this.logger.warning("NativeBroker implementation was provided but the broker is unavailable.")),this.skus=ServerTelemetryManager.makeExtraSkuString({libraryName:Ke,libraryVersion:zi})}async acquireTokenByDeviceCode(e){this.logger.info("acquireTokenByDeviceCode called",e.correlationId);const t=Object.assign(e,await this.initializeBaseRequest(e)),r=this.initializeServerTelemetryManager(Je,t.correlationId);try{const n=await this.buildOauthClientConfiguration(t.authority,t.correlationId,"",r,void 0,e.azureCloudOptions),i=new DeviceCodeClient(n);return this.logger.verbose("Device code client created",t.correlationId),await i.acquireToken(t)}catch(e){throw e instanceof AuthError&&e.setCorrelationId(t.correlationId),r.cacheFailedRequest(e),e}}async acquireTokenInteractive(e){const t=e.correlationId||this.cryptoProvider.createNewGuid();this.logger.trace("acquireTokenInteractive called",t);const{openBrowser:r,successTemplate:n,errorTemplate:i,windowHandle:o,loopbackClient:a,...s}=e;if(this.nativeBrokerPlugin){const r={...s,clientId:this.config.auth.clientId,scopes:e.scopes||R,redirectUri:`${Ve}${Qe}`,authority:e.authority||this.config.auth.authority,correlationId:t,extraParameters:{...s.extraQueryParameters,...s.tokenQueryParameters,[vt]:this.skus},accountId:s.account?.nativeAccountId};return this.nativeBrokerPlugin.acquireTokenInteractive(r,o)}const{verifier:c,challenge:l}=await this.cryptoProvider.generatePkceCodes(),u=a||new LoopbackClient;let d={},h=null;try{const o=u.listenForAuthCode(n,i).then((e=>{d=e})).catch((e=>{h=e})),a=await this.waitForRedirectUri(u),g={...s,correlationId:t,scopes:e.scopes||R,redirectUri:a,responseMode:j.QUERY,codeChallenge:l,codeChallengeMethod:F.S256},p=await this.getAuthCodeUrl(g);if(await r(p),await o,h)throw h;if(d.error)throw new ServerError(d.error,d.error_description,d.suberror);if(!d.code)throw NodeAuthError.createNoAuthCodeInResponseError();const f=d.client_info,m={code:d.code,codeVerifier:c,clientInfo:f||A.EMPTY_STRING,...g};return await this.acquireTokenByCode(m)}finally{u.closeServer()}}async acquireTokenSilent(e){const t=e.correlationId||this.cryptoProvider.createNewGuid();if(this.logger.trace("acquireTokenSilent called",t),this.nativeBrokerPlugin){const r={...e,clientId:this.config.auth.clientId,scopes:e.scopes||R,redirectUri:`${Ve}${Qe}`,authority:e.authority||this.config.auth.authority,correlationId:t,extraParameters:{...e.tokenQueryParameters,[vt]:this.skus},accountId:e.account.nativeAccountId,forceRefresh:e.forceRefresh||!1};return this.nativeBrokerPlugin.acquireTokenSilent(r)}return super.acquireTokenSilent(e)}async signOut(e){if(this.nativeBrokerPlugin&&e.account.nativeAccountId){const t={clientId:this.config.auth.clientId,accountId:e.account.nativeAccountId,correlationId:e.correlationId||this.cryptoProvider.createNewGuid()};await this.nativeBrokerPlugin.signOut(t)}await this.getTokenCache().removeAccount(e.account)}async getAllAccounts(){if(this.nativeBrokerPlugin){const e=this.cryptoProvider.createNewGuid();return this.nativeBrokerPlugin.getAllAccounts(this.config.auth.clientId,e)}return this.getTokenCache().getAllAccounts()}async waitForRedirectUri(e){return new Promise(((t,r)=>{let n=0;const i=setInterval((()=>{if(gt/ht<n)return clearInterval(i),void r(NodeAuthError.createLoopbackServerTimeoutError());try{const r=e.getRedirectUri();return clearInterval(i),void t(r)}catch(e){return e instanceof AuthError&&e.errorCode===Ai.code?void n++:(clearInterval(i),void r(e))}}),ht)}))}}class ClientCredentialClient extends BaseClient{constructor(e,t){super(e),this.appTokenProvider=t}async acquireToken(e){if(e.skipCache||e.claims)return this.executeTokenRequest(e,this.authority);const[t,r]=await this.getCachedAuthenticationResult(e,this.config,this.cryptoUtils,this.authority,this.cacheManager,this.serverTelemetryManager);if(t){if(r===Pe){this.logger.info("ClientCredentialClient:getCachedAuthenticationResult - Cached access token's refreshOn property has been exceeded'. It's not expired, but must be refreshed.");const t=!0;await this.executeTokenRequest(e,this.authority,t)}return t}return this.executeTokenRequest(e,this.authority)}async getCachedAuthenticationResult(e,t,r,n,i,o){const a=t,s=t;let c,l=be;a.serializableCache&&a.persistencePlugin&&(c=new TokenCacheContext(a.serializableCache,!1),await a.persistencePlugin.beforeCacheAccess(c));const u=this.readAccessTokenFromCache(n,s.managedIdentityId?.id||a.authOptions.clientId,new ScopeSet(e.scopes||[]),i);return a.serializableCache&&a.persistencePlugin&&c&&await a.persistencePlugin.afterCacheAccess(c),u?isTokenExpired(u.expiresOn,a.systemOptions?.tokenRenewalOffsetSeconds||300)?(o?.setCacheOutcome(Oe),[null,Oe]):(u.refreshOn&&isTokenExpired(u.refreshOn.toString(),0)&&(l=Pe,o?.setCacheOutcome(Pe)),[await ResponseHandler.generateAuthenticationResult(r,n,{account:null,idToken:null,accessToken:u,refreshToken:null,appMetadata:null},!0,e),l]):(o?.setCacheOutcome(Re),[null,Re])}readAccessTokenFromCache(e,t,r,n){const i={homeAccountId:A.EMPTY_STRING,environment:e.canonicalAuthorityUrlComponents.HostNameAndPort,credentialType:ee.ACCESS_TOKEN,clientId:t,realm:e.tenant,target:ScopeSet.createSearchScopes(r.asArray())},o=n.getAccessTokensByFilter(i);if(o.length<1)return null;if(o.length>1)throw createClientAuthError(gr);return o[0]}async executeTokenRequest(e,t,r){let n,i;if(this.appTokenProvider){this.logger.info("Using appTokenProvider extensibility.");const t={correlationId:e.correlationId,tenantId:this.config.authOptions.authority.tenant,scopes:e.scopes,claims:e.claims};i=nowSeconds();const r=await this.appTokenProvider(t);n={access_token:r.accessToken,expires_in:r.expiresInSeconds,refresh_in:r.refreshInSeconds,token_type:ue.BEARER}}else{const r=this.createTokenQueryParameters(e),o=UrlString.appendQueryString(t.tokenEndpoint,r),a=await this.createTokenRequestBody(e),s=this.createTokenRequestHeaders(),c={clientId:this.config.authOptions.clientId,authority:e.authority,scopes:e.scopes,claims:e.claims,authenticationScheme:e.authenticationScheme,resourceRequestMethod:e.resourceRequestMethod,resourceRequestUri:e.resourceRequestUri,shrClaims:e.shrClaims,sshKid:e.sshKid};this.logger.info("Sending token request to endpoint: "+t.tokenEndpoint),i=nowSeconds();const l=await this.executePostToTokenEndpoint(o,a,s,c,e.correlationId);n=l.body,n.status=l.status}const o=new ResponseHandler(this.config.authOptions.clientId,this.cacheManager,this.cryptoUtils,this.logger,this.config.serializableCache,this.config.persistencePlugin);o.validateTokenResponse(n,r);return await o.handleServerTokenResponse(n,this.authority,i,e)}async createTokenRequestBody(e){const t=new RequestParameterBuilder;t.addClientId(this.config.authOptions.clientId),t.addScopes(e.scopes,!1),t.addGrantType(K),t.addLibraryInfo(this.config.libraryInfo),t.addApplicationTelemetry(this.config.telemetry.application),t.addThrottling(),this.serverTelemetryManager&&t.addServerTelemetry(this.serverTelemetryManager);const r=e.correlationId||this.config.cryptoInterface.createNewGuid();t.addCorrelationId(r),this.config.clientCredentials.clientSecret&&t.addClientSecret(this.config.clientCredentials.clientSecret);const n=e.clientAssertion||this.config.clientCredentials.clientAssertion;return n&&(t.addClientAssertion(await getClientAssertion(n.assertion,this.config.authOptions.clientId,e.resourceRequestUri)),t.addClientAssertionType(n.assertionType)),(!StringUtils.isEmptyObj(e.claims)||this.config.authOptions.clientCapabilities&&this.config.authOptions.clientCapabilities.length>0)&&t.addClaims(e.claims,this.config.authOptions.clientCapabilities),t.createQueryString()}}class OnBehalfOfClient extends BaseClient{constructor(e){super(e)}async acquireToken(e){if(this.scopeSet=new ScopeSet(e.scopes||[]),this.userAssertionHash=await this.cryptoUtils.hashString(e.oboAssertion),e.skipCache||e.claims)return this.executeTokenRequest(e,this.authority,this.userAssertionHash);try{return await this.getCachedAuthenticationResult(e)}catch(t){return await this.executeTokenRequest(e,this.authority,this.userAssertionHash)}}async getCachedAuthenticationResult(e){const t=this.readAccessTokenFromCacheForOBO(this.config.authOptions.clientId,e);if(!t)throw this.serverTelemetryManager?.setCacheOutcome(Re),this.logger.info("SilentFlowClient:acquireCachedToken - No access token found in cache for the given properties."),createClientAuthError(Pr);if(isTokenExpired(t.expiresOn,this.config.systemOptions.tokenRenewalOffsetSeconds))throw this.serverTelemetryManager?.setCacheOutcome(Oe),this.logger.info(`OnbehalfofFlow:getCachedAuthenticationResult - Cached access token is expired or will expire within ${this.config.systemOptions.tokenRenewalOffsetSeconds} seconds.`),createClientAuthError(Pr);const r=this.readIdTokenFromCacheForOBO(t.homeAccountId);let n,i=null;if(r){n=extractTokenClaims(r.secret,EncodingUtils.base64Decode);const e=n.oid||n.sub,t={homeAccountId:r.homeAccountId,environment:r.environment,tenantId:r.realm,username:A.EMPTY_STRING,localAccountId:e||A.EMPTY_STRING};i=this.cacheManager.readAccountFromCache(t)}return this.config.serverTelemetryManager&&this.config.serverTelemetryManager.incrementCacheHits(),ResponseHandler.generateAuthenticationResult(this.cryptoUtils,this.authority,{account:i,accessToken:t,idToken:r,refreshToken:null,appMetadata:null},!0,e,n)}readIdTokenFromCacheForOBO(e){const t={homeAccountId:e,environment:this.authority.canonicalAuthorityUrlComponents.HostNameAndPort,credentialType:ee.ID_TOKEN,clientId:this.config.authOptions.clientId,realm:this.authority.tenant},r=this.cacheManager.getIdTokensByFilter(t);return Object.values(r).length<1?null:Object.values(r)[0]}readAccessTokenFromCacheForOBO(e,t){const r=t.authenticationScheme||ue.BEARER,n={credentialType:r&&r.toLowerCase()!==ue.BEARER.toLowerCase()?ee.ACCESS_TOKEN_WITH_AUTH_SCHEME:ee.ACCESS_TOKEN,clientId:e,target:ScopeSet.createSearchScopes(this.scopeSet.asArray()),tokenType:r,keyId:t.sshKid,requestedClaimsHash:t.requestedClaimsHash,userAssertionHash:this.userAssertionHash},i=this.cacheManager.getAccessTokensByFilter(n),o=i.length;if(o<1)return null;if(o>1)throw createClientAuthError(gr);return i[0]}async executeTokenRequest(e,t,r){const n=this.createTokenQueryParameters(e),i=UrlString.appendQueryString(t.tokenEndpoint,n),o=await this.createTokenRequestBody(e),a=this.createTokenRequestHeaders(),s={clientId:this.config.authOptions.clientId,authority:e.authority,scopes:e.scopes,claims:e.claims,authenticationScheme:e.authenticationScheme,resourceRequestMethod:e.resourceRequestMethod,resourceRequestUri:e.resourceRequestUri,shrClaims:e.shrClaims,sshKid:e.sshKid},c=nowSeconds(),l=await this.executePostToTokenEndpoint(i,o,a,s,e.correlationId),u=new ResponseHandler(this.config.authOptions.clientId,this.cacheManager,this.cryptoUtils,this.logger,this.config.serializableCache,this.config.persistencePlugin);u.validateTokenResponse(l.body);return await u.handleServerTokenResponse(l.body,this.authority,c,e,void 0,r)}async createTokenRequestBody(e){const t=new RequestParameterBuilder;t.addClientId(this.config.authOptions.clientId),t.addScopes(e.scopes),t.addGrantType(Q),t.addClientInfo(),t.addLibraryInfo(this.config.libraryInfo),t.addApplicationTelemetry(this.config.telemetry.application),t.addThrottling(),this.serverTelemetryManager&&t.addServerTelemetry(this.serverTelemetryManager);const r=e.correlationId||this.config.cryptoInterface.createNewGuid();t.addCorrelationId(r),t.addRequestTokenUse("on_behalf_of"),t.addOboAssertion(e.oboAssertion),this.config.clientCredentials.clientSecret&&t.addClientSecret(this.config.clientCredentials.clientSecret);const n=this.config.clientCredentials.clientAssertion;return n&&(t.addClientAssertion(await getClientAssertion(n.assertion,this.config.authOptions.clientId,e.resourceRequestUri)),t.addClientAssertionType(n.assertionType)),(e.claims||this.config.authOptions.clientCapabilities&&this.config.authOptions.clientCapabilities.length>0)&&t.addClaims(e.claims,this.config.authOptions.clientCapabilities),t.createQueryString()}}class ConfidentialClientApplication extends ClientApplication{constructor(e){super(e);const t=!!this.config.auth.clientSecret,r=!!this.config.auth.clientAssertion,n=!(!this.config.auth.clientCertificate?.thumbprint&&!this.config.auth.clientCertificate?.thumbprintSha256||!this.config.auth.clientCertificate?.privateKey);if(!this.appTokenProvider){if(t&&r||r&&n||t&&n)throw createClientAuthError(Or);if(this.config.auth.clientSecret)this.clientSecret=this.config.auth.clientSecret;else if(this.config.auth.clientAssertion)this.developerProvidedClientAssertion=this.config.auth.clientAssertion;else{if(!n)throw createClientAuthError(Or);this.clientAssertion=this.config.auth.clientCertificate.thumbprintSha256?ClientAssertion.fromCertificateWithSha256Thumbprint(this.config.auth.clientCertificate.thumbprintSha256,this.config.auth.clientCertificate.privateKey,this.config.auth.clientCertificate.x5c):ClientAssertion.fromCertificate(this.config.auth.clientCertificate.thumbprint,this.config.auth.clientCertificate.privateKey,this.config.auth.clientCertificate.x5c),this.appTokenProvider=void 0}}}SetAppTokenProvider(e){this.appTokenProvider=e}async acquireTokenByClientCredential(e){let t;this.logger.info("acquireTokenByClientCredential called",e.correlationId),e.clientAssertion&&(t={assertion:await getClientAssertion(e.clientAssertion,this.config.auth.clientId),assertionType:ze});const r=await this.initializeBaseRequest(e),n={...r,scopes:r.scopes.filter((e=>!R.includes(e)))},i={...e,...n,clientAssertion:t},o=new UrlString(i.authority).getUrlComponents().PathSegments[0];if(Object.values(H).includes(o))throw createClientAuthError(Br);const a=process.env.MSAL_FORCE_REGION;let s;"DisableMsalForceRegion"!==i.azureRegion&&(s=!i.azureRegion&&a?a:i.azureRegion);const c={azureRegion:s,environmentRegion:process.env.REGION_NAME},l=this.initializeServerTelemetryManager(Ze,i.correlationId,i.skipCache);try{const t=await this.buildOauthClientConfiguration(i.authority,i.correlationId,"",l,c,e.azureCloudOptions),r=new ClientCredentialClient(t,this.appTokenProvider);return this.logger.verbose("Client credential client created",i.correlationId),await r.acquireToken(i)}catch(e){throw e instanceof AuthError&&e.setCorrelationId(i.correlationId),l.cacheFailedRequest(e),e}}async acquireTokenOnBehalfOf(e){this.logger.info("acquireTokenOnBehalfOf called",e.correlationId);const t={...e,...await this.initializeBaseRequest(e)};try{const r=await this.buildOauthClientConfiguration(t.authority,t.correlationId,"",void 0,void 0,e.azureCloudOptions),n=new OnBehalfOfClient(r);return this.logger.verbose("On behalf of client created",t.correlationId),await n.acquireToken(t)}catch(e){throw e instanceof AuthError&&e.setCorrelationId(t.correlationId),e}}}class HttpClientWithRetries{constructor(e,t){this.httpClientNoRetries=e,this.retryPolicy=t}async sendNetworkRequestAsyncHelper(e,t,r){return e===De?this.httpClientNoRetries.sendGetRequestAsync(t,r):this.httpClientNoRetries.sendPostRequestAsync(t,r)}async sendNetworkRequestAsync(e,t,r){let n=await this.sendNetworkRequestAsyncHelper(e,t,r),i=0;for(;await this.retryPolicy.pauseForRetry(n.status,i,n.headers[N]);)n=await this.sendNetworkRequestAsyncHelper(e,t,r),i++;return n}async sendGetRequestAsync(e,t){return this.sendNetworkRequestAsync(De,e,t)}async sendPostRequestAsync(e,t){return this.sendNetworkRequestAsync(Be,e,t)}}const Gi="client_id",Vi="object_id",Qi="msi_res_id",Yi="mi_res_id";class BaseManagedIdentitySource{constructor(e,t,r,n,i){this.logger=e,this.nodeStorage=t,this.networkClient=r,this.cryptoProvider=n,this.disableInternalRetries=i}async getServerTokenResponseAsync(e,t,r,n){return this.getServerTokenResponse(e)}getServerTokenResponse(e){let t,r;e.body.expires_on&&(function isIso8601(e){if("string"!=typeof e)return!1;const t=new Date(e);return!isNaN(t.getTime())&&t.toISOString()===e}(e.body.expires_on)&&(e.body.expires_on=new Date(e.body.expires_on).getTime()/1e3),r=e.body.expires_on-nowSeconds(),r>7200&&(t=r/2));return{status:e.status,access_token:e.body.access_token,expires_in:r,scope:e.body.resource,token_type:e.body.token_type,refresh_in:t,correlation_id:e.body.correlation_id||e.body.correlationId,error:"string"==typeof e.body.error?e.body.error:e.body.error?.code,error_description:e.body.message||("string"==typeof e.body.error?e.body.error_description:e.body.error?.message),error_codes:e.body.error_codes,timestamp:e.body.timestamp,trace_id:e.body.trace_id}}async acquireTokenWithManagedIdentity(e,t,r,n){const i=this.createRequest(e.resource,t),o=i.headers;o[P]=A.URL_FORM_CONTENT_TYPE;const a={headers:o};Object.keys(i.bodyParameters).length&&(a.body=i.computeParametersBodyString());const s=this.disableInternalRetries?this.networkClient:new HttpClientWithRetries(this.networkClient,i.retryPolicy),c=nowSeconds();let l;try{l=i.httpMethod===Be?await s.sendPostRequestAsync(i.computeUri(),a):await s.sendGetRequestAsync(i.computeUri(),a)}catch(e){throw e instanceof AuthError?e:createClientAuthError(ir)}const u=new ResponseHandler(t.id,this.nodeStorage,this.cryptoProvider,this.logger,null,null),d=await this.getServerTokenResponseAsync(l,s,i,a);return u.validateTokenResponse(d,n),u.handleServerTokenResponse(d,r,c,e)}getManagedIdentityUserAssignedIdQueryParameterKey(e,t){switch(e){case xe:return this.logger.info("[Managed Identity] Adding user assigned client id to the request."),Gi;case He:return this.logger.info("[Managed Identity] Adding user assigned resource id to the request."),t?Qi:Yi;case Le:return this.logger.info("[Managed Identity] Adding user assigned object id to the request."),Vi;default:throw createManagedIdentityError(ri)}}}BaseManagedIdentitySource.getValidatedEnvVariableUrlString=(e,t,r,n)=>{try{return new UrlString(t).urlString}catch(t){throw n.info(`[Managed Identity] ${r} managed identity is unavailable because the '${e}' environment variable is malformed.`),createManagedIdentityError(pi[e])}};r(79896),r(16928);process.env.ProgramData,process.env.ProgramFiles;var Wi=r(42816);const Ji=credentialLogger("IdentityUtils");function ensureValidMsalToken(e,t,r){const error=t=>(Ji.getToken.info(t),new AuthenticationRequiredError({scopes:Array.isArray(e)?e:[e],getTokenOptions:r,message:t}));if(!t)throw error("No response");if(!t.expiresOn)throw error('Response had no "expiresOn" property.');if(!t.accessToken)throw error('Response had no "accessToken" property.')}function getAuthorityHost(e){let t=null==e?void 0:e.authorityHost;return!t&&f.qx&&(t=process.env.AZURE_AUTHORITY_HOST),null!=t?t:a}function getAuthority(e,t){return t||(t=a),new RegExp(`${e}/?$`).test(t)?t:t.endsWith("/")?t+e:`${t}/${e}`}function getKnownAuthorities(e,t,r){return"adfs"===e&&t||r?[t]:[]}const defaultLoggerCallback=(e,t=(f.Ll?"Node":"Browser"))=>(r,n,i)=>{if(!i)switch(r){case kt.Error:return void e.info(`MSAL ${t} V2 error: ${n}`);case kt.Info:return void e.info(`MSAL ${t} V2 info message: ${n}`);case kt.Verbose:return void e.info(`MSAL ${t} V2 verbose message: ${n}`);case kt.Warning:return void e.info(`MSAL ${t} V2 warning: ${n}`)}};function getMSALLogLevel(e){switch(e){case"error":return kt.Error;case"info":default:return kt.Info;case"verbose":return kt.Verbose;case"warning":return kt.Warning}}function handleMsalError(e,t,r){if("AuthError"===t.name||"ClientAuthError"===t.name||"BrowserAuthError"===t.name){const r=t;switch(r.errorCode){case"endpoints_resolution_error":return Ji.info(logging_formatError(e,t.message)),new errors_CredentialUnavailableError(t.message);case"device_code_polling_cancelled":return new Wi.l("The authentication has been aborted by the caller.");case"consent_required":case"interaction_required":case"login_required":Ji.info(logging_formatError(e,`Authentication returned errorCode ${r.errorCode}`));break;default:Ji.info(logging_formatError(e,`Failed to acquire token: ${t.message}`))}}return"ClientConfigurationError"===t.name||"BrowserConfigurationAuthError"===t.name||"AbortError"===t.name||"AuthenticationError"===t.name?t:"NativeAuthError"===t.name?(Ji.info(logging_formatError(e,`Error from the native broker: ${t.message} with status code: ${t.statusCode}`)),t):new AuthenticationRequiredError({scopes:e,getTokenOptions:r,message:t.message})}const Zi="ManagedIdentityCredential - IMDS";credentialLogger(Zi);var Xi;function calculateRegionalAuthority(e){var t,r;let n=e;return void 0===n&&void 0!==(null===(r=null===(t=globalThis.process)||void 0===t?void 0:t.env)||void 0===r?void 0:r.AZURE_REGIONAL_AUTHORITY_NAME)&&(n=process.env.AZURE_REGIONAL_AUTHORITY_NAME),n===Xi.AutoDiscoverRegion?"AUTO_DISCOVER":n}!function(e){e.AutoDiscoverRegion="AutoDiscoverRegion",e.USWest="westus",e.USWest2="westus2",e.USCentral="centralus",e.USEast="eastus",e.USEast2="eastus2",e.USNorthCentral="northcentralus",e.USSouthCentral="southcentralus",e.USWestCentral="westcentralus",e.CanadaCentral="canadacentral",e.CanadaEast="canadaeast",e.BrazilSouth="brazilsouth",e.EuropeNorth="northeurope",e.EuropeWest="westeurope",e.UKSouth="uksouth",e.UKWest="ukwest",e.FranceCentral="francecentral",e.FranceSouth="francesouth",e.SwitzerlandNorth="switzerlandnorth",e.SwitzerlandWest="switzerlandwest",e.GermanyNorth="germanynorth",e.GermanyWestCentral="germanywestcentral",e.NorwayWest="norwaywest",e.NorwayEast="norwayeast",e.AsiaEast="eastasia",e.AsiaSouthEast="southeastasia",e.JapanEast="japaneast",e.JapanWest="japanwest",e.AustraliaEast="australiaeast",e.AustraliaSouthEast="australiasoutheast",e.AustraliaCentral="australiacentral",e.AustraliaCentral2="australiacentral2",e.IndiaCentral="centralindia",e.IndiaSouth="southindia",e.IndiaWest="westindia",e.KoreaSouth="koreasouth",e.KoreaCentral="koreacentral",e.UAECentral="uaecentral",e.UAENorth="uaenorth",e.SouthAfricaNorth="southafricanorth",e.SouthAfricaWest="southafricawest",e.ChinaNorth="chinanorth",e.ChinaEast="chinaeast",e.ChinaNorth2="chinanorth2",e.ChinaEast2="chinaeast2",e.GermanyCentral="germanycentral",e.GermanyNorthEast="germanynortheast",e.GovernmentUSVirginia="usgovvirginia",e.GovernmentUSIowa="usgoviowa",e.GovernmentUSArizona="usgovarizona",e.GovernmentUSTexas="usgovtexas",e.GovernmentUSDodEast="usdodeast",e.GovernmentUSDodCentral="usdodcentral"}(Xi||(Xi={}));const eo=credentialLogger("MsalClient");function generateMsalConfiguration(e,t,r={}){var n,o,a;const s=function tenantIdUtils_resolveTenantId(e,t,r){return t?(tenantIdUtils_checkTenantId(e,t),t):(r||(r=i),r!==i?"common":"organizations")}(null!==(n=r.logger)&&void 0!==n?n:eo,t,e),c=getAuthority(s,getAuthorityHost(r)),l=new identityClient_IdentityClient(Object.assign(Object.assign({},r.tokenCredentialOptions),{authorityHost:c,loggingOptions:r.loggingOptions}));return{auth:{clientId:e,authority:c,knownAuthorities:getKnownAuthorities(s,c,r.disableInstanceDiscovery)},system:{networkClient:l,loggerOptions:{loggerCallback:defaultLoggerCallback(null!==(o=r.logger)&&void 0!==o?o:eo),logLevel:getMSALLogLevel((0,d.XM)()),piiLoggingEnabled:null===(a=r.loggingOptions)||void 0===a?void 0:a.enableUnsafeSupportLogging}}}}function msalClient_createMsalClient(e,t,n={}){var i;const o={msalConfig:generateMsalConfiguration(e,t,n),cachedAccount:n.authenticationRecord?(a=n.authenticationRecord,{localAccountId:a.homeAccountId,environment:a.authority,username:a.username,homeAccountId:a.homeAccountId,tenantId:a.tenantId}):null,pluginConfiguration:u.generatePluginConfiguration(n),logger:null!==(i=n.logger)&&void 0!==i?i:eo};var a;const s=new Map;async function getPublicApp(e={}){const t=e.enableCae?"CAE":"default";let r=s.get(t);if(r)return o.logger.getToken.info("Existing PublicClientApplication found in cache, returning it."),r;o.logger.getToken.info(`Creating new PublicClientApplication with CAE ${e.enableCae?"enabled":"disabled"}.`);const n=e.enableCae?o.pluginConfiguration.cache.cachePluginCae:o.pluginConfiguration.cache.cachePlugin;return o.msalConfig.auth.clientCapabilities=e.enableCae?["cp1"]:void 0,r=new PublicClientApplication(Object.assign(Object.assign({},o.msalConfig),{broker:{nativeBrokerPlugin:o.pluginConfiguration.broker.nativeBrokerPlugin},cache:{cachePlugin:await n}})),s.set(t,r),r}const c=new Map;async function getConfidentialApp(e={}){const t=e.enableCae?"CAE":"default";let r=c.get(t);if(r)return o.logger.getToken.info("Existing ConfidentialClientApplication found in cache, returning it."),r;o.logger.getToken.info(`Creating new ConfidentialClientApplication with CAE ${e.enableCae?"enabled":"disabled"}.`);const n=e.enableCae?o.pluginConfiguration.cache.cachePluginCae:o.pluginConfiguration.cache.cachePlugin;return o.msalConfig.auth.clientCapabilities=e.enableCae?["cp1"]:void 0,r=new ConfidentialClientApplication(Object.assign(Object.assign({},o.msalConfig),{broker:{nativeBrokerPlugin:o.pluginConfiguration.broker.nativeBrokerPlugin},cache:{cachePlugin:await n}})),c.set(t,r),r}function calculateRequestAuthority(e){return(null==e?void 0:e.tenantId)?getAuthority(e.tenantId,getAuthorityHost(n)):o.msalConfig.auth.authority}async function withSilentAuthentication(e,t,r,n){var i,a;let s=null;try{s=await async function getTokenSilent(e,t,r={}){if(null===o.cachedAccount)throw o.logger.getToken.info("No cached account found in local state."),new AuthenticationRequiredError({scopes:t});r.claims&&(o.cachedClaims=r.claims);const n={account:o.cachedAccount,scopes:t,claims:o.cachedClaims};o.pluginConfiguration.broker.isEnabled&&(n.tokenQueryParameters||(n.tokenQueryParameters={}),o.pluginConfiguration.broker.enableMsaPassthrough&&(n.tokenQueryParameters.msal_request_type="consumer_passthrough")),r.proofOfPossessionOptions&&(n.shrNonce=r.proofOfPossessionOptions.nonce,n.authenticationScheme="pop",n.resourceRequestMethod=r.proofOfPossessionOptions.resourceRequestMethod,n.resourceRequestUri=r.proofOfPossessionOptions.resourceRequestUrl),o.logger.getToken.info("Attempting to acquire token silently");try{return await e.acquireTokenSilent(n)}catch(e){throw handleMsalError(t,e,r)}}(e,t,r)}catch(e){if("AuthenticationRequiredError"!==e.name)throw e;if(r.disableAutomaticAuthentication)throw new AuthenticationRequiredError({scopes:t,getTokenOptions:r,message:"Automatic authentication has been disabled. You may call the authentication() method."})}if(null===s)try{s=await n()}catch(e){throw handleMsalError(t,e,r)}return ensureValidMsalToken(t,s,r),o.cachedAccount=null!==(i=null==s?void 0:s.account)&&void 0!==i?i:null,o.logger.getToken.info(logging_formatSuccess(t)),{token:s.accessToken,expiresOnTimestamp:s.expiresOn.getTime(),refreshAfterTimestamp:null===(a=s.refreshOn)||void 0===a?void 0:a.getTime(),tokenType:s.tokenType}}return{getActiveAccount:function getActiveAccount(){if(o.cachedAccount)return function msalToPublic(e,t){var r;return{authority:null!==(r=t.environment)&&void 0!==r?r:"login.microsoftonline.com",homeAccountId:t.homeAccountId,tenantId:t.tenantId||"common",username:t.username,clientId:e,version:"1.0"}}(e,o.cachedAccount)},getTokenByClientSecret:async function getTokenByClientSecret(e,t,r={}){var n;o.logger.getToken.info("Attempting to acquire token using client secret"),o.msalConfig.auth.clientSecret=t;const i=await getConfidentialApp(r);try{const t=await i.acquireTokenByClientCredential({scopes:e,authority:calculateRequestAuthority(r),azureRegion:calculateRegionalAuthority(),claims:null==r?void 0:r.claims});return ensureValidMsalToken(e,t,r),o.logger.getToken.info(logging_formatSuccess(e)),{token:t.accessToken,expiresOnTimestamp:t.expiresOn.getTime(),refreshAfterTimestamp:null===(n=t.refreshOn)||void 0===n?void 0:n.getTime(),tokenType:t.tokenType}}catch(t){throw handleMsalError(e,t,r)}},getTokenByClientAssertion:async function getTokenByClientAssertion(e,t,r={}){var n;o.logger.getToken.info("Attempting to acquire token using client assertion"),o.msalConfig.auth.clientAssertion=t;const i=await getConfidentialApp(r);try{const a=await i.acquireTokenByClientCredential({scopes:e,authority:calculateRequestAuthority(r),azureRegion:calculateRegionalAuthority(),claims:null==r?void 0:r.claims,clientAssertion:t});return ensureValidMsalToken(e,a,r),o.logger.getToken.info(logging_formatSuccess(e)),{token:a.accessToken,expiresOnTimestamp:a.expiresOn.getTime(),refreshAfterTimestamp:null===(n=a.refreshOn)||void 0===n?void 0:n.getTime(),tokenType:a.tokenType}}catch(t){throw handleMsalError(e,t,r)}},getTokenByClientCertificate:async function getTokenByClientCertificate(e,t,r={}){var n;o.logger.getToken.info("Attempting to acquire token using client certificate"),o.msalConfig.auth.clientCertificate=t;const i=await getConfidentialApp(r);try{const t=await i.acquireTokenByClientCredential({scopes:e,authority:calculateRequestAuthority(r),azureRegion:calculateRegionalAuthority(),claims:null==r?void 0:r.claims});return ensureValidMsalToken(e,t,r),o.logger.getToken.info(logging_formatSuccess(e)),{token:t.accessToken,expiresOnTimestamp:t.expiresOn.getTime(),refreshAfterTimestamp:null===(n=t.refreshOn)||void 0===n?void 0:n.getTime(),tokenType:t.tokenType}}catch(t){throw handleMsalError(e,t,r)}},getTokenByDeviceCode:async function getTokenByDeviceCode(e,t,r={}){o.logger.getToken.info("Attempting to acquire token using device code");const n=await getPublicApp(r);return withSilentAuthentication(n,e,r,(()=>{var i,o;const a={scopes:e,cancel:null!==(o=null===(i=null==r?void 0:r.abortSignal)||void 0===i?void 0:i.aborted)&&void 0!==o&&o,deviceCodeCallback:t,authority:calculateRequestAuthority(r),claims:null==r?void 0:r.claims},s=n.acquireTokenByDeviceCode(a);return r.abortSignal&&r.abortSignal.addEventListener("abort",(()=>{a.cancel=!0})),s}))},getTokenByUsernamePassword:async function getTokenByUsernamePassword(e,t,r,n={}){o.logger.getToken.info("Attempting to acquire token using username and password");const i=await getPublicApp(n);return withSilentAuthentication(i,e,n,(()=>{const o={scopes:e,username:t,password:r,authority:calculateRequestAuthority(n),claims:null==n?void 0:n.claims};return i.acquireTokenByUsernamePassword(o)}))},getTokenByAuthorizationCode:async function getTokenByAuthorizationCode(e,t,r,n,i={}){let a;return o.logger.getToken.info("Attempting to acquire token using authorization code"),n?(o.msalConfig.auth.clientSecret=n,a=await getConfidentialApp(i)):a=await getPublicApp(i),withSilentAuthentication(a,e,i,(()=>a.acquireTokenByCode({scopes:e,redirectUri:t,code:r,authority:calculateRequestAuthority(i),claims:null==i?void 0:i.claims})))},getTokenOnBehalfOf:async function getTokenOnBehalfOf(e,t,r,n={}){var i;eo.getToken.info("Attempting to acquire token on behalf of another user"),"string"==typeof r?(eo.getToken.info("Using client secret for on behalf of flow"),o.msalConfig.auth.clientSecret=r):"function"==typeof r?(eo.getToken.info("Using client assertion callback for on behalf of flow"),o.msalConfig.auth.clientAssertion=r):(eo.getToken.info("Using client certificate for on behalf of flow"),o.msalConfig.auth.clientCertificate=r);const a=await getConfidentialApp(n);try{const r=await a.acquireTokenOnBehalfOf({scopes:e,authority:calculateRequestAuthority(n),claims:n.claims,oboAssertion:t});return ensureValidMsalToken(e,r,n),eo.getToken.info(logging_formatSuccess(e)),{token:r.accessToken,expiresOnTimestamp:r.expiresOn.getTime(),refreshAfterTimestamp:null===(i=r.refreshOn)||void 0===i?void 0:i.getTime(),tokenType:r.tokenType}}catch(t){throw handleMsalError(e,t,n)}},getTokenByInteractiveRequest:async function getTokenByInteractiveRequest(e,t={}){eo.getToken.info("Attempting to acquire token interactively");const n=await getPublicApp(t);async function getBrokeredToken(e){var r;eo.verbose("Authentication will resume through the broker");const i=createBaseInteractiveRequest();o.pluginConfiguration.broker.parentWindowHandle?i.windowHandle=Buffer.from(o.pluginConfiguration.broker.parentWindowHandle):eo.warning("Parent window handle is not specified for the broker. This may cause unexpected behavior. Please provide the parentWindowHandle."),o.pluginConfiguration.broker.enableMsaPassthrough&&((null!==(r=i.tokenQueryParameters)&&void 0!==r?r:i.tokenQueryParameters={}).msal_request_type="consumer_passthrough"),e?(i.prompt="none",eo.verbose("Attempting broker authentication using the default broker account")):eo.verbose("Attempting broker authentication without the default broker account"),t.proofOfPossessionOptions&&(i.shrNonce=t.proofOfPossessionOptions.nonce,i.authenticationScheme="pop",i.resourceRequestMethod=t.proofOfPossessionOptions.resourceRequestMethod,i.resourceRequestUri=t.proofOfPossessionOptions.resourceRequestUrl);try{return await n.acquireTokenInteractive(i)}catch(t){if(eo.verbose(`Failed to authenticate through the broker: ${t.message}`),e)return getBrokeredToken(!1);throw t}}function createBaseInteractiveRequest(){var n,i;return{openBrowser:async e=>{const t=await r.e(401).then(r.bind(r,1401));await t.default(e,{wait:!0,newInstance:!0})},scopes:e,authority:calculateRequestAuthority(t),claims:null==t?void 0:t.claims,loginHint:null==t?void 0:t.loginHint,errorTemplate:null===(n=null==t?void 0:t.browserCustomizationOptions)||void 0===n?void 0:n.errorMessage,successTemplate:null===(i=null==t?void 0:t.browserCustomizationOptions)||void 0===i?void 0:i.successMessage,prompt:(null==t?void 0:t.loginHint)?"login":"select_account"}}return withSilentAuthentication(n,e,t,(async()=>{var e;const r=createBaseInteractiveRequest();return o.pluginConfiguration.broker.isEnabled?getBrokeredToken(null!==(e=o.pluginConfiguration.broker.useDefaultBrokerAccount)&&void 0!==e&&e):(t.proofOfPossessionOptions&&(r.shrNonce=t.proofOfPossessionOptions.nonce,r.authenticationScheme="pop",r.resourceRequestMethod=t.proofOfPossessionOptions.resourceRequestMethod,r.resourceRequestUri=t.proofOfPossessionOptions.resourceRequestUrl),n.acquireTokenInteractive(r))}))}}}const to=credentialLogger("ClientAssertionCredential");class clientAssertionCredential_ClientAssertionCredential{constructor(e,t,r,n={}){if(!e)throw new errors_CredentialUnavailableError("ClientAssertionCredential: tenantId is a required parameter.");if(!t)throw new errors_CredentialUnavailableError("ClientAssertionCredential: clientId is a required parameter.");if(!r)throw new errors_CredentialUnavailableError("ClientAssertionCredential: clientAssertion is a required parameter.");this.tenantId=e,this.additionallyAllowedTenantIds=tenantIdUtils_resolveAdditionallyAllowedTenantIds(null==n?void 0:n.additionallyAllowedTenants),this.options=n,this.getAssertion=r,this.msalClient=msalClient_createMsalClient(t,e,Object.assign(Object.assign({},n),{logger:to,tokenCredentialOptions:this.options}))}async getToken(e,t={}){return y.withSpan(`${this.constructor.name}.getToken`,t,(async t=>{t.tenantId=processMultiTenantRequest_processMultiTenantRequest(this.tenantId,t,this.additionallyAllowedTenantIds,to);const r=Array.isArray(e)?e:[e];return this.msalClient.getTokenByClientAssertion(r,this.getAssertion,t)}))}}r(51455);const ro="WorkloadIdentityCredential";credentialLogger(ro);const no="ManagedIdentityCredential - Token Exchange";credentialLogger(no),credentialLogger("ManagedIdentityCredential");r(35317);credentialLogger("AzureCliCredential");credentialLogger("AzureDeveloperCliCredential");credentialLogger("AzurePowerShellCredential");const io="win32"===process.platform;function formatCommand(e){return io?`${e}.exe`:e}const oo=[formatCommand("pwsh")];io&&oo.push(formatCommand("powershell"));credentialLogger("ChainedTokenCredential");r(77598);const ao="ClientCertificateCredential";credentialLogger(ao);credentialLogger("ClientSecretCredential");credentialLogger("UsernamePasswordCredential");const so="EnvironmentCredential";credentialLogger(so);credentialLogger("DefaultAzureCredential");credentialLogger("InteractiveBrowserCredential");credentialLogger("DeviceCodeCredential");const co="AzurePipelinesCredential";credentialLogger(co);credentialLogger("AuthorizationCodeCredential");const lo="OnBehalfOfCredential";credentialLogger(lo)},87914:e=>{var t=Object.prototype.toString;e.exports=function isBoolean(e){return!0===e||!1===e||function isObjectLike(e){return!!e&&"object"==typeof e}(e)&&"[object Boolean]"==t.call(e)}},91691:(e,t,r)=>{const n=r(81741),i=r(13726),o=r(18980),a=r(37260),s=r(40855),c=r(47019),l=r(74977),u=r(50652),{KeyObject:d,createSecretKey:h,createPublicKey:g}=r(76982),p=["RS256","RS384","RS512"],f=["ES256","ES384","ES512"],m=["RS256","RS384","RS512"],y=["HS256","HS384","HS512"];l&&(p.splice(p.length,0,"PS256","PS384","PS512"),m.splice(m.length,0,"PS256","PS384","PS512")),e.exports=function(e,t,r,l){let C;if("function"!=typeof r||l||(l=r,r={}),r||(r={}),r=Object.assign({},r),C=l||function(e,t){if(e)throw e;return t},r.clockTimestamp&&"number"!=typeof r.clockTimestamp)return C(new n("clockTimestamp must be a number"));if(void 0!==r.nonce&&("string"!=typeof r.nonce||""===r.nonce.trim()))return C(new n("nonce must be a non-empty string"));if(void 0!==r.allowInvalidAsymmetricKeyTypes&&"boolean"!=typeof r.allowInvalidAsymmetricKeyTypes)return C(new n("allowInvalidAsymmetricKeyTypes must be a boolean"));const A=r.clockTimestamp||Math.floor(Date.now()/1e3);if(!e)return C(new n("jwt must be provided"));if("string"!=typeof e)return C(new n("jwt must be a string"));const T=e.split(".");if(3!==T.length)return C(new n("jwt malformed"));let I;try{I=a(e,{complete:!0})}catch(e){return C(e)}if(!I)return C(new n("invalid token"));const S=I.header;let v;if("function"==typeof t){if(!l)return C(new n("verify must be called asynchronous if secret or public key is provided as a callback"));v=t}else v=function(e,r){return r(null,t)};return v(S,(function(t,a){if(t)return C(new n("error in secret or public key callback: "+t.message));const l=""!==T[2].trim();if(!l&&a)return C(new n("jwt signature is required"));if(l&&!a)return C(new n("secret or public key must be provided"));if(!l&&!r.algorithms)return C(new n('please specify "none" in "algorithms" to verify unsigned tokens'));if(null!=a&&!(a instanceof d))try{a=g(a)}catch(e){try{a=h("string"==typeof a?Buffer.from(a):a)}catch(e){return C(new n("secretOrPublicKey is not valid key material"))}}if(r.algorithms||("secret"===a.type?r.algorithms=y:["rsa","rsa-pss"].includes(a.asymmetricKeyType)?r.algorithms=m:"ec"===a.asymmetricKeyType?r.algorithms=f:r.algorithms=p),-1===r.algorithms.indexOf(I.header.alg))return C(new n("invalid algorithm"));if(S.alg.startsWith("HS")&&"secret"!==a.type)return C(new n(`secretOrPublicKey must be a symmetric key when using ${S.alg}`));if(/^(?:RS|PS|ES)/.test(S.alg)&&"public"!==a.type)return C(new n(`secretOrPublicKey must be an asymmetric key when using ${S.alg}`));if(!r.allowInvalidAsymmetricKeyTypes)try{c(S.alg,a)}catch(e){return C(e)}let v;try{v=u.verify(e,I.header.alg,a)}catch(e){return C(e)}if(!v)return C(new n("invalid signature"));const w=I.payload;if(void 0!==w.nbf&&!r.ignoreNotBefore){if("number"!=typeof w.nbf)return C(new n("invalid nbf value"));if(w.nbf>A+(r.clockTolerance||0))return C(new i("jwt not active",new Date(1e3*w.nbf)))}if(void 0!==w.exp&&!r.ignoreExpiration){if("number"!=typeof w.exp)return C(new n("invalid exp value"));if(A>=w.exp+(r.clockTolerance||0))return C(new o("jwt expired",new Date(1e3*w.exp)))}if(r.audience){const e=Array.isArray(r.audience)?r.audience:[r.audience];if(!(Array.isArray(w.aud)?w.aud:[w.aud]).some((function(t){return e.some((function(e){return e instanceof RegExp?e.test(t):e===t}))})))return C(new n("jwt audience invalid. expected: "+e.join(" or ")))}if(r.issuer){if("string"==typeof r.issuer&&w.iss!==r.issuer||Array.isArray(r.issuer)&&-1===r.issuer.indexOf(w.iss))return C(new n("jwt issuer invalid. expected: "+r.issuer))}if(r.subject&&w.sub!==r.subject)return C(new n("jwt subject invalid. expected: "+r.subject));if(r.jwtid&&w.jti!==r.jwtid)return C(new n("jwt jwtid invalid. expected: "+r.jwtid));if(r.nonce&&w.nonce!==r.nonce)return C(new n("jwt nonce invalid. expected: "+r.nonce));if(r.maxAge){if("number"!=typeof w.iat)return C(new n("iat required when maxAge is specified"));const e=s(r.maxAge,w.iat);if(void 0===e)return C(new n('"maxAge" should be a number of seconds or string representing a timespan eg: "1d", "20h", 60'));if(A>=e+(r.clockTolerance||0))return C(new o("maxAge exceeded",new Date(1e3*e)))}if(!0===r.complete){const e=I.signature;return C(null,{header:S,payload:w,signature:e})}return C(null,w)}))}}};